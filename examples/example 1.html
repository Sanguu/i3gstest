<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive 3DGS</title>
  <style type="text/css">
  html, body {
    margin: 0;
    height: 100%;
    background-image: linear-gradient(white, lightgrey);
    overflow: hidden; 
  }


  #title{
    position:absolute;
    width:100%;
    margin: auto;
    margin-top:40px;
    margin-left:77px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:1em;
    text-transform: uppercase;
    text-align : left;
    user-select: none;
  }

  #title2{
    position:absolute;
    width:100%;
    margin: auto;
    margin-top:40px;
    margin-left:340px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.5em;
    text-transform: uppercase;
    text-align : left;
    user-select: none;
  }

  #subtitle{
    position:absolute;
    width:100%;
    margin: auto;
    margin-top:55px;
    margin-left:77px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.7em;
    text-transform: uppercase;
    text-align : left;
    user-select: none;
  }

  #subtitle2{
    position:absolute;
    width:100%;
    margin: auto;
    margin-top:38px;
    margin-left:1000px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.7em;
    text-transform: uppercase;
    text-align : left;
    user-select: none;
  }

  #Form{
    position:absolute;
    top:75%;
    margin-left:25%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.9em;
    font-weight: bold;
    }
             
  #Force{
    position:absolute;
    top:75%;
    margin-left:75%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.9em;
    font-weight: bold;
    }

  /* #Steps{
    position:absolute;

    top:50%;
    margin-top:275px;
    margin-left:750px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.8em;
    text-transform: uppercase;
  } */



  /* #Minkowski{
    position:absolute;

    top:50%;
    margin-top:275px;
    margin-left:520px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.8em;
    text-transform: uppercase;
  } */

  #scale{
    position:absolute;

    top:50%;
    margin-top:300px;
    margin-left:520px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Formdia{
    position:absolute;

    top:50%;
    margin-top:245px;
    margin-left:295px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.9em;
    text-transform: uppercase;
  }

  /* #Form{
    position:absolute;

    top:50%;
    margin-top:275px;
    margin-left:360px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.8em;
    text-transform: uppercase;
  } */

  #faces{
    position:absolute;

    top:50%;
    margin-top:300px;
    margin-left:360px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #cells{
    position:absolute;

    top:50%;
    margin-top:320px;
    margin-left:360px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #bars{
    position:absolute;
    top:50%;
    margin-top:338px;
    margin-left:360px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Forcedia{
    position:absolute;

    top:50%;
    margin-top:245px;
    margin-left:880px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.9em;
    text-transform: uppercase;
  }

  /* #Force{
    position:absolute;

    top:50%;
    margin-top:275px;
    margin-left:880px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.8em;
    text-transform: uppercase;
  } */
  #forcefaces{
    position:absolute;

    top:50%;
    margin-top:300px;
    margin-left:880px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }
  #forcearrows{
    position:absolute;

    top:50%;
    margin-top:320px;
    margin-left:880px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #forceedges{
    position:absolute;

    top:50%;
    margin-top:340px;
    margin-left:880px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #gface{
    position:absolute;
    top:80%;
    margin-left:17%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.7em;
  }

  #mink{
    position:absolute;
    top:80%;
    margin-left:25%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.7em;
  }

  #fcell{
    position:absolute;
    top:82%;
    margin-left:17%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.7em;
  }

  #nstep{
    position:absolute;
    top:80%;
    margin-left:75%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.7em;
  }
  #arrd{
    position:absolute;
    top:80%;
    margin-left:67%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.7em;
  }
  #ned{
    position:absolute;
    top:82%;
    margin-left:67%;
    font-family:'Palatino';
    color:"darkgrey";
    font-size:.7em;
  }
  /* #TopologicalR{
    position:absolute;

    top:50%;
    margin-top:245px;
    margin-left:575px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.9em;
    text-transform: uppercase;
  }

  #Topology{
    position:absolute;

    top:50%;
    margin-top:275px;
    margin-left:700px;
    font-family:'Open Sans', sans-serif;
    color:"darkgrey";
    font-size:.8em;
    text-transform: uppercase;
  }
  #Topologya{
    position:absolute;

    top:50%;
    margin-top:300px;
    margin-left:700px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologyab{
    position:absolute;

    top:50%;
    margin-top:300px;
    margin-left:750px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologyad{
    position:absolute;

    top:50%;
    margin-top:300px;
    margin-left:800px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }



  #Topologyb{
    position:absolute;

    top:50%;
    margin-top:320px;
    margin-left:700px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologybc{
    position:absolute;

    top:50%;
    margin-top:320px;
    margin-left:750px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologybd{
    position:absolute;

    top:50%;
    margin-top:320px;
    margin-left:800px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologyc{
    position:absolute;

    top:50%;
    margin-top:340px;
    margin-left:700px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologyac{
    position:absolute;

    top:50%;
    margin-top:340px;
    margin-left:750px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologycd{
    position:absolute;

    top:50%;
    margin-top:340px;
    margin-left:800px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  }

  #Topologyd{
    position:absolute;

    top:50%;
    margin-top:360px;
    margin-left:700px;
    font-family:'Open Sans', sans-serif;
    color:"lightgrey";
    font-size:.5em;
    text-transform: uppercase;
    user-select: none;
  } */

  canvas {
    display: block;
  }

  </style>
</head>
<body onload="draw();">

  <!-- <div id="title">3D Graphic Statics Webtool</div>
  <div id="title2">Demo 3.0</div>
  <div id="subtitle">Polyhedral Structures Laboratory</div> -->

  <div id="Form">form</div>
  <div id="Force">force</div>
  <div id="gface">Faces</div>
  <div id="fcell">Cells</div>
  <div id="mink">Minkowski</div>

  <div id="nstep">Steps</div>
  <div id="arrd">Arrow.D</div>
  <div id="ned">Edges</div>

  <a href="../layouts/Exmaples.html"><img src="../images/logo.png"  style="width: 75px;
    position:absolute;
    top:6%;
    margin-left:10%;
    height: 23px;
    "></a>

  <div id="Minkowskiscale"></div>
  <!-- <div id="Barthickness"></div> -->
  <div id="Stepstest"></div>
  <!-- <div id="Stepstest2"></div> -->
<!-- 
  <div id="ch1">
    <input id="ch2" name="chkItem" type="checkbox">
  </div> -->

  <div id="checkscale">
    <input id="ch3" name="chkItem" type="checkbox">
  </div>

  <div id="checkfaces">
    <input id="ch4" name="chkItem" type="checkbox">
  </div>

  <div id="checkcells">
    <input id="ch5" name="chkItem" type="checkbox">
  </div>

  <div id="arrows">
    <input id="ch6" name="chkItem" type="checkbox">
  </div>

  <div id="edges">
    <input id="ch7" name="chkItem" type="checkbox">
  </div>


<!--
  <div id="st1">
    <input id="ch18" name="chkItem" type="checkbox">
  </div>

  <div id="st2">
    <input id="ch19" name="chkItem" type="checkbox">
  </div>

  <div id="st3">
    <input id="ch20" name="chkItem" type="checkbox">
  </div>

  <div id="st4">
    <input id="ch21" name="chkItem" type="checkbox">
  </div>

  <div id="st5">
    <input id="ch22" name="chkItem" type="checkbox">
  </div>

  <div id="st6">
    <input id="ch23" name="chkItem" type="checkbox">
  </div>

  <div id="st7">
    <input id="ch24" name="chkItem" type="checkbox">
  </div> -->

  <div id="step">
    <input id="ch18" name="chkItem" type="checkbox">
  </div>


  <!-- <div id="Steps">Steps</div> -->



  <!-- <div id="Minkowski">MINKOWSKI SUM</div> -->
  <!-- <div id="scale">Scale</div> -->


  <!-- <div id="Form">Form</div>
  <div id="faces">faces</div>
  <div id="cells">cells</div>
  <div id="bars">bars</div> -->


  <!-- <div id="Force">Force</div>
  <div id="forcefaces">faces</div>
  <div id="forcearrows">arrows</div>
  <div id="forceedges">edges</div> -->

<!--
  <div id="Topology">topology</div>
  <div id="Topologya">a</div>
  <div id="Topologyb">b</div>
  <div id="Topologyc">c</div>
  <div id="Topologyd">d</div>

  <div id="Topologyab">ab</div>
  <div id="Topologybc">bc</div>
  <div id="Topologyac">ac</div>

  <div id="Topologyad">ad</div>
  <div id="Topologybd">bd</div>
  <div id="Topologycd">cd</div> -->


  <!-- <hr style="width: 105px;
  position:absolute;
  top:50%;
  margin-top:290px;
  margin-left:1220px;
  height: 1px;
  background-color:#666;"> -->

<!--
  <hr style="width: 150px;
  position:absolute;
  top:50%;
  margin-top:290px;
  margin-left:300px;
  height: 1px;
  background-color:#666;">

  <hr style="width: 160px;
  position:absolute;
  top:50%;
  margin-top:290px;
  margin-left:520px;
  height: 1px;
  background-color:#666;">

  <hr style="width: 120px;
  position:absolute;
  top:50%;
  margin-top:290px;
  margin-left:750px;
  height: 1px;
  background-color:#666;">


  <hr style="width: 240px;
  position:absolute;
  top:50%;
  margin-top:290px;
  margin-left:940px;
  height: 1px;
  background-color:#666;"> -->


<!-- 

  <img src="models/psl logo2-01.png"  style="width: 145px;
  position:absolute;
  top:50%;
  margin-top:400px;
  margin-left:300px;
  height: 50px;
  ">

  <img src="models/design school logo copy.png"  style="width: 145px;
  position:absolute;
  top:50%;
  margin-top:400px;
  margin-left:1040px;
  height: 50px;
  ">

  <img src="models/Form-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:245px;
  margin-left:290px;
  height: 50px;
  ">

  <img src="models/Form_f-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:190px;
  height: 50px;
  ">

  <img src="models/Form_c-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:390px;
  height: 50px;
  ">

  <img src="models/Form_e-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:290px;
  height: 50px;
  ">

  <img src="models/Force-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:245px;
  margin-left:1020px;
  height: 50px;
  ">

  <img src="models/Force_f-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:940px;
  height: 50px;
  ">

  <img src="models/Force_a-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:1020px;
  height: 50px;
  ">

  <img src="models/Force_v-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:1100px;
  height: 50px;
  ">

  <img src="models/Minko-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:500px;
  height: 50px;
  ">

  <img src="models/steps-01.png"  style="width: 50px;
  position:absolute;
  top:50%;
  margin-top:300px;
  margin-left:700px;
  height: 50px;
  "> -->




</body>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r124/three.js"></script>
<script type="text/javascript" src="../libs/three/utils/SceneUtils.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.101.1/examples/js/controls/TransformControls.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.101.1/examples/js/controls/OrbitControls.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.js"></script>
<script src="https://threejs.org/examples/js/curves/NURBSCurve.js"></script>
<script src="https://threejs.org/examples/js/curves/NURBSUtils.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/7/Stats.js"></script>

<style>
/* #ch1{
  position: absolute;
  float: left;
  clear: left;
  top: 50%;
  width: 200px;
  height: 5px;

  margin-left: 995px;
  margin-top: 315px;

} */

#checkscale{
  position: absolute;
    float: left;
    clear: left;
    top: 79.7%;
    margin-left: 30.2%;

}

#checkfaces{
  position: absolute;
    float: left;
    clear: left;
    top: 79.7%;
    margin-left: 21.2%;
}

#checkcells{
  position: absolute;
    float: left;
    clear: left;
    top: 81.7%;
    margin-left: 21.2%;

}

#arrows{
  position: absolute;
    float: left;
    clear: left;
    top: 79.7%;
    margin-left: 71.2%;
}

#edges{
  position: absolute;
    float: left;
    clear: left;
    top: 81.7%;
    margin-left: 71.2%;

}

#step{
  position: absolute;
    float: left;
    clear: left;
    top: 79.7%;
    margin-left: 78.2%;

}



#Minkowskiscale{
  position: absolute;
    top: 80.2%;
    width: 5%;
    height: 5px;
    margin-left: 33.5%;

}

/* #Barthickness{
  position: absolute;
  float: left;
  clear: left;
  top: 50%;

  width: 50px;
  height: 5px;

  margin-left: 420px;
  margin-top: 340px;

} */


#Stepstest{
  position: absolute;
    top: 80.2%;
    width: 5%;
    height: 5px;
    margin-left: 81.5%;


}
/*
#Stepstest2{
  position: absolute;
  float: left;
  clear: left;
  top: 50%;

  width: 99px;
  height: 5px;

  margin-left: 765px;
  margin-top: 320px;

} */

  #Minkowskiscale .ui-slider-range { background: #383838; }
  #Minkowskiscale .ui-slider-handle { border-color: #666666;
    border-color: #666666;
    height:10px;
    width:10px;

    border-radius: 10px;
    border-width: 3px; }

  /* #Barthickness .ui-slider-range { background: #383838; }
  #Barthickness .ui-slider-handle { border-color: #666666;
    border-color: #666666;
    height:10px;
    width:10px;

    border-radius: 10px;
    border-width: 3px; } */

    #Stepstest .ui-slider-range { background: #383838; }
    #Stepstest .ui-slider-handle { border-color: #666666;
      border-color: #666666;
      height:10px;
      width:10px;

      border-radius: 10px;
      border-width: 3px; }

      /* #Stepstest2 .ui-slider-range { background: #383838; }
      #Stepstest2 .ui-slider-handle { border-color: #666666;
        border-color: #666666;
        height:10px;
        width:10px;

        border-radius: 10px;
        border-width: 3px; }
 */





    </style>


    <script>
    var renderer;
    var orbit_ctrl;
    //var camera;
    var Ctrl_pts=[];
    var Ctrl_tubes=[];
    var trfm_ctrl;
    var lattice_line_material = new THREE.MeshPhongMaterial( {
      color: "green"
    } );
    var lattice_line_material4 = new THREE.MeshBasicMaterial( {
      color: "grey"
    } );

    var lattice_line_material1 = new THREE.MeshPhongMaterial( {
      color: 0x3b3b3b
    } );
    var lattice_line_material2 = new THREE.MeshPhongMaterial( {
      color: 0x3b3b3b
    } );
    var lattice_line_material3 = new THREE.MeshPhongMaterial( {
      color: 0x3b3b3b
    } );

    var arrow_material=new THREE.MeshPhongMaterial( {
      color: 0x000080
    } );

    var rayCaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();

    var f1;

    var control_right;

    var controls_scale = new function () {
      this.scale = 0;
      this.MaxScale=3;

      this.Force_face=true;
      this.Arrow_face=false;
      this.Force_Arrow=true;
      this.Scale_face=false;

      this.Control_Face=false;
      this.ForceFace_left=false;

      this.Cell_Faces=false;

      this.A=false;
      this.B=false;
      this.C=false;
      this.D=false;

      this.AB=false;
      this.AC=false;
      this.AD=false;
      this.BC=false;
      this.BD=false;
      this.CD=false;

      this.Pair_Control=false;
      this.Step1=false;
      this.Step2=false;
      this.Step3=false;
      this.Step4=false;
      this.Step5=false;
      this.Step6=false;
      this.Step7=false;
      this.Stepcell=false;
    };

    var tubethick = new function () {
      this.v = 0.05;
    }


    function initRender() {
      renderer = new THREE.WebGLRenderer({alpha: true});
      //renderer.setClearColor(new THREE.Color(0xf5f5f5)); 
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMapEnabled = true;
      renderer.shadowMaptype = THREE.PCFSoftShadowMap;
      renderer.localClippingEnabled = true;
      //renderer.shadowMapType=THREE.PCFSoftShadowMap;
      document.body.appendChild(renderer.domElement);


    }

    var camera;

    function initCamera() {
      camera = new THREE.PerspectiveCamera(45, window.innerWidth/(window.innerHeight*2), 0.1, 200);
      camera.position.set(10, 0, 0);

      camera.up.x = 0;
      camera.up.y = 0;
      camera.up.z = 1;

      camera.lookAt({
        x : 0,
        y : 0,
        z : 0
      });



    }

    var scene,scene2;

    function initScene() {
      scene = new THREE.Scene();

      scene2 = new THREE.Scene();
    }

    var light;

    function initLight() {
      scene.add(new THREE.AmbientLight(0x404040));

      light = new THREE.DirectionalLight(0xffffff);
      light.position.set(1, 1, 1);
      scene.add(light);

    }




    var Tube_group;
    var Tube_group_right;
    var Face_group_left;
    var wrapper;
    var step_group_1
    var step_group_2
    var step_group_1_1
    var step_group_cell
    var Tube_group_force

    var face_arrow1;
    var face_arrow2;
    var face_arrow3;
    var face_arrow4;

    var mesh_left;
    var mesh_left_pair;
    var mesh_left_ForceFace;
    var corePoint_body;

    var Change_N3N4=false;

    //var



    function addControl(x, y, z) {
      var controls = new function () {
        this.x = x;
        this.y = y;
        this.z = z;
      };

      return controls;
    }





    $( "#Minkowskiscale, #Maxscale" ).slider({
      orientation: "horizontal",

      range: "min",
      max: 3,
      min:0,
      step:0.01,
      round:1


    });


    $( "#Barthickness" ).slider({
      orientation: "horizontal",

      range: "min",
      max: 0.1,
      min:0.01,
      step:0.01,
      round:1


    });

    $( "#Stepstest" ).slider({
      orientation: "horizontal",

      range: "min",
      max: 7,
      min:1,
      step:1,
      round:1


    });

    $( "#Stepstest2" ).slider({
      orientation: "horizontal",

      range: "min",
      max: 7,
      min:0,
      step:1,
      round:1


    });



    $( "#Minkowskiscale" ).slider( "value", 0 );
    $( "#Barthickness" ).slider( "value", 0.01 );

    $( "#Steptest" ).slider("value", $( "#Steptest" ).slider("value"));
    $("#Steptest").slider("refresh");

    // $( "#Steptest2" ).slider("value", $( "#Steptest2" ).slider("value"));
    // $("#Steptest2").slider("refresh");
    //






    $( "#Minkowskiscale" ).slider({
      slide:function(event,ui){
        controls_scale.scale = ui.value;
        redraw_Force();
      },
      change:function(event,ui){
        controls_scale.scale = ui.value;
        redraw_Force();
      }
    });

    $( "#Barthickness" ).slider({
      slide:function(event,ui){
        tubethick.v = ui.value;
        redraw();
      },
      change:function(event,ui){
        tubethick.v = ui.value;
        redraw();
      }
    });

    // $( "#Stepstest2" ).slider({
    //   slide:function(event,ui){
    //     tubethick.v = ui.value;
    //     redraw();
    //   },
    //   change:function(event,ui){
    //     tubethick.v = ui.value;
    //     redraw();
    //   }
    // });

    function resetSlider(){
      $("#Stepstest").attr('value',7);
      $("input[type='range']").slider( "refresh" );//refresh slider to max value
      $(".ui-slider-handle").css("left","0%");
      $(".ui-slider-range").css("left","0%");
      console.log("Slider Reset Done.");
  }

    $( "#Stepstest" ).slider({
      slide:function(event,ui){
      var valstep = ui.value;
       showStep(valstep);
      },
      change:function(event,ui){
      	var valstep =ui.value;
         showStep(valstep);
      }
  });




      function showStep(valStep)
      {

      	var val=valStep;


        if(val == 1)
        {

          controls_scale.ForceFace_left= true;
          redraw_Faces6();
          controls_scale.Step1=ui.value;

          mesh_left_ForceFace.children[0].material.visible=true;
          mesh_left_ForceFace.children[1].material.visible=true;


          redraw();
          redraw_Faces6();

          for(i=0;i<=1;i++){
            mesh.children[i].material.visible=false;
          };
          mesh_left_ForceFace.children[0].material.visible=false;
          mesh_left_ForceFace.children[1].material.visible=false;

          mesh_TriFace1.children[0].material.visible=false;
          mesh_TriFace2.children[0].material.visible=false;
          mesh_TriFace3.children[0].material.visible=false;
          mesh_TriFace4.children[0].material.visible=false;

          mesh_TriFace_step_f1.children[0].material.visible=false;
          mesh_TriFace_step_f1.children[6].material.visible=false;

          mesh_TriFace_step_f2.children[0].material.visible=false;
          mesh_TriFace_step_f2.children[6].material.visible=false;

          mesh_TriFace_step_f21.children[0].material.visible=false;
          mesh_TriFace_step_f21.children[6].material.visible=false;

          mesh_TriFace_step_f3.children[0].material.visible=false;
          mesh_TriFace_step_f3.children[6].material.visible=false;

          mesh_TriFace_step_f4.children[0].material.visible=false;
          mesh_TriFace_step_f4.children[6].material.visible=false;

          mesh_TriFace2_stepar.children[0].material.visible=false;
          mesh_TriFace2_stepar.children[6].material.visible=false;

          text_group2.children[0].material.visible=false;
          text_group2.children[1].material.visible=false;
          text_group2.children[2].material.visible=false;
          text_group2.children[3].material.visible=false;
          text_group2.children[4].material.visible=false;
          text_group2.children[5].material.visible=false;
          text_group2.children[6].material.visible=false;
          text_group2.children[7].material.visible=false;
          text_group2.children[8].material.visible=false;

          for(i=1;i<=3;i++){
            mesh_TriFace1.children[i].visible=false;
            mesh_TriFace2.children[i].visible=false;
            mesh_TriFace2_stepar.children[i].visible=false;
            mesh_TriFace3.children[i].visible=false;
            mesh_TriFace4.children[i].visible=false;
          }

          for(i=0;i<=1;i++){
            mesh.children[i].material.visible=false;
          }
          for(i=0;i<=4;i++){
            text_group1.children[1].material.visible=false;
            text_group1.children[2].material.visible=false;
            text_group1.children[3].material.visible=false;

          }

            text_group2.children[0].material.visible=false;
            text_group2.children[1].material.visible=false;
            text_group2.children[2].material.visible=false;
            text_group2.children[3].material.visible=false;




          Tube_group.children[15].material.visible=false;
          Tube_group.children[21].material.visible=false;
          Tube_group.children[25].material.visible=false;
          Tube_group.children[10].material.visible=false;




          mesh_TriFace1.children[4].visible=false;
          mesh_TriFace2.children[4].visible=false;
          mesh_TriFace3.children[4].visible=false;
          mesh_TriFace4.children[4].visible=false;
          mesh_TriFace2_stepar.children[4].visible=false;
          // controls_scale.Force_Arrow=false;


          for(i=1;i<=3;i++){
            mesh_TriFace1.children[i].visible=false;
            mesh_TriFace2.children[i].visible=false;
            mesh_TriFace3.children[i].visible=false;
            mesh_TriFace4.children[i].visible=false;
          }

          for(i=0;i<=9;i++){
            step_group_1_1.children[i].visible=false;
          }

          for(i=0;i<=12;i++){
            step_group_2.children[i].visible=false;
          }

          for(i=0;i<=13;i++){
            step_group_1.children[i].visible=false;
          }

          redraw_Faces6();

          mesh_left_ForceFace.children[0].material.visible=true;
          mesh_left_ForceFace.children[1].material.visible=true;


          Tube_group_right.traverse(function(obj) {
            if (obj.type === "Mesh") {
              obj.material.visible =false;
            }
          });



                mesh_TriFace1.children[5].visible=false;
                mesh_TriFace2.children[5].visible=false;
                mesh_TriFace3.children[5].visible=false;
                mesh_TriFace4.children[5].visible=false;

                mesh_TriFace1.children[6].visible=false;
                mesh_TriFace2.children[6].visible=false;
                mesh_TriFace3.children[6].visible=false;
                mesh_TriFace4.children[6].visible=false;





   

                Tube_group_right.traverse(function(obj) {
                  if (obj.type === "Mesh") {
                    obj.material.visible =false;
                  }
                });



      }
      else  if(val == 2)
        {

                  mesh_TriFace1.children[4].visible=false;
                  mesh_TriFace2.children[4].visible=false;
                  mesh_TriFace3.children[4].visible=false;
                  mesh_TriFace4.children[4].visible=false;
                  // controls_scale.Force_Arrow=false;



                  mesh_TriFace1.children[5].visible=false;
                  mesh_TriFace2.children[5].visible=false;
                  mesh_TriFace3.children[5].visible=false;
                  mesh_TriFace4.children[5].visible=false;

                  mesh_TriFace1.children[6].visible=false;
                  mesh_TriFace2.children[6].visible=false;
                  mesh_TriFace3.children[6].visible=false;
                  mesh_TriFace4.children[6].visible=false;

                  mesh_TriFace_step_f1.children[0].material.visible=false;
                  mesh_TriFace_step_f1.children[6].material.visible=false;

                  mesh_TriFace_step_f2.children[0].material.visible=false;
                  mesh_TriFace_step_f2.children[6].material.visible=false;

                  mesh_TriFace_step_f21.children[0].material.visible=false;
                  mesh_TriFace_step_f21.children[6].material.visible=false;

                  mesh_TriFace_step_f3.children[0].material.visible=false;
                  mesh_TriFace_step_f3.children[6].material.visible=false;

                  mesh_TriFace_step_f4.children[0].material.visible=false;
                  mesh_TriFace_step_f4.children[6].material.visible=false;

                  mesh_TriFace2_stepar.children[0].material.visible=false;
                  mesh_TriFace2_stepar.children[6].material.visible=false;

                  text_group2.children[0].material.visible=false;
                  text_group2.children[1].material.visible=false;
                  text_group2.children[2].material.visible=false;
                  text_group2.children[3].material.visible=false;
                  text_group2.children[4].material.visible=false;
                  text_group2.children[5].material.visible=false;
                  text_group2.children[6].material.visible=false;
                  text_group2.children[7].material.visible=false;
                  text_group2.children[8].material.visible=false;




                  step_group_cell.children[0].visible=true;


                  Tube_group_right.traverse(function(obj) {
                    if (obj.type === "Mesh") {
                      obj.material.visible =false;
                    }
                  });



                  redraw_Force();

                  controls_scale.Step2=true;
                  controls_scale.ForceFace_left=true;

                  redraw_Faces6();

                  for(i=0;i<=1;i++){
                    mesh.children[i].material.visible=false;
                  };
                  mesh_left_ForceFace.children[0].material.visible=false;
                  mesh_left_ForceFace.children[1].material.visible=false;

                  mesh_TriFace1.children[0].material.visible=false;
                  mesh_TriFace2.children[0].material.visible=false;
                  mesh_TriFace3.children[0].material.visible=false;
                  mesh_TriFace4.children[0].material.visible=false;

                  for(i=1;i<=3;i++){
                    mesh_TriFace1.children[i].visible=false;
                    mesh_TriFace2.children[i].visible=false;
                    mesh_TriFace3.children[i].visible=false;
                    mesh_TriFace4.children[i].visible=false;
                    mesh_TriFace2_stepar.children[i].visible=false;
                  }

                  for(i=0;i<=1;i++){
                    mesh.children[i].material.visible=false;
                  }
                  for(i=0;i<=4;i++){
                    text_group1.children[1].material.visible=false;
                    text_group1.children[2].material.visible=false;
                    text_group1.children[3].material.visible=false;

                  }

                  text_group2.children[0].material.visible=false;
                  text_group2.children[1].material.visible=false;
                  text_group2.children[2].material.visible=false;
                  text_group2.children[3].material.visible=false;

                  Tube_group.children[15].material.visible=false;
                  Tube_group.children[21].material.visible=false;
                  Tube_group.children[25].material.visible=false;
                  Tube_group.children[10].material.visible=false;




                  mesh_TriFace1.children[4].visible=false;
                  mesh_TriFace2.children[4].visible=false;
                  mesh_TriFace3.children[4].visible=false;
                  mesh_TriFace4.children[4].visible=false;
                    mesh_TriFace2_stepar.children[4].visible=false;
                  // controls_scale.Force_Arrow=false;



                  for(i=1;i<=3;i++){
                    mesh_TriFace1.children[i].visible=false;
                    mesh_TriFace2.children[i].visible=false;
                    mesh_TriFace3.children[i].visible=false;
                    mesh_TriFace4.children[i].visible=false;
                  }

                  for(i=0;i<=14;i++){
                    step_group_1_1.children[i].visible=false;
                  }

                  for(i=0;i<=12;i++){
                    step_group_2.children[i].visible=false;
                  }

                  for(i=0;i<=13;i++){
                    step_group_1.children[i].visible=false;
                  }

                  redraw_Faces6();

                  mesh_left_ForceFace.children[0].material.visible=true;
                  mesh_left_ForceFace.children[1].material.visible=true;



                  Tube_group_right.traverse(function(obj) {
                    if (obj.type === "Mesh") {
                      obj.material.visible =false;
                    }
                  });


                    step_group_cell.children[0].visible=true;
                    step_group_cell.children[1].visible=true;
                    step_group_cell.children[2].visible=true;
                    step_group_cell.children[3].visible=true;
                    step_group_cell.children[4].material.visible=true;
                    step_group_cell.children[5].material.visible=true;
                    step_group_cell.children[6].material.visible=true;
                    step_group_cell.children[7].material.visible=true;


                  }

                else if(val == 3)
                  {


                          mesh_TriFace1.children[4].visible=false;
                          mesh_TriFace2.children[4].visible=false;
                          mesh_TriFace3.children[4].visible=false;
                          mesh_TriFace4.children[4].visible=false;
                          // controls_scale.Force_Arrow=false;


                          mesh_TriFace1.children[5].visible=false;
                          mesh_TriFace2.children[5].visible=false;
                          mesh_TriFace3.children[5].visible=false;
                          mesh_TriFace4.children[5].visible=false;

                          mesh_TriFace1.children[6].visible=false;
                          mesh_TriFace2.children[6].visible=false;
                          mesh_TriFace3.children[6].visible=false;
                          mesh_TriFace4.children[6].visible=false;

                          mesh_TriFace_step_f1.children[0].material.visible=false;
                          mesh_TriFace_step_f1.children[6].material.visible=false;

                          mesh_TriFace_step_f2.children[0].material.visible=false;
                          mesh_TriFace_step_f2.children[6].material.visible=false;

                          mesh_TriFace_step_f21.children[0].material.visible=false;
                          mesh_TriFace_step_f21.children[6].material.visible=false;

                          mesh_TriFace_step_f3.children[0].material.visible=false;
                          mesh_TriFace_step_f3.children[6].material.visible=false;

                          mesh_TriFace_step_f4.children[0].material.visible=false;
                          mesh_TriFace_step_f4.children[6].material.visible=false;

                          text_group2.children[0].material.visible=false;
                          text_group2.children[1].material.visible=false;
                          text_group2.children[2].material.visible=false;
                          text_group2.children[3].material.visible=false;
                          text_group2.children[4].material.visible=false;
                          text_group2.children[5].material.visible=false;
                          text_group2.children[6].material.visible=false;
                          text_group2.children[7].material.visible=false;
                          text_group2.children[8].material.visible=false;



                          Tube_group_right.traverse(function(obj) {
                            if (obj.type === "Mesh") {
                              obj.material.visible =false;
                            }
                          });

                          //controls_scale.Control_Face=false;


                          redraw_Force();
                          controls_scale.Step3=true;

                          controls_scale.ForceFace_left=true;


                            redraw_Faces6();

                            for(i=0;i<=1;i++){
                              mesh.children[i].material.visible=false;
                            };
                            mesh_left_ForceFace.children[0].material.visible=false;
                            mesh_left_ForceFace.children[1].material.visible=false;

                            mesh_TriFace1.children[0].material.visible=false;
                            mesh_TriFace2.children[0].material.visible=false;
                            mesh_TriFace3.children[0].material.visible=false;
                            mesh_TriFace4.children[0].material.visible=false;

                            for(i=1;i<=3;i++){
                              mesh_TriFace1.children[i].visible=false;
                              mesh_TriFace2.children[i].visible=false;
                              mesh_TriFace3.children[i].visible=false;
                              mesh_TriFace4.children[i].visible=false;
                            }

                            for(i=0;i<=1;i++){
                              mesh.children[i].material.visible=false;
                            }
                            for(i=0;i<=4;i++){
                              text_group1.children[1].material.visible=false;
                              text_group1.children[2].material.visible=false;
                              text_group1.children[3].material.visible=false;

                            }

                            text_group2.children[0].material.visible=false;
                            text_group2.children[1].material.visible=false;
                            text_group2.children[2].material.visible=false;
                            text_group2.children[3].material.visible=false;

                            Tube_group.children[15].material.visible=false;
                            Tube_group.children[21].material.visible=false;
                            Tube_group.children[25].material.visible=false;
                            Tube_group.children[10].material.visible=false;




                            mesh_TriFace1.children[4].visible=false;
                            mesh_TriFace2.children[4].visible=false;
                            mesh_TriFace3.children[4].visible=false;
                            mesh_TriFace4.children[4].visible=false;
                            // controls_scale.Force_Arrow=false;



                            for(i=1;i<=3;i++){
                              mesh_TriFace1.children[i].visible=false;
                              mesh_TriFace2.children[i].visible=false;
                              mesh_TriFace3.children[i].visible=false;
                              mesh_TriFace4.children[i].visible=false;
                            }

                            for(i=0;i<=14;i++){
                              step_group_1_1.children[i].visible=false;
                            }
                            step_group_1_1.children[4].visible=true;
                            step_group_1_1.children[1].visible=true;
                            step_group_1_1.children[0].visible=true;
                            step_group_1_1.children[10].visible=true;
                            step_group_1_1.children[13].visible=true;
                            step_group_1_1.children[14].visible=true;

                            for(i=0;i<=12;i++){
                              step_group_2.children[i].visible=false;
                            }

                            for(i=0;i<=13;i++){
                              step_group_1.children[i].visible=true;
                            }

                            step_group_1.children[4].visible=false;
                            step_group_1.children[2].visible=false;

                            redraw_Faces6();

                            for(i=0;i<=7;i++){
                              step_group_cell.children[i].visible=false;
                            }


                            Tube_group_right.traverse(function(obj) {
                              if (obj.type === "Mesh") {
                                obj.material.visible =false;
                              }
                            });
                            }


                            else if(val == 4)
                            {


                                    mesh_TriFace1.children[4].visible=false;
                                    mesh_TriFace2.children[4].visible=false;
                                    mesh_TriFace3.children[4].visible=false;
                                    mesh_TriFace4.children[4].visible=false;
                                    // controls_scale.Force_Arrow=false;


                                    mesh_TriFace1.children[5].visible=false;
                                    mesh_TriFace2.children[5].visible=false;
                                    mesh_TriFace3.children[5].visible=false;
                                    mesh_TriFace4.children[5].visible=false;

                                    mesh_TriFace1.children[6].visible=false;
                                    mesh_TriFace2.children[6].visible=false;
                                    mesh_TriFace3.children[6].visible=false;
                                    mesh_TriFace4.children[6].visible=false;

                                    mesh_TriFace_step_f1.children[0].material.visible=false;
                                    mesh_TriFace_step_f1.children[6].material.visible=false;

                                    mesh_TriFace_step_f2.children[0].material.visible=false;
                                    mesh_TriFace_step_f2.children[6].material.visible=false;

                                    mesh_TriFace_step_f21.children[0].material.visible=false;
                                    mesh_TriFace_step_f21.children[6].material.visible=false;

                                    mesh_TriFace_step_f3.children[0].material.visible=false;
                                    mesh_TriFace_step_f3.children[6].material.visible=false;

                                    mesh_TriFace_step_f4.children[0].material.visible=false;
                                    mesh_TriFace_step_f4.children[6].material.visible=false;

                                    text_group2.children[0].material.visible=false;
                                    text_group2.children[1].material.visible=false;
                                    text_group2.children[2].material.visible=false;
                                    text_group2.children[3].material.visible=false;
                                    text_group2.children[4].material.visible=false;
                                    text_group2.children[5].material.visible=false;
                                    text_group2.children[6].material.visible=false;
                                    text_group2.children[7].material.visible=false;
                                    text_group2.children[8].material.visible=false;




                                    Tube_group_right.traverse(function(obj) {
                                      if (obj.type === "Mesh") {
                                        obj.material.visible =false;
                                      }
                                    });

                                    //controls_scale.Control_Face=false;


                                    redraw_Force();
                                    controls_scale.Step4=true;

                                    controls_scale.ForceFace_left=true;


                                      redraw_Faces6();

                                      for(i=0;i<=1;i++){
                                        mesh.children[i].material.visible=false;
                                      };
                                      mesh_left_ForceFace.children[0].material.visible=false;
                                      mesh_left_ForceFace.children[1].material.visible=false;

                                      mesh_TriFace1.children[0].material.visible=false;
                                      mesh_TriFace2.children[0].material.visible=false;
                                      mesh_TriFace3.children[0].material.visible=false;
                                      mesh_TriFace4.children[0].material.visible=false;

                                      for(i=1;i<=3;i++){
                                        mesh_TriFace1.children[i].visible=false;
                                        mesh_TriFace2.children[i].visible=false;
                                        mesh_TriFace3.children[i].visible=false;
                                        mesh_TriFace4.children[i].visible=false;
                                      }

                                      for(i=0;i<=1;i++){
                                        mesh.children[i].material.visible=false;
                                      }
                                      for(i=0;i<=4;i++){
                                        text_group1.children[1].material.visible=false;
                                        text_group1.children[2].material.visible=false;
                                        text_group1.children[3].material.visible=false;

                                      }

                                      text_group2.children[0].material.visible=false;
                                      text_group2.children[1].material.visible=false;
                                      text_group2.children[2].material.visible=false;
                                      text_group2.children[3].material.visible=false;

                                      Tube_group.children[15].material.visible=false;
                                      Tube_group.children[21].material.visible=false;
                                      Tube_group.children[25].material.visible=false;
                                      Tube_group.children[10].material.visible=false;




                                      mesh_TriFace1.children[4].visible=false;
                                      mesh_TriFace2.children[4].visible=false;
                                      mesh_TriFace3.children[4].visible=false;
                                      mesh_TriFace4.children[4].visible=false;
                                      // controls_scale.Force_Arrow=false;



                                      for(i=1;i<=3;i++){
                                        mesh_TriFace1.children[i].visible=false;
                                        mesh_TriFace2.children[i].visible=false;
                                        mesh_TriFace3.children[i].visible=false;
                                        mesh_TriFace4.children[i].visible=false;
                                      }

                                      for(i=0;i<=14;i++){
                                        step_group_1_1.children[i].visible=true;
                                      }
                                      step_group_1_1.children[4].visible=false;
                                      step_group_1_1.children[12].material.visible=false;


                                      for(i=0;i<=12;i++){
                                        step_group_2.children[i].visible=false;
                                      }

                                      for(i=0;i<=13;i++){
                                        step_group_1.children[i].visible=true;
                                      }



                                      redraw_Faces6();



                                      Tube_group_right.traverse(function(obj) {
                                        if (obj.type === "Mesh") {
                                          obj.material.visible =false;
                                        }
                                      });

                                      }

                                      else if(val == 5)
                                      {


                                              mesh_TriFace1.children[4].visible=true;
                                              mesh_TriFace2.children[4].visible=false;
                                              mesh_TriFace3.children[4].visible=false;
                                              mesh_TriFace4.children[4].visible=false;
                                              mesh_TriFace2_stepar.children[4].visible=false;

                                              mesh_TriFace1.children[5].visible=true;
                                              mesh_TriFace2.children[5].visible=false;
                                              mesh_TriFace3.children[5].visible=false;
                                              mesh_TriFace4.children[5].visible=false;
                                              mesh_TriFace2_stepar.children[5].visible=false;

                                              mesh_TriFace1.children[6].visible=true;
                                              mesh_TriFace2.children[6].visible=false;
                                              mesh_TriFace3.children[6].visible=false;
                                              mesh_TriFace4.children[6].visible=false;
                                              mesh_TriFace2_stepar.children[6].visible=false;


                                              mesh_TriFace_step_f1.children[0].material.visible=false;
                                              mesh_TriFace_step_f1.children[6].material.visible=false;

                                              mesh_TriFace_step_f2.children[0].material.visible=false;
                                              mesh_TriFace_step_f2.children[6].material.visible=false;

                                              mesh_TriFace_step_f21.children[0].material.visible=false;
                                              mesh_TriFace_step_f21.children[6].material.visible=false;

                                              mesh_TriFace_step_f3.children[0].material.visible=false;
                                              mesh_TriFace_step_f3.children[6].material.visible=false;

                                              mesh_TriFace_step_f4.children[0].material.visible=false;
                                              mesh_TriFace_step_f4.children[6].material.visible=false;

                                              text_group2.children[0].material.visible=false;
                                              text_group2.children[1].material.visible=false;
                                              text_group2.children[2].material.visible=false;
                                              text_group2.children[3].material.visible=false;
                                              text_group2.children[4].material.visible=false;
                                              text_group2.children[5].material.visible=false;
                                              text_group2.children[6].material.visible=false;
                                              text_group2.children[7].material.visible=false;
                                              text_group2.children[8].material.visible=false;




                                              Tube_group_right.traverse(function(obj) {
                                                if (obj.type === "Mesh") {
                                                  obj.material.visible =false;
                                                }
                                              });

                                              //controls_scale.Control_Face=false;



                                              redraw_Force();
                                              controls_scale.Step5=true;

                                              controls_scale.ForceFace_left=true;


                                                redraw_Faces6();

                                                for(i=0;i<=1;i++){
                                                  mesh.children[i].material.visible=false;
                                                };
                                                mesh_left_ForceFace.children[0].material.visible=false;
                                                mesh_left_ForceFace.children[1].material.visible=false;

                                                mesh_TriFace1.children[0].material.visible=true;
                                                mesh_TriFace2.children[0].material.visible=false;
                                                mesh_TriFace3.children[0].material.visible=false;
                                                mesh_TriFace4.children[0].material.visible=false;

                                                for(i=1;i<=3;i++){
                                                  mesh_TriFace1.children[i].visible=true;
                                                  mesh_TriFace2.children[i].visible=false;
                                                  mesh_TriFace3.children[i].visible=false;
                                                  mesh_TriFace4.children[i].visible=false;
                                                }

                                                for(i=0;i<=1;i++){
                                                  mesh.children[i].material.visible=false;
                                                }
                                                for(i=0;i<=4;i++){
                                                  text_group1.children[1].material.visible=false;
                                                  text_group1.children[2].material.visible=false;
                                                  text_group1.children[3].material.visible=false;

                                                }

                                                text_group2.children[0].material.visible=true;
                                                text_group2.children[1].material.visible=false;
                                                text_group2.children[2].material.visible=false;
                                                text_group2.children[3].material.visible=false;

                                                Tube_group.children[15].material.visible=false;
                                                Tube_group.children[21].material.visible=false;
                                                Tube_group.children[25].material.visible=false;
                                                Tube_group.children[10].material.visible=false;




                                                mesh_TriFace1.children[4].visible=true;
                                                mesh_TriFace2.children[4].visible=false;
                                                mesh_TriFace3.children[4].visible=false;
                                                mesh_TriFace4.children[4].visible=false;
                                                mesh_TriFace2_stepar.children[4].visible=false;
                                                // controls_scale.Force_Arrow=false;


                                                for(i=1;i<=3;i++){
                                                  mesh_TriFace1.children[i].visible=true;
                                                  mesh_TriFace2.children[i].visible=true;
                                                  mesh_TriFace3.children[i].visible=false;
                                                  mesh_TriFace4.children[i].visible=false;
                                                }

                                                mesh_TriFace2.children[1].visible=false;
                                                mesh_TriFace2.children[2].visible=false;


                                                for(i=0;i<=14;i++){
                                                  step_group_1_1.children[i].visible=false;
                                                }
                                                  step_group_1_1.children[1].visible=true;
                                                  step_group_1_1.children[0].visible=true;
                                                  step_group_1_1.children[2].visible=true;


                                                for(i=0;i<=12;i++){
                                                  step_group_2.children[i].visible=true;
                                                }

                                                for(i=0;i<=12;i++){
                                                  step_group_2.children[i].visible=true;
                                                }
                                                step_group_2.children[6].visible=false;
                                                step_group_2.children[8].visible=false;

                                                for(i=0;i<=13;i++){
                                                  step_group_1.children[i].visible=false;
                                                }



                                                redraw_Faces6();



                                                Tube_group_right.traverse(function(obj) {
                                                  if (obj.type === "Mesh") {
                                                    obj.material.visible =false;
                                                  }
                                                });


                                                }


                                                else if(val == 6)
                                                {
                                                  redraw();

                                                  mesh_TriFace1.children[4].visible=false;
                                                  mesh_TriFace2.children[4].visible=false;
                                                  mesh_TriFace3.children[4].visible=false;
                                                  mesh_TriFace4.children[4].visible=false;
                                                  // controls_scale.Force_Arrow=false;



                                                  mesh_TriFace1.children[5].visible=true;
                                                  mesh_TriFace2.children[5].visible=true;
                                                  mesh_TriFace3.children[5].visible=false;
                                                  mesh_TriFace4.children[5].visible=false;

                                                  mesh_TriFace1.children[6].visible=true;
                                                  mesh_TriFace2.children[6].visible=true;
                                                  mesh_TriFace3.children[6].visible=false;
                                                  mesh_TriFace4.children[6].visible=false;


                                                  mesh_TriFace_step_f1.children[0].material.visible=false;
                                                  mesh_TriFace_step_f1.children[6].material.visible=false;


                                                  mesh_TriFace_step_f2.children[6].material.visible=false;

                                                  mesh_TriFace_step_f21.children[0].material.visible=false;
                                                  mesh_TriFace_step_f21.children[6].material.visible=false;

                                                  mesh_TriFace_step_f3.children[0].material.visible=false;
                                                  mesh_TriFace_step_f3.children[6].material.visible=false;

                                                  mesh_TriFace_step_f4.children[0].material.visible=false;
                                                  mesh_TriFace_step_f4.children[6].material.visible=false;

                                                  text_group2.children[0].material.visible=false;
                                                  text_group2.children[1].material.visible=false;
                                                  text_group2.children[2].material.visible=false;
                                                  text_group2.children[3].material.visible=false;
                                                  text_group2.children[4].material.visible=false;
                                                  text_group2.children[5].material.visible=false;
                                                  text_group2.children[6].material.visible=false;
                                                  text_group2.children[7].material.visible=false;
                                                  text_group2.children[8].material.visible=false;



                                                  Tube_group_right.traverse(function(obj) {
                                                    if (obj.type === "Mesh") {
                                                      obj.material.visible =false;
                                                    }
                                                  });

                                                  //controls_scale.Control_Face=false;



                                                  redraw_Force();

                                                  controls_scale.Step6=true;

                                                  controls_scale.ForceFace_left=true;


                                                    redraw_Faces6();

                                                    for(i=0;i<=1;i++){
                                                      mesh.children[i].material.visible=false;
                                                    };
                                                    mesh_left_ForceFace.children[0].material.visible=false;
                                                    mesh_left_ForceFace.children[1].material.visible=false;

                                                    mesh_TriFace1.children[0].material.visible=true;
                                                    mesh_TriFace2.children[0].material.visible=true;
                                                    mesh_TriFace3.children[0].material.visible=false;
                                                    mesh_TriFace4.children[0].material.visible=false;

                                                    for(i=1;i<=3;i++){
                                                      mesh_TriFace1.children[i].visible=false;
                                                      mesh_TriFace2.children[i].visible=false;
                                                      mesh_TriFace3.children[i].visible=false;
                                                      mesh_TriFace4.children[i].visible=false;
                                                    }

                                                    for(i=0;i<=1;i++){
                                                      mesh.children[i].material.visible=false;
                                                    }
                                                    for(i=0;i<=4;i++){
                                                      text_group1.children[1].material.visible=false;
                                                      text_group1.children[2].material.visible=false;
                                                      text_group1.children[3].material.visible=false;

                                                    }

                                                    text_group2.children[0].material.visible=true;
                                                    text_group2.children[1].material.visible=true;
                                                    text_group2.children[2].material.visible=false;
                                                    text_group2.children[3].material.visible=false;

                                                    Tube_group.children[15].material.visible=false;
                                                    Tube_group.children[21].material.visible=false;
                                                    Tube_group.children[25].material.visible=false;
                                                    Tube_group.children[10].material.visible=false;




                                                    mesh_TriFace1.children[4].visible=true;
                                                    
                                                    mesh_TriFace2_stepar.children[4].visible=false;
                                                    //mesh_TriFace2.children[4].visible=true;
                                                    mesh_TriFace3.children[4].visible=false;
                                                    mesh_TriFace4.children[4].visible=false;
                                                    // controls_scale.Force_Arrow=false;



                                                    for(i=1;i<=3;i++){
                                                      mesh_TriFace1.children[i].visible=true;
                                                      mesh_TriFace2.children[i].visible=true;
                                                      mesh_TriFace3.children[i].visible=false;
                                                      mesh_TriFace4.children[i].visible=false;
                                                      
                                                    }

                                                    // mesh_TriFace2_stepar.children[4].visible=true;



                                                    for(i=0;i<=14;i++){
                                                      step_group_1_1.children[i].visible=false;
                                                    }

                                                    step_group_1_1.children[1].visible=true;
                                                    step_group_1_1.children[0].visible=true;
                                                    step_group_1_1.children[2].visible=true;
                                                    step_group_1_1.children[12].visible=true;

                                                    for(i=0;i<=12;i++){
                                                      step_group_2.children[i].visible=true;
                                                    }

                                                    for(i=0;i<=13;i++){
                                                      step_group_1.children[i].visible=false;
                                                    }



                                                    redraw_Faces6();



                                                    Tube_group_right.traverse(function(obj) {
                                                      if (obj.type === "Mesh") {
                                                        obj.material.visible =false;
                                                      }
                                                    });

                                                          }

                                                          else if(val == 7)
                                                          {

                                                                    controls_scale.Step7=true;

                                                                      redraw();


                                                                      for(i=0;i<=1;i++){
                                                                        mesh.children[i].material.visible=false;
                                                                      };
                                                                      mesh_left_ForceFace.children[0].material.visible=false;
                                                                      mesh_left_ForceFace.children[1].material.visible=false;

                                                                      mesh_TriFace1.children[0].material.visible=true;
                                                                      mesh_TriFace2.children[0].material.visible=true;
                                                                      mesh_TriFace3.children[0].material.visible=true;
                                                                      mesh_TriFace4.children[0].material.visible=true;
                                                                      mesh_TriFace_step_f2.children[0].material.visible=true;

                                                                      mesh_TriFace_step_f1.children[0].material.visible=false;
                                                                      mesh_TriFace_step_f1.children[6].material.visible=false;


                                                                      mesh_TriFace_step_f2.children[6].material.visible=false;

                                                                      mesh_TriFace_step_f21.children[0].material.visible=false;
                                                                      mesh_TriFace_step_f21.children[6].material.visible=false;

                                                                      mesh_TriFace_step_f3.children[0].material.visible=false;
                                                                      mesh_TriFace_step_f3.children[6].material.visible=false;

                                                                      mesh_TriFace_step_f4.children[0].material.visible=false;
                                                                      mesh_TriFace_step_f4.children[6].material.visible=false;

                                                                      mesh_TriFace2_stepar.children[4].visible=false;

                                                                      text_group2.children[0].material.visible=false;
                                                                      text_group2.children[1].material.visible=false;
                                                                      text_group2.children[2].material.visible=false;
                                                                      text_group2.children[3].material.visible=false;
                                                                      text_group2.children[4].material.visible=false;
                                                                      text_group2.children[5].material.visible=false;
                                                                      text_group2.children[6].material.visible=false;
                                                                      text_group2.children[7].material.visible=false;
                                                                      text_group2.children[8].material.visible=false;

                                                                      for(i=1;i<=3;i++){
                                                                        mesh_TriFace1.children[i].visible=true;
                                                                        mesh_TriFace2.children[i].visible=true;
                                                                        mesh_TriFace3.children[i].visible=true;
                                                                        mesh_TriFace4.children[i].visible=true;
                                                                      }

                                                                      for(i=0;i<=4;i++){
                                                                        text_group1.children[1].material.visible=false;
                                                                        text_group1.children[2].material.visible=true;
                                                                        text_group1.children[3].material.visible=false;

                                                                      }

                                                                        text_group2.children[0].material.visible=true;
                                                                        text_group2.children[1].material.visible=true;
                                                                        text_group2.children[2].material.visible=true;
                                                                        text_group2.children[3].material.visible=true;




                                                                      Tube_group.children[15].material.visible=false;
                                                                      Tube_group.children[21].material.visible=true;
                                                                      Tube_group.children[25].material.visible=false;
                                                                      Tube_group.children[10].material.visible=false;




                                                                      mesh_TriFace1.children[4].visible=true;
                                                                      mesh_TriFace2.children[4].visible=true;
                                                                      mesh_TriFace3.children[4].visible=true;
                                                                      mesh_TriFace4.children[4].visible=true;


                                                                      for(i=1;i<=3;i++){
                                                                        mesh_TriFace1.children[i].visible=true;
                                                                        mesh_TriFace2.children[i].visible=true;
                                                                        mesh_TriFace3.children[i].visible=true;
                                                                        mesh_TriFace4.children[i].visible=true;
                                                                      }

                                                                      for(i=0;i<=14;i++){
                                                                        step_group_1_1.children[i].visible=false;
                                                                      }

                                                                      step_group_1_1.children[1].visible=true;
                                                                      step_group_1_1.children[0].visible=true;
                                                                      step_group_1_1.children[2].visible=true;
                                                                      step_group_1_1.children[12].visible=true;


                                                                      for(i=0;i<=12;i++){
                                                                        step_group_2.children[i].visible=false;
                                                                      }

                                                                      for(i=0;i<=13;i++){
                                                                        step_group_1.children[i].visible=false;
                                                                      }



                                                                      Tube_group_right.traverse(function(obj) {
                                                                        if (obj.type === "Mesh") {
                                                                          obj.material.visible =false;
                                                                        }
                                                                      });



                                                                            mesh_TriFace1.children[4].visible=true;
                                                                            mesh_TriFace2.children[4].visible=true;
                                                                            mesh_TriFace3.children[4].visible=true;
                                                                            mesh_TriFace4.children[4].visible=true;
                                                                            // controls_scale.Force_Arrow=false;



                                                                            mesh_TriFace1.children[5].visible=true;
                                                                            mesh_TriFace2.children[5].visible=true;
                                                                            mesh_TriFace3.children[5].visible=true;
                                                                            mesh_TriFace4.children[5].visible=true;
                                                                            mesh_TriFace1.children[6].visible=true;
                                                                            mesh_TriFace2.children[6].visible=true;
                                                                            mesh_TriFace3.children[6].visible=true;
                                                                            mesh_TriFace4.children[6].visible=true;


                                                                    }

                          }


    $("#ch2").attr("checked",true);

    $("#ch2").change(function() {

      if(controls_scale.Control_Face=$("#ch2").prop('checked'))
      {redraw_right();

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=$("#ch2").prop('checked');
        }




        Tube_group_right.children[0].material.visible=false;
        Tube_group_right.children[1].material.visible=false;
        Tube_group_right.children[2].material.visible=false;
        Tube_group_right.children[3].material.visible=false;
      }else
      {
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        }
        Tube_group_right.traverse(function(obj) {
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });
      }
    });

    $("#ch3").attr("checked",false);

    $("#ch3").change(function() {

      if(controls_scale.Pair_Control=$("#ch3").prop('checked'))
      {
        //redraw();

        redraw_pair_base();
        mesh_TriFace_step_f1.children[0].material.visible=false;
        mesh_TriFace_step_f1.children[6].material.visible=false;

           mesh_TriFace_step_f2.children[0].material.visible=false;
           mesh_TriFace_step_f2.children[6].material.visible=false;

        mesh_TriFace_step_f21.children[0].material.visible=false;
        mesh_TriFace_step_f21.children[6].material.visible=false;

        mesh_TriFace_step_f3.children[0].material.visible=false;
        mesh_TriFace_step_f3.children[6].material.visible=false;

        mesh_TriFace_step_f4.children[0].material.visible=false;
        mesh_TriFace_step_f4.children[6].material.visible=false;

        Tube_group.children[15].material.visible=false;
        Tube_group.children[21].material.visible=false;
        Tube_group.children[25].material.visible=false;
        Tube_group.children[10].material.visible=false;


        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        } 

        //controls_scale.Force_face=false;



        mesh_TriFace1.children[0].material.visible=false;
        mesh_TriFace2.children[0].material.visible=false;
        mesh_TriFace3.children[0].material.visible=false;
        mesh_TriFace4.children[0].material.visible=false;

        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        //controls_scale.Arrow_face=false;


        mesh_TriFace1.children[4].visible=false;
        mesh_TriFace2.children[4].visible=false;
        mesh_TriFace3.children[4].visible=false;
        mesh_TriFace4.children[4].visible=false;
        // controls_scale.Force_Arrow=false;


        mesh_TriFace1.children[5].visible=false;
        mesh_TriFace2.children[5].visible=false;
        mesh_TriFace3.children[5].visible=false;
        mesh_TriFace4.children[5].visible=false;

        mesh_TriFace1.children[6].visible=false;
        mesh_TriFace2.children[6].visible=false;
        mesh_TriFace3.children[6].visible=false;
        mesh_TriFace4.children[6].visible=false;




        Tube_group_right.traverse(function(obj) {
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });

        //controls_scale.Control_Face=false;



        redraw_Force();

        for(i=0;i<=1;i++){

          mesh_left_pair.children[i].material.visible=true;
        }

        mesh_F1_pair.children[0].material.visible=true;
        mesh_F2_pair.children[0].material.visible=true;
        mesh_F3_pair.children[0].material.visible=true;
        mesh_F4_pair.children[0].material.visible=true;



        for(i=0;i<=1;i++){

          mesh_left.children[i].material.visible=true;
        }
        mesh_F1.children[0].material.visible=true;
        mesh_F2.children[0].material.visible=true;
        mesh_F3.children[0].material.visible=true;
        mesh_F4.children[0].material.visible=true;

        for(i=0;i<=6;i++){

          mesh_F1.children[i].material.visible=true;
        }

        scene2.remove(text_group2);



        //text_group2.children[0].material.visible=false;





      }else
      {


        for(i=0;i<=1;i++){

          mesh_left_pair.children[i].material.visible=$("#ch3").prop('checked');
        }
        mesh_F1_pair.children[0].material.visible=$("#ch3").prop('checked');
        mesh_F2_pair.children[0].material.visible=$("#ch3").prop('checked');
        mesh_F3_pair.children[0].material.visible=$("#ch3").prop('checked');
        mesh_F4_pair.children[0].material.visible=$("#ch3").prop('checked');
        redraw();
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=true;
        }

        // mesh_left_ForceFace.children.forEach(function (e) {
        //     e.geometry.vertices = vertices;
        //     e.geometry.verticesNeedUpdate = true;

        //     // e.geometry.faces[0].color.set(0xff00ee);
        //     // e.geometry.facesNeedUpdate=true;
        //     e.geometry.elementsNeedUpdate = true;
        //     e.geometry.computeFaceNormals();
        //     //e.geometry.center();
        // });

        Tube_group_pair.traverse(function(obj) {
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });

        for(i=0;i<=1;i++){

          mesh_left.children[i].material.visible=$("#ch3").prop('checked');
        }
        mesh_F1.children[0].material.visible=$("#ch3").prop('checked');
        //mesh_F1.children[0].material.visible=$("#ch3").prop('checked');
        mesh_F2.children[0].material.visible=$("#ch3").prop('checked');
        mesh_F3.children[0].material.visible=$("#ch3").prop('checked');
        mesh_F4.children[0].material.visible=$("#ch3").prop('checked');

        for(i=0;i<=6;i++){

          mesh_F1.children[i].material.visible=$("#ch3").prop('checked');
        }









        //Tube_group_pair.children[i].material.visible=false;








      }


    });

    $("#ch4").attr("checked",false);

    $("#ch4").change(function() {

      controls_scale.ForceFace_left=$("#ch4").prop('checked');
      redraw_Faces6();

      mesh_left_ForceFace.children[0].material.visible=$("#ch4").prop('checked');
      mesh_left_ForceFace.children[1].material.visible=$("#ch4").prop('checked');
    });

    $("#ch5").attr("checked",false);

    $("#ch5").change(function() {

      controls_scale.Stepcell=$("#ch5").prop('checked');
      redraw_Cell();
      redraw();
      step_group_cell.children[0].visible=$("#ch5").prop('checked');
      step_group_cell.children[1].visible=$("#ch5").prop('checked');
      step_group_cell.children[2].visible=$("#ch5").prop('checked');
      step_group_cell.children[3].visible=$("#ch5").prop('checked');
      step_group_cell.children[4].material.visible=$("#ch5").prop('checked');
      step_group_cell.children[5].material.visible=$("#ch5").prop('checked');
      step_group_cell.children[6].material.visible=$("#ch5").prop('checked');
      step_group_cell.children[7].material.visible=$("#ch5").prop('checked');
      step_group_1_1.children[1].visible=$("#ch5").prop('checked');
      step_group_1_1.children[0].visible=$("#ch5").prop('checked');
      step_group_1_1.children[2].visible=$("#ch5").prop('checked');
      step_group_1_1.children[12].visible=$("#ch5").prop('checked');



    });


    $("#ch6").attr("checked",false);


    $("#ch6").change(function() {

      controls_scale.Arrow_face=$("#ch6").prop('checked');

      mesh_TriFace1.children[0].material.visible=$("#ch6").prop('checked');
      mesh_TriFace2.children[0].material.visible=$("#ch6").prop('checked');
      mesh_TriFace3.children[0].material.visible=$("#ch6").prop('checked');
      mesh_TriFace4.children[0].material.visible=$("#ch6").prop('checked');

      for(i=1;i<=3;i++){
        mesh_TriFace1.children[i].visible=$("#ch6").prop('checked');
        mesh_TriFace2.children[i].visible=$("#ch6").prop('checked');
        mesh_TriFace3.children[i].visible=$("#ch6").prop('checked');
        mesh_TriFace4.children[i].visible=$("#ch6").prop('checked');
      }

      if($("#ch6").prop('checked')){

mesh_TriFace_step_f1.children[0].material.visible=false;
mesh_TriFace_step_f1.children[6].material.visible=false;
mesh_TriFace_step_f2.children[6].material.visible=false;
mesh_TriFace_step_f21.children[0].material.visible=false;
mesh_TriFace_step_f21.children[6].material.visible=false;
mesh_TriFace_step_f3.children[0].material.visible=false;
mesh_TriFace_step_f3.children[6].material.visible=false;
mesh_TriFace_step_f4.children[0].material.visible=false;
mesh_TriFace_step_f4.children[6].material.visible=false;

}
else{
  mesh_TriFace_step_f1.children[0].material.visible=true;
mesh_TriFace_step_f1.children[6].material.visible=true;
mesh_TriFace_step_f2.children[6].material.visible=true;
mesh_TriFace_step_f21.children[0].material.visible=true;
mesh_TriFace_step_f21.children[6].material.visible=true;
mesh_TriFace_step_f3.children[0].material.visible=true;
mesh_TriFace_step_f3.children[6].material.visible=true;
mesh_TriFace_step_f4.children[0].material.visible=true;
mesh_TriFace_step_f4.children[6].material.visible=true;
}

    });


    $("#ch7").attr("checked",false);


    $("#ch7").change(function() {

      controls_scale.Control_Face=$("#ch7").prop('checked');
      redraw_right();

      Tube_group_right.traverse(function(obj) {
        if (obj.type === "Mesh") {
          obj.material.visible =$("#ch7").prop('checked');
        }
      });

    });

    $("#ch8").attr("checked",false);//on /off

    $("#ch8").change(function() {

      if($("#ch8").prop('checked'))//on /off
      {
        Tube_group_right.children[0].material.color.set(0xFF6347);

        for(i=0;i<=2;i++)
        {
          mesh_left_Cell2.children[1].geometry.faces[i].color.set(0xFF6347);
        }

      }
      else //before / after
      {
        Tube_group_right.children[0].material.color.set(0x5a5a5a);

        for(i=0;i<=2;i++)
        {
          mesh_left_Cell2.children[1].geometry.faces[i].color.set(0xCCCCCC);
        }

      }

      mesh_left_Cell2.children[1].geometry.facesNeedUpdate=true;
      mesh_left_Cell2.children[1].geometry.elementsNeedUpdate = true;
      mesh_left_Cell2.children[1].geometry.computeFaceNormals();

    });//on / off

    $("#ch9").attr("checked",false);//on /off

    $("#ch9").change(function() {

      if($("#ch9").prop('checked'))//on /off
      {
        Tube_group_right.children[1].material.color.set(0xFF6347);

        for(i=0;i<=2;i++)
        {
          mesh_left_Cell3.children[1].geometry.faces[i].color.set(0xFF6347);
        }

      }
      else //before / after
      {
        Tube_group_right.children[1].material.color.set(0x5a5a5a);

        for(i=0;i<=2;i++)
        {
          mesh_left_Cell3.children[1].geometry.faces[i].color.set(0xCCCCCC);
        }



      }
      mesh_left_Cell3.children[1].geometry.facesNeedUpdate=true;
      mesh_left_Cell3.children[1].geometry.elementsNeedUpdate = true;
      mesh_left_Cell3.children[1].geometry.computeFaceNormals();

    });//on / off

    $("#ch10").attr("checked",false);//on /off

    $("#ch10").change(function() {

      if($("#ch10").prop('checked'))//on /off
      {
        Tube_group_right.children[2].material.color.set(0xFF6347);
        for(i=0;i<=2;i++)
        {
          mesh_left_Cell1.children[1].geometry.faces[i].color.set(0xFF6347);
        }

      }
      else //before / after
      {
        Tube_group_right.children[2].material.color.set(0x5a5a5a);
        for(i=0;i<=2;i++)
        {
          mesh_left_Cell1.children[1].geometry.faces[i].color.set(0xCCCCCC);
        }


      }
      mesh_left_Cell1.children[1].geometry.facesNeedUpdate=true;
      mesh_left_Cell1.children[1].geometry.elementsNeedUpdate = true;
      mesh_left_Cell1.children[1].geometry.computeFaceNormals();


    });//on / off
    $("#ch11").attr("checked",false);//on /off

    $("#ch11").change(function() {

      if($("#ch11").prop('checked'))//on /off
      {
        Tube_group_right.children[3].material.color.set(0xFF6347);
        for(i=0;i<=2;i++)
        {
          mesh_left_Cell4.children[1].geometry.faces[i].color.set(0xFF6347);
        }



      }
      else //before / after
      {
        Tube_group_right.children[3].material.color.set(0x5a5a5a);

        for(i=0;i<=2;i++)
        {
          mesh_left_Cell4.children[1].geometry.faces[i].color.set(0xCCCCCC);
        }


      }
      mesh_left_Cell4.children[1].geometry.facesNeedUpdate=true;
      mesh_left_Cell4.children[1].geometry.elementsNeedUpdate = true;
      mesh_left_Cell4.children[1].geometry.computeFaceNormals();


    });//on / off

    $("#ch12").attr("checked",false);//on /off

    $("#ch12").change(function() {

      if($("#ch12").prop('checked'))//on /off
      {
        Tube_group_right.children[4].material.color.set(0xFF6347);
        mesh_left_ForceFace.children[0].geometry.faces[1].color.set(0xFF6347);

      }
      else //before / after
      {
        Tube_group_right.children[4].material.color.set(0x5a5a5a);
        mesh_left_ForceFace.children[0].geometry.faces[1].color.set(0x009600);

      }
      mesh_left_ForceFace.children[0].geometry.facesNeedUpdate=true;

      mesh_left_ForceFace.children[0].geometry.elementsNeedUpdate = true;
      mesh_left_ForceFace.children[0].geometry.computeFaceNormals();


    });//on / off

    $("#ch13").attr("checked",false);//on /off

    $("#ch13").change(function() {

      if($("#ch13").prop('checked'))//on /off
      {
        Tube_group_right.children[5].material.color.set(0xFF6347);
        mesh_left_ForceFace.children[0].geometry.faces[2].color.set(0xFF6347);

      }
      else //before / after
      {
        Tube_group_right.children[5].material.color.set(0x5a5a5a);
        mesh_left_ForceFace.children[0].geometry.faces[2].color.set(0x009600);

      }
      mesh_left_ForceFace.children[0].geometry.facesNeedUpdate=true;

      mesh_left_ForceFace.children[0].geometry.elementsNeedUpdate = true;
      mesh_left_ForceFace.children[0].geometry.computeFaceNormals();


    });//on / off

    $("#ch14").attr("checked",false);//on /off

    $("#ch14").change(function() {

      if($("#ch14").prop('checked'))//on /off
      {
        Tube_group_right.children[6].material.color.set(0xFF6347);
        mesh_left_ForceFace.children[0].geometry.faces[0].color.set(0xFF6347);

      }
      else //before / after
      {
        Tube_group_right.children[6].material.color.set(0x5a5a5a);
        mesh_left_ForceFace.children[0].geometry.faces[0].color.set(0x009600);

      }
      mesh_left_ForceFace.children[0].geometry.facesNeedUpdate=true;

      mesh_left_ForceFace.children[0].geometry.elementsNeedUpdate = true;
      mesh_left_ForceFace.children[0].geometry.computeFaceNormals();

    });//on / off


    $("#ch15").attr("checked",false);//on /off

    $("#ch15").change(function() {

      if($("#ch15").prop('checked'))//on /off
      {
        Tube_group_right.children[7].material.color.set(0xFF6347);
        mesh_left_ForceFace.children[0].geometry.faces[3].color.set(0xFF6347);

      }
      else //before / after
      {
        Tube_group_right.children[7].material.color.set(0x5a5a5a);
        mesh_left_ForceFace.children[0].geometry.faces[3].color.set(0x009600);

      }
      mesh_left_ForceFace.children[0].geometry.facesNeedUpdate=true;

      mesh_left_ForceFace.children[0].geometry.elementsNeedUpdate = true;
      mesh_left_ForceFace.children[0].geometry.computeFaceNormals();

    });//on / off

    $("#ch16").attr("checked",false);//on /off

    $("#ch16").change(function() {

      if($("#ch16").prop('checked'))//on /off
      {
        Tube_group_right.children[8].material.color.set(0xFF6347);
        mesh_left_ForceFace.children[0].geometry.faces[5].color.set(0xFF6347);

      }
      else //before / after
      {
        Tube_group_right.children[8].material.color.set(0x5a5a5a);
        mesh_left_ForceFace.children[0].geometry.faces[5].color.set(0x009600);

      }
      mesh_left_ForceFace.children[0].geometry.facesNeedUpdate=true;

      mesh_left_ForceFace.children[0].geometry.elementsNeedUpdate = true;
      mesh_left_ForceFace.children[0].geometry.computeFaceNormals();

    });//on / off

    $("#ch17").attr("checked",false);//on /off

    $("#ch17").change(function() {

      if($("#ch17").prop('checked'))//on /off
      {
        Tube_group_right.children[9].material.color.set(0xFF6347);
        mesh_left_ForceFace.children[0].geometry.faces[4].color.set(0xFF6347);

      }
      else //before / after
      {
        Tube_group_right.children[9].material.color.set(0x5a5a5a);
        mesh_left_ForceFace.children[0].geometry.faces[4].color.set(0x009600);

      }
      mesh_left_ForceFace.children[0].geometry.facesNeedUpdate=true;

      mesh_left_ForceFace.children[0].geometry.elementsNeedUpdate = true;
      mesh_left_ForceFace.children[0].geometry.computeFaceNormals();

    });//on / off

    $("#ch18").attr("checked",false);//on /off

    $("#ch18").change(function() {


      var val = $('#Stepstest').slider("value");

      controls_scale.ForceFace_left=$("#ch18").prop('checked');
      redraw_Faces6();
      controls_scale.Step1=$("#ch18").prop('checked')

      mesh_left_ForceFace.children[0].material.visible=$("#ch18").prop('checked');
      mesh_left_ForceFace.children[1].material.visible=$("#ch18").prop('checked');

      if($("#ch18").prop('checked'))
      {
        resetSlider();
        val == 0
        redraw();
        redraw_Faces6();

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        };
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        mesh_TriFace1.children[0].material.visible=false;
        mesh_TriFace2.children[0].material.visible=false;
        mesh_TriFace3.children[0].material.visible=false;
        mesh_TriFace4.children[0].material.visible=false;

        mesh_TriFace_step_f1.children[0].material.visible=false;
        mesh_TriFace_step_f1.children[6].material.visible=false;

        mesh_TriFace_step_f2.children[0].material.visible=false;
        mesh_TriFace_step_f2.children[6].material.visible=false;

        mesh_TriFace_step_f21.children[0].material.visible=false;
        mesh_TriFace_step_f21.children[6].material.visible=false;

        mesh_TriFace_step_f3.children[0].material.visible=false;
        mesh_TriFace_step_f3.children[6].material.visible=false;

        mesh_TriFace_step_f4.children[0].material.visible=false;
        mesh_TriFace_step_f4.children[6].material.visible=false;

        mesh_TriFace2_stepar.children[0].material.visible=false;
        mesh_TriFace2_stepar.children[6].material.visible=false;

        text_group2.children[0].material.visible=false;
        text_group2.children[1].material.visible=false;
        text_group2.children[2].material.visible=false;
        text_group2.children[3].material.visible=false;
        text_group2.children[4].material.visible=false;
        text_group2.children[5].material.visible=false;
        text_group2.children[6].material.visible=false;
        text_group2.children[7].material.visible=false;
        text_group2.children[8].material.visible=false;


        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
          mesh_TriFace2_stepar.children[i].visible=false;
        }

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        }
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=false;
          text_group1.children[2].material.visible=false;
          text_group1.children[3].material.visible=false;

        }




        Tube_group.children[15].material.visible=false;
        Tube_group.children[21].material.visible=false;
        Tube_group.children[25].material.visible=false;
        Tube_group.children[10].material.visible=false;




        mesh_TriFace1.children[4].visible=false;
        mesh_TriFace2.children[4].visible=false;
        mesh_TriFace3.children[4].visible=false;
        mesh_TriFace4.children[4].visible=false;
        mesh_TriFace2_stepar.children[4].visible=false;
        // controls_scale.Force_Arrow=false;


        //hide arrowa

        //hide normals


        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=14;i++){
          step_group_1_1.children[i].visible=false;
        }

        for(i=0;i<=12;i++){
          step_group_2.children[i].visible=false;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }

        redraw_Faces6();

        mesh_left_ForceFace.children[0].material.visible=true;
        mesh_left_ForceFace.children[1].material.visible=true;

        //hide edges points

        Tube_group_right.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });



              mesh_TriFace1.children[4].visible=false;
              mesh_TriFace2.children[4].visible=false;
              mesh_TriFace3.children[4].visible=false;
              mesh_TriFace4.children[4].visible=false;
              // controls_scale.Force_Arrow=false;


              //hide arrowa

              //hide normals

              mesh_TriFace1.children[5].visible=false;
              mesh_TriFace2.children[5].visible=false;
              mesh_TriFace3.children[5].visible=false;
              mesh_TriFace4.children[5].visible=false;

              mesh_TriFace2_stepar.children[5].visible=false;

              mesh_TriFace1.children[6].visible=false;
              mesh_TriFace2.children[6].visible=false;
              mesh_TriFace3.children[6].visible=false;
              mesh_TriFace4.children[6].visible=false;

              mesh_TriFace2_stepar.children[6].visible=false;





              //hide edges points

              Tube_group_right.traverse(function(obj) {//hide group
                if (obj.type === "Mesh") {
                  obj.material.visible =false;
                }
              });

              //controls_scale.Control_Face=false;



      }
      else
      {
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=true;
          text_group1.children[2].material.visible=true;
          text_group1.children[3].material.visible=true;

        }

        for(i=0;i<=4;i++){
          text_group2.children[1].material.visible=true;
          text_group2.children[2].material.visible=true;
          text_group2.children[3].material.visible=true;

        }

        redraw();
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=true;
        }

        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;


        Tube_group.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =true;
          }
        });



      }

    });


    $("#ch19").attr("checked",false);//on /off

    $("#ch19").change(function() {



      mesh_TriFace1.children[4].visible=false;
      mesh_TriFace2.children[4].visible=false;
      mesh_TriFace3.children[4].visible=false;
      mesh_TriFace4.children[4].visible=false;
      // controls_scale.Force_Arrow=false;


      //hide arrowa

      //hide normals

      mesh_TriFace1.children[5].visible=false;
      mesh_TriFace2.children[5].visible=false;
      mesh_TriFace3.children[5].visible=false;
      mesh_TriFace4.children[5].visible=false;

      mesh_TriFace1.children[6].visible=false;
      mesh_TriFace2.children[6].visible=false;
      mesh_TriFace3.children[6].visible=false;
      mesh_TriFace4.children[6].visible=false;




      step_group_cell.children[0].visible=true;
      //hide edges points

      Tube_group_right.traverse(function(obj) {//hide group
        if (obj.type === "Mesh") {
          obj.material.visible =false;
        }
      });

      //controls_scale.Control_Face=false;


      //show left

      redraw_Force();

      controls_scale.Step2=$("#ch19").prop('checked')

      if(controls_scale.ForceFace_left=$("#ch19").prop('checked'))
      {

        redraw_Faces6();

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        };
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        mesh_TriFace1.children[0].material.visible=false;
        mesh_TriFace2.children[0].material.visible=false;
        mesh_TriFace3.children[0].material.visible=false;
        mesh_TriFace4.children[0].material.visible=false;

        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        }
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=false;
          text_group1.children[2].material.visible=false;
          text_group1.children[3].material.visible=false;

        }

        text_group2.children[0].material.visible=false;
        text_group2.children[1].material.visible=false;
        text_group2.children[2].material.visible=false;
        text_group2.children[3].material.visible=false;

        Tube_group.children[15].material.visible=false;
        Tube_group.children[21].material.visible=false;
        Tube_group.children[25].material.visible=false;
        Tube_group.children[10].material.visible=false;




        mesh_TriFace1.children[4].visible=false;
        mesh_TriFace2.children[4].visible=false;
        mesh_TriFace3.children[4].visible=false;
        mesh_TriFace4.children[4].visible=false;
        // controls_scale.Force_Arrow=false;


        //hide arrowa

        //hide normals


        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=9;i++){
          step_group_1_1.children[i].visible=false;
        }

        for(i=0;i<=12;i++){
          step_group_2.children[i].visible=false;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }

        redraw_Faces6();

        mesh_left_ForceFace.children[0].material.visible=true;
        mesh_left_ForceFace.children[1].material.visible=true;

        //hide edges points

        Tube_group_right.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });


          step_group_cell.children[0].visible=true;
          step_group_cell.children[1].visible=true;
          step_group_cell.children[2].visible=true;
          step_group_cell.children[3].visible=true;
          step_group_cell.children[4].material.visible=true;
          step_group_cell.children[5].material.visible=true;
          step_group_cell.children[6].material.visible=true;
          step_group_cell.children[7].material.visible=true;


      }
      else
      {
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=true;
          text_group1.children[2].material.visible=true;
          text_group1.children[3].material.visible=true;

        }

        for(i=0;i<=4;i++){
          text_group2.children[1].material.visible=true;
          text_group2.children[2].material.visible=true;
          text_group2.children[3].material.visible=true;

        }

        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;


        Tube_group.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =true;
          }
        });

        redraw();
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=true;
        }

        step_group_cell.children[0].visible=false;
        step_group_cell.children[1].visible=false;
        step_group_cell.children[2].visible=false;
        step_group_cell.children[3].visible=false;
        step_group_cell.children[4].material.visible=false;
        step_group_cell.children[5].material.visible=false;
        step_group_cell.children[6].material.visible=false;
        step_group_cell.children[7].material.visible=false;



      }

    });

    $("#ch20").attr("checked",false);//on /off

    $("#ch20").change(function() {



      mesh_TriFace1.children[4].visible=false;
      mesh_TriFace2.children[4].visible=false;
      mesh_TriFace3.children[4].visible=false;
      mesh_TriFace4.children[4].visible=false;
      // controls_scale.Force_Arrow=false;


      //hide arrowa

      //hide normals

      mesh_TriFace1.children[5].visible=false;
      mesh_TriFace2.children[5].visible=false;
      mesh_TriFace3.children[5].visible=false;
      mesh_TriFace4.children[5].visible=false;

      mesh_TriFace1.children[6].visible=false;
      mesh_TriFace2.children[6].visible=false;
      mesh_TriFace3.children[6].visible=false;
      mesh_TriFace4.children[6].visible=false;





      //hide edges points

      Tube_group_right.traverse(function(obj) {//hide group
        if (obj.type === "Mesh") {
          obj.material.visible =false;
        }
      });

      //controls_scale.Control_Face=false;


      //show left

      redraw_Force();
      controls_scale.Step3=$("#ch20").prop('checked')

      if(controls_scale.ForceFace_left=$("#ch20").prop('checked'))
      {

        redraw_Faces6();

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        };
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        mesh_TriFace1.children[0].material.visible=false;
        mesh_TriFace2.children[0].material.visible=false;
        mesh_TriFace3.children[0].material.visible=false;
        mesh_TriFace4.children[0].material.visible=false;

        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        }
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=false;
          text_group1.children[2].material.visible=false;
          text_group1.children[3].material.visible=false;

        }

        text_group2.children[0].material.visible=false;
        text_group2.children[1].material.visible=false;
        text_group2.children[2].material.visible=false;
        text_group2.children[3].material.visible=false;

        Tube_group.children[15].material.visible=false;
        Tube_group.children[21].material.visible=false;
        Tube_group.children[25].material.visible=false;
        Tube_group.children[10].material.visible=false;




        mesh_TriFace1.children[4].visible=false;
        mesh_TriFace2.children[4].visible=false;
        mesh_TriFace3.children[4].visible=false;
        mesh_TriFace4.children[4].visible=false;
        // controls_scale.Force_Arrow=false;


        //hide arrowa

        //hide normals


        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=11;i++){
          step_group_1_1.children[i].visible=false;
        }
        step_group_1_1.children[4].visible=true;
        step_group_1_1.children[1].visible=true;
        step_group_1_1.children[0].visible=true;
        step_group_1_1.children[10].visible=true;

        for(i=0;i<=12;i++){
          step_group_2.children[i].visible=false;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=true;
        }

        step_group_1.children[4].visible=false;
        step_group_1.children[2].visible=false;

        redraw_Faces6();



        //hide edges points

        Tube_group_right.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });


      }
      else
      {
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=true;
          text_group1.children[2].material.visible=true;
          text_group1.children[3].material.visible=true;

        }
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        for(i=0;i<=11;i++){
          step_group_1_1.children[i].visible=false;
        }
        Tube_group.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =true;
          }
        });

        for(i=0;i<=4;i++){
          text_group2.children[1].material.visible=true;
          text_group2.children[2].material.visible=true;
          text_group2.children[3].material.visible=true;

        }
        redraw();
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=true;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }


      }

    });

    $("#ch21").attr("checked",false);//on /off

    $("#ch21").change(function() {



      mesh_TriFace1.children[4].visible=false;
      mesh_TriFace2.children[4].visible=false;
      mesh_TriFace3.children[4].visible=false;
      mesh_TriFace4.children[4].visible=false;
      // controls_scale.Force_Arrow=false;


      //hide arrowa

      //hide normals

      mesh_TriFace1.children[5].visible=false;
      mesh_TriFace2.children[5].visible=false;
      mesh_TriFace3.children[5].visible=false;
      mesh_TriFace4.children[5].visible=false;

      mesh_TriFace1.children[6].visible=false;
      mesh_TriFace2.children[6].visible=false;
      mesh_TriFace3.children[6].visible=false;
      mesh_TriFace4.children[6].visible=false;





      //hide edges points

      Tube_group_right.traverse(function(obj) {//hide group
        if (obj.type === "Mesh") {
          obj.material.visible =false;
        }
      });

      //controls_scale.Control_Face=false;


      //show left

      redraw_Force();
      controls_scale.Step4=$("#ch21").prop('checked')

      if(controls_scale.ForceFace_left=$("#ch21").prop('checked'))
      {

        redraw_Faces6();

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        };
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        mesh_TriFace1.children[0].material.visible=false;
        mesh_TriFace2.children[0].material.visible=false;
        mesh_TriFace3.children[0].material.visible=false;
        mesh_TriFace4.children[0].material.visible=false;

        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        }
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=false;
          text_group1.children[2].material.visible=false;
          text_group1.children[3].material.visible=false;

        }

        text_group2.children[0].material.visible=false;
        text_group2.children[1].material.visible=false;
        text_group2.children[2].material.visible=false;
        text_group2.children[3].material.visible=false;

        Tube_group.children[15].material.visible=false;
        Tube_group.children[21].material.visible=false;
        Tube_group.children[25].material.visible=false;
        Tube_group.children[10].material.visible=false;




        mesh_TriFace1.children[4].visible=false;
        mesh_TriFace2.children[4].visible=false;
        mesh_TriFace3.children[4].visible=false;
        mesh_TriFace4.children[4].visible=false;
        // controls_scale.Force_Arrow=false;


        //hide arrowa

        //hide normals


        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=11;i++){
          step_group_1_1.children[i].visible=true;
        }
        step_group_1_1.children[4].visible=false;


        for(i=0;i<=12;i++){
          step_group_2.children[i].visible=false;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=true;
        }



        redraw_Faces6();



        //hide edges points

        Tube_group_right.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });


      }
      else
      {
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=true;
          text_group1.children[2].material.visible=true;
          text_group1.children[3].material.visible=true;

        }
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        for(i=0;i<=11;i++){
          step_group_1_1.children[i].visible=false;
        }
        Tube_group.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =true;
          }
        });

        for(i=0;i<=4;i++){
          text_group2.children[1].material.visible=true;
          text_group2.children[2].material.visible=true;
          text_group2.children[3].material.visible=true;

        }
        redraw();
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=true;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }


      }

    });

    $("#ch22").attr("checked",false);//on /off

    $("#ch22").change(function() {



      mesh_TriFace1.children[4].visible=true;
      mesh_TriFace2.children[4].visible=false;
      mesh_TriFace3.children[4].visible=false;
      mesh_TriFace4.children[4].visible=false;

      mesh_TriFace1.children[5].visible=true;
      mesh_TriFace2.children[5].visible=false;
      mesh_TriFace3.children[5].visible=false;
      mesh_TriFace4.children[5].visible=false;

      mesh_TriFace1.children[6].visible=true;
      mesh_TriFace2.children[6].visible=false;
      mesh_TriFace3.children[6].visible=false;
      mesh_TriFace4.children[6].visible=false;





      //hide edges points

      Tube_group_right.traverse(function(obj) {//hide group
        if (obj.type === "Mesh") {
          obj.material.visible =false;
        }
      });

      //controls_scale.Control_Face=false;


      //show left

      redraw_Force();
      controls_scale.Step5=$("#ch22").prop('checked')

      if(controls_scale.ForceFace_left=$("#ch22").prop('checked'))
      {

        redraw_Faces6();

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        };
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        mesh_TriFace1.children[0].material.visible=true;
        mesh_TriFace2.children[0].material.visible=false;
        mesh_TriFace3.children[0].material.visible=false;
        mesh_TriFace4.children[0].material.visible=false;

        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=true;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        }
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=false;
          text_group1.children[2].material.visible=false;
          text_group1.children[3].material.visible=false;

        }

        text_group2.children[0].material.visible=true;
        text_group2.children[1].material.visible=false;
        text_group2.children[2].material.visible=false;
        text_group2.children[3].material.visible=false;

        Tube_group.children[15].material.visible=false;
        Tube_group.children[21].material.visible=false;
        Tube_group.children[25].material.visible=false;
        Tube_group.children[10].material.visible=false;




        mesh_TriFace1.children[4].visible=true;
        mesh_TriFace2.children[4].visible=false;
        mesh_TriFace3.children[4].visible=false;
        mesh_TriFace4.children[4].visible=false;
        // controls_scale.Force_Arrow=false;


        //hide arrowa

        //hide normals


        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=true;
          mesh_TriFace2.children[i].visible=true;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        mesh_TriFace2.children[1].visible=false;
        mesh_TriFace2.children[2].visible=false;


        for(i=0;i<=11;i++){
          step_group_1_1.children[i].visible=false;
        }
          step_group_1_1.children[1].visible=true;
          step_group_1_1.children[0].visible=true;
          step_group_1_1.children[2].visible=true;


        for(i=0;i<=12;i++){
          step_group_2.children[i].visible=true;
        }

        for(i=0;i<=12;i++){
          step_group_2.children[i].visible=true;
        }
        step_group_2.children[6].visible=false;
        step_group_2.children[8].visible=false;

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }



        redraw_Faces6();



        //hide edges points

        Tube_group_right.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });


      }
      else
      {
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=true;
          text_group1.children[2].material.visible=true;
          text_group1.children[3].material.visible=true;

        }
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        for(i=0;i<=11;i++){
          step_group_1_1.children[i].visible=false;
        }
        Tube_group.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =true;
          }
        });

        for(i=0;i<=4;i++){
          text_group2.children[1].material.visible=true;
          text_group2.children[2].material.visible=true;
          text_group2.children[3].material.visible=true;

        }
        redraw();
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=true;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }


      }

    });

    $("#ch23").attr("checked",false);//on /off

    $("#ch23").change(function() {

      redraw();

      mesh_TriFace1.children[4].visible=false;
      mesh_TriFace2.children[4].visible=false;
      mesh_TriFace3.children[4].visible=false;
      mesh_TriFace4.children[4].visible=false;
      // controls_scale.Force_Arrow=false;


      //hide arrowa

      //hide normals

      mesh_TriFace1.children[5].visible=true;
      mesh_TriFace2.children[5].visible=true;
      mesh_TriFace3.children[5].visible=false;
      mesh_TriFace4.children[5].visible=false;

      mesh_TriFace1.children[6].visible=true;
      mesh_TriFace2.children[6].visible=true;
      mesh_TriFace3.children[6].visible=false;
      mesh_TriFace4.children[6].visible=false;





      //hide edges points

      Tube_group_right.traverse(function(obj) {//hide group
        if (obj.type === "Mesh") {
          obj.material.visible =false;
        }
      });

      //controls_scale.Control_Face=false;


      //show left

      redraw_Force();

      controls_scale.Step6=$("#ch23").prop('checked')

      if(controls_scale.ForceFace_left=$("#ch23").prop('checked'))
      {

        redraw_Faces6();

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        };
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        mesh_TriFace1.children[0].material.visible=true;
        mesh_TriFace2.children[0].material.visible=true;
        mesh_TriFace3.children[0].material.visible=false;
        mesh_TriFace4.children[0].material.visible=false;

        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=false;
          mesh_TriFace2.children[i].visible=false;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }

        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=false;
        }
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=false;
          text_group1.children[2].material.visible=false;
          text_group1.children[3].material.visible=false;

        }

        text_group2.children[0].material.visible=true;
        text_group2.children[1].material.visible=true;
        text_group2.children[2].material.visible=false;
        text_group2.children[3].material.visible=false;

        Tube_group.children[15].material.visible=false;
        Tube_group.children[21].material.visible=false;
        Tube_group.children[25].material.visible=false;
        Tube_group.children[10].material.visible=false;




        mesh_TriFace1.children[4].visible=true;
        mesh_TriFace2.children[4].visible=true;
        mesh_TriFace3.children[4].visible=false;
        mesh_TriFace4.children[4].visible=false;
        // controls_scale.Force_Arrow=false;


        //hide arrowa

        //hide normals


        for(i=1;i<=3;i++){
          mesh_TriFace1.children[i].visible=true;
          mesh_TriFace2.children[i].visible=true;
          mesh_TriFace3.children[i].visible=false;
          mesh_TriFace4.children[i].visible=false;
        }



        for(i=0;i<=12;i++){
          step_group_1_1.children[i].visible=false;
        }

        step_group_1_1.children[1].visible=true;
        step_group_1_1.children[0].visible=true;
        step_group_1_1.children[2].visible=true;
        step_group_1_1.children[12].visible=true;

        for(i=0;i<=12;i++){
          step_group_2.children[i].visible=true;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }



        redraw_Faces6();



        //hide edges points

        Tube_group_right.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =false;
          }
        });


      }
      else
      {
        for(i=0;i<=4;i++){
          text_group1.children[1].material.visible=true;
          text_group1.children[2].material.visible=true;
          text_group1.children[3].material.visible=true;

        }
        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;

        for(i=0;i<=12;i++){
          step_group_1_1.children[i].visible=false;
        }
        Tube_group.traverse(function(obj) {//hide group
          if (obj.type === "Mesh") {
            obj.material.visible =true;
          }
        });

        for(i=0;i<=4;i++){
          text_group2.children[1].material.visible=true;
          text_group2.children[2].material.visible=true;
          text_group2.children[3].material.visible=true;

        }
        redraw();
        for(i=0;i<=1;i++){
          mesh.children[i].material.visible=true;
        }

        for(i=0;i<=13;i++){
          step_group_1.children[i].visible=false;
        }


      }
        });

      $("#ch24").attr("checked",false);//on /off

      $("#ch24").change(function() {


        controls_scale.Step7=$("#ch24").prop('checked')

        if($("#ch24").prop('checked'))
        {

          redraw();


          for(i=0;i<=1;i++){
            mesh.children[i].material.visible=false;
          };
          mesh_left_ForceFace.children[0].material.visible=false;
          mesh_left_ForceFace.children[1].material.visible=false;

          mesh_TriFace1.children[0].material.visible=true;
          mesh_TriFace2.children[0].material.visible=true;
          mesh_TriFace3.children[0].material.visible=true;
          mesh_TriFace4.children[0].material.visible=true;

          for(i=1;i<=3;i++){
            mesh_TriFace1.children[i].visible=true;
            mesh_TriFace2.children[i].visible=true;
            mesh_TriFace3.children[i].visible=true;
            mesh_TriFace4.children[i].visible=true;
          }

          for(i=0;i<=4;i++){
            text_group1.children[1].material.visible=false;
            text_group1.children[2].material.visible=true;
            text_group1.children[3].material.visible=false;

          }

            text_group2.children[0].material.visible=true;
            text_group2.children[1].material.visible=true;
            text_group2.children[2].material.visible=true;
            text_group2.children[3].material.visible=true;




          Tube_group.children[15].material.visible=false;
          Tube_group.children[21].material.visible=true;
          Tube_group.children[25].material.visible=false;
          Tube_group.children[10].material.visible=false;




          mesh_TriFace1.children[4].visible=true;
          mesh_TriFace2.children[4].visible=true;
          mesh_TriFace3.children[4].visible=true;
          mesh_TriFace4.children[4].visible=true;


          for(i=1;i<=3;i++){
            mesh_TriFace1.children[i].visible=true;
            mesh_TriFace2.children[i].visible=true;
            mesh_TriFace3.children[i].visible=true;
            mesh_TriFace4.children[i].visible=true;
          }

          for(i=0;i<=9;i++){
            step_group_1_1.children[i].visible=false;
          }

          step_group_1_1.children[1].visible=true;
          step_group_1_1.children[0].visible=true;
          step_group_1_1.children[2].visible=true;
          step_group_1_1.children[12].visible=true;


          for(i=0;i<=12;i++){
            step_group_2.children[i].visible=false;
          }

          for(i=0;i<=13;i++){
            step_group_1.children[i].visible=false;
          }


          //hide edges points

          Tube_group_right.traverse(function(obj) {//hide group
            if (obj.type === "Mesh") {
              obj.material.visible =false;
            }
          });



                mesh_TriFace1.children[4].visible=true;
                mesh_TriFace2.children[4].visible=true;
                mesh_TriFace3.children[4].visible=true;
                mesh_TriFace4.children[4].visible=true;
                // controls_scale.Force_Arrow=false;


                //hide arrowa

                //hide normals

                mesh_TriFace1.children[5].visible=true;
                mesh_TriFace2.children[5].visible=true;
                mesh_TriFace3.children[5].visible=true;
                mesh_TriFace4.children[5].visible=true;
                mesh_TriFace1.children[6].visible=true;
                mesh_TriFace2.children[6].visible=true;
                mesh_TriFace3.children[6].visible=true;
                mesh_TriFace4.children[6].visible=true;


        }
        else
        {
          for(i=0;i<=4;i++){
            text_group1.children[1].material.visible=true;
            text_group1.children[2].material.visible=true;
            text_group1.children[3].material.visible=true;

          }

          for(i=0;i<=4;i++){
            text_group2.children[1].material.visible=true;
            text_group2.children[2].material.visible=true;
            text_group2.children[3].material.visible=true;

          }

          redraw();
          for(i=0;i<=1;i++){
            mesh.children[i].material.visible=true;
          }

          mesh_left_ForceFace.children[0].material.visible=false;
          mesh_left_ForceFace.children[1].material.visible=false;


          Tube_group.traverse(function(obj) {//hide group
            if (obj.type === "Mesh") {
              obj.material.visible =true;
            }
          });



        }

      });



    var TubePoints1 = [];
    TubePoints1.push(addControl(0,0,0));
    TubePoints1.push(addControl(0,0,1));


    var TubePoints2 = [];
    TubePoints2.push(addControl(0,0,0));
    TubePoints2.push(addControl(1,-1,-1));




    var TubePoints3 = [];
    TubePoints3.push(addControl(0,0,0));
    TubePoints3.push(addControl(-1.3660,-0.3660,-1));


 

    var TubePoints4 = [];
    TubePoints4.push(addControl(0,0,0));
    TubePoints4.push(addControl(0.3660,1.3660,-1));



    var P_A;


    var P_B;
    var P_C;
    var P_D;

    var L;

    var P_A_Right;
    var P_B_Right;
    var P_C_Right;
    var P_D_Right;

    var P_A_Left;
    var P_B_Left;
    var P_C_Left;
    var P_D_Left;

    var P_A_Left_Pair;
    var P_B_Left_Pair;
    var P_C_Left_Pair;
    var P_D_Left_Pair;






    var corePoint_temp=new THREE.Vector3(0,0,0);

    var mesh;

    var mesh_left_Cell1;
    var mesh_left_Cell2;
    var mesh_left_Cell3;
    var mesh_left_Cell4;


    var loader = new OBJLoader();
    loader.load(
      // resource URL
      './models/Hand.obj',
      // called when resource is loaded
      function (gltf) {
        scene.add(gltf);
        gltf.scale.set(0.2,0.2,0.2);
      }, undefined, function ( error ) {

        console.error( error );

      } );



      function initModel() {



        var geometry = new THREE.PlaneBufferGeometry( 2, 2 );
        // var planeMaterial = new THREE.MeshLambertMaterial( { color: 0xdddddd } );
        var planeMaterial = new THREE.MeshLambertMaterial({
          color: 0x9a9b9c,
          shading: THREE.SmoothShading,
          side: THREE.DoubleSide
        })

        //  var clipPlanes = new THREE.Mesh( geometry, planeMaterial);
        var clipPlanes = new THREE.Plane( new THREE.Vector3( 0, 0, 0.5 ), 0.1 );

        //        clipPlanes.position.set(0, 0, 0.5)
        //          scene.add( clipPlanes );




        L=3;

        Cal_ForcesPnt();
        Force_move();

        P_A_Right=Pnt_copy(P_A);
        P_B_Right=Pnt_copy(P_B);
        P_C_Right=Pnt_copy(P_C);
        P_D_Right=Pnt_copy(P_D);


        var vertices = [
          P_A_Right,P_B_Right,P_C_Right,P_D_Right
        ];

        corePoint_body=new THREE.Vector3();

        corePoint_body.x=(P_A_Right.x+P_B_Right.x+P_C_Right.x+P_D_Right.x)/4;
        corePoint_body.y=(P_A_Right.y+P_B_Right.y+P_C_Right.y+P_D_Right.y)/4;
        corePoint_body.z=(P_A_Right.z+P_B_Right.z+P_C_Right.z+P_D_Right.z)/4;

        var faces = [
          new THREE.Face3(0, 1, 2),
          new THREE.Face3(0, 2, 3),
          new THREE.Face3(0, 1, 3),
          new THREE.Face3(2, 3, 1)
        ];


        var geom = new THREE.Geometry();
        geom.vertices = vertices;
        geom.faces = faces;
        geom.computeFaceNormals();

        var arr_direction=arrow_direction(TubePoints1[1],TubePoints2[1],TubePoints3[1],TubePoints4[1]);


        var hex=0x006200;
        geom.faces[0].color.setHex(hex);



        if(arr_direction[0]<0 & arr_direction[1]<0 & arr_direction[2]<0 & arr_direction[3]<0)
        {

          for (i = 1;i<geom.faces.length;i++){

              var hex =0xC00000;
              geom.faces[i].color.setHex(hex);
            }

          }

        else
        {

          for (i = 1;i<geom.faces.length;i++){

              var hex =0x0F3150;
              geom.faces[i].color.setHex(hex);
            }

          }



        //  var materials = new THREE.MeshBasicMaterial( {
        // vertexColors: THREE.FaceColors
        // } );


        var materials = [
          //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
          new THREE.MeshBasicMaterial({color: "lightgrey", wireframe: true, transparent: true,opacity:0.001}),
          new THREE.MeshLambertMaterial({
            vertexColors: THREE.FaceColors,transparent: true,opacity:0.8,side:THREE.DoubleSide
          } )
        ];


        mesh = THREE.SceneUtils.createMultiMaterialObject(geom, materials);


        mesh.children.forEach(function (e) {
          e.geometry.vertices = vertices;
          e.geometry.verticesNeedUpdate = true;

          // e.geometry.faces[0].color.set(0xff00ee);
          // e.geometry.facesNeedUpdate=true;
          e.geometry.elementsNeedUpdate = true;
          e.geometry.computeFaceNormals();
          //e.geometry.center();
        });

        mesh.children[0].castShadow=true;
        mesh.children[0].receiveShadow=false;







        L=controls_scale.scale;

        Cal_ForcesPnt();
        Force_move_left();

        P_A_Left=Pnt_copy(P_A);
        P_B_Left=Pnt_copy(P_B);
        P_C_Left=Pnt_copy(P_C);
        P_D_Left=Pnt_copy(P_D);





        var vertices_left = [
          P_A_Left,P_B_Left,P_C_Left,P_D_Left
        ];

        var faces_left = [
          new THREE.Face3(0, 1, 2),
          new THREE.Face3(0, 1, 3),
          new THREE.Face3(2, 3, 1),
          new THREE.Face3(0, 2, 3)
        ];

        var faces_step = [
          new THREE.Face3(0, 1, 2),
          new THREE.Face3(0, 1, 3),
          new THREE.Face3(2, 3, 1),
          new THREE.Face3(0, 2, 3)

        ];

        var geom_left = new THREE.Geometry();
        geom_left.vertices = vertices_left;
        geom_left.faces = faces_left;
        geom_left.computeFaceNormals();

        var geom_step = new THREE.Geometry();
        geom_step.vertices = vertices_left;
        geom_step.faces = faces_step;
        geom_step.computeFaceNormals();


        for (i = 0;i<geom_left.faces.length;i++){
          var hex =0x156289;
          geom_left.faces[i].color.setHex(hex);
        }

        //  var materials = new THREE.MeshBasicMaterial( {
        // vertexColors: THREE.FaceColors
        // } );





        var materials_left = [
          //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
          new THREE.MeshBasicMaterial({color: "black", wireframe: true,transparent: true,opacity:0.5}),
          new THREE.MeshBasicMaterial( {
            vertexColors: THREE.FaceColors,transparent: true,opacity:0.1,side:THREE.DoubleSide,depthWrite:false
          } )
        ];

        var materials_step = [
          new THREE.MeshPhongMaterial({color: "black",transparent: true,opacity:0.5})
        ];


        mesh_left = new THREE.SceneUtils.createMultiMaterialObject(geom_left, materials_left);
        mesh_step = new THREE.SceneUtils.createMultiMaterialObject(geom_step, materials_step);



        mesh_left.children[0].castShadow=true;
        mesh_left.children[0].receiveShadow=true;

        scene.add(mesh_left);
        scene.add(mesh_step);




        L=controls_scale.MaxScale-controls_scale.scale;

        Cal_ForcesPnt();
        Force_move_left();

        P_A_Left_Pair=Pnt_copy(P_A);
        P_B_Left_Pair=Pnt_copy(P_B);
        P_C_Left_Pair=Pnt_copy(P_C);
        P_D_Left_Pair=Pnt_copy(P_D);





        var vertices_left_pair = [
          P_A_Left_Pair,P_B_Left_Pair,P_C_Left_Pair,P_D_Left_Pair
        ];

        var faces_left_pair = [
          new THREE.Face3(0, 1, 2),
          new THREE.Face3(0, 1, 3),
          new THREE.Face3(2, 3, 1),
          new THREE.Face3(0, 2, 3)
        ];

        var geom_left_pair = new THREE.Geometry();
        geom_left_pair.vertices = vertices_left_pair;
        geom_left_pair.faces = faces_left_pair;
        geom_left_pair.computeFaceNormals();


        for (i = 0;i<geom_left_pair.faces.length;i++){
          var hex =0x156289;
          geom_left_pair.faces[i].color.setHex(hex);
        }

        //  var materials = new THREE.MeshBasicMaterial( {
        // vertexColors: THREE.FaceColors
        // } );





        var materials_left_pair = [
          //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
          new THREE.MeshBasicMaterial({color: "black", wireframe: true,transparent: true,opacity:0.5}),
          new THREE.MeshBasicMaterial( {
            vertexColors: THREE.FaceColors,transparent: true,opacity:0.1,side:THREE.DoubleSide,depthWrite:false
          } )
        ];


        mesh_left_pair = new THREE.SceneUtils.createMultiMaterialObject(geom_left_pair, materials_left_pair);


        mesh_left_pair.children[0].castShadow=true;
        // mesh_left_pair.children[0].receiveShadow=true;

        scene2.add(mesh_left_pair);








        var vertices_ForceFace = [
          new THREE.Vector3(0,0,0),TubePoints1[1],TubePoints2[1],TubePoints3[1],TubePoints4[1]
        ];

        var faces_left_ForceFace = [
          new THREE.Face3(0, 1, 2),
          new THREE.Face3(0, 1, 3),
          new THREE.Face3(0, 1, 4),
          new THREE.Face3(0, 2, 3),
          new THREE.Face3(0, 2, 4),
          new THREE.Face3(0, 3, 4)

        ];

        var geom_left_ForceFace = new THREE.Geometry();
        geom_left_ForceFace.vertices = vertices_ForceFace;
        geom_left_ForceFace.faces = faces_left_ForceFace;
        geom_left_ForceFace.computeFaceNormals();

        geom_left_ForceFace.faces[0].color.setHex(0x008000);
        geom_left_ForceFace.faces[1].color.setHex(0x008000);
        geom_left_ForceFace.faces[2].color.setHex(0x008000);


        for (i = 3;i<geom_left_ForceFace.faces.length;i++){
          var hex =0xCCCCCC;
          geom_left_ForceFace.faces[i].color.setHex(hex);
        }

        //  var materials = new THREE.MeshBasicMaterial( {
        // vertexColors: THREE.FaceColors
        // } );





        var materials_left_ForceFace = [
          //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
          new THREE.MeshBasicMaterial({color: "grey", wireframe: true,transparent: true,opacity:0.1}),
          new THREE.MeshBasicMaterial( {
            vertexColors: THREE.FaceColors,transparent: true,opacity:0.3,side:THREE.DoubleSide,depthWrite:false
          } )
        ];


        mesh_left_ForceFace = new THREE.SceneUtils.createMultiMaterialObject(geom_left_ForceFace, materials_left_ForceFace);



        scene.add(mesh_left_ForceFace);

        mesh_left_ForceFace.children[0].material.visible=false;
        mesh_left_ForceFace.children[1].material.visible=false;







        var Cell_left_ForceFace1 = [
          new THREE.Face3(0, 1, 4),
          new THREE.Face3(0, 1, 2),
          new THREE.Face3(0, 2, 4)
        ];

        var Cell_Test = [
          new THREE.Face3(1, 2, 4),

        ];

        var geom_left_ForceFace1 = new THREE.Geometry();
        geom_left_ForceFace1.vertices = vertices_ForceFace;
        geom_left_ForceFace1.faces = Cell_left_ForceFace1;
        geom_left_ForceFace1.computeFaceNormals();

        var geom_Cell_Test = new THREE.Geometry();
        geom_Cell_Test.vertices = vertices_ForceFace;
        geom_Cell_Test.faces = Cell_Test;
        geom_Cell_Test.computeFaceNormals();

        var materials_geom_Cell_Test = new THREE.MeshPhongMaterial( {
          color: "grey",transparent: true,opacity:0.2,side:THREE.DoubleSide,depthWrite:false})

          var Cell_test_1 = new THREE.Mesh(geom_Cell_Test, materials_geom_Cell_Test);

          Cell_test_1.scale.set(0.7,0.7,0.7);

          //      scene.add(Cell_test_1);

          for (i = 0;i<geom_left_ForceFace1.faces.length;i++){
            var hex =0xCCCCCC;
            geom_left_ForceFace1.faces[i].color.setHex(hex);
          }

          //  var materials = new THREE.MeshBasicMaterial( {
          // vertexColors: THREE.FaceColors
          // } );

          var materials_left_Cell1 = [
            //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
            new THREE.MeshBasicMaterial({color: "white", wireframe: true,transparent: true,opacity:0.01}),
            new THREE.MeshPhongMaterial( {
              vertexColors: THREE.FaceColors,transparent: true,opacity:0.7,side:THREE.DoubleSide,depthWrite:false,
              //clippingPlanes:[clipPlanes],
              //clipIntersection: true
            } )
          ];


          mesh_left_Cell1 = new THREE.SceneUtils.createMultiMaterialObject(geom_left_ForceFace1, materials_left_Cell1);

          var Cell_left_ForceFace2 = [
            new THREE.Face3(0, 1, 3),
            new THREE.Face3(0, 1, 2),
            new THREE.Face3(0, 2, 3)

          ];

          var geom_left_ForceFace2= new THREE.Geometry();
          geom_left_ForceFace2.vertices = vertices_ForceFace;
          geom_left_ForceFace2.faces = Cell_left_ForceFace2;
          geom_left_ForceFace2.computeFaceNormals();


          for (i = 0;i<geom_left_ForceFace2.faces.length;i++){
            var hex =0xCCCCCC;
            geom_left_ForceFace2.faces[i].color.setHex(hex);
          }


          var materials_left_Cell2 = [
            //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
            new THREE.MeshBasicMaterial({color: "white", wireframe: true,transparent: true,opacity:0.1}),
            new THREE.MeshBasicMaterial( {
              vertexColors: THREE.FaceColors,transparent: true,opacity:0.7,side:THREE.DoubleSide,depthWrite:false,
              // clippingPlanes:[clipPlanes],
              //clipIntersection: true
            } )
          ];


          mesh_left_Cell2 = new THREE.SceneUtils.createMultiMaterialObject(geom_left_ForceFace2, materials_left_Cell2);


          var Cell_left_ForceFace3 = [
            new THREE.Face3(0, 1, 4),
            new THREE.Face3(0, 1, 3),
            new THREE.Face3(0, 3, 4)

          ];

          var geom_left_ForceFace3= new THREE.Geometry();
          geom_left_ForceFace3.vertices = vertices_ForceFace;
          geom_left_ForceFace3.faces = Cell_left_ForceFace3;
          geom_left_ForceFace3.computeFaceNormals();


          for (i = 0;i<geom_left_ForceFace3.faces.length;i++){
            var hex =0xCCCCCC;
            geom_left_ForceFace3.faces[i].color.setHex(hex);
          }


          var materials_left_Cell3 = [
            //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
            new THREE.MeshBasicMaterial({color: "white", wireframe: true,transparent: true,opacity:0.1}),
            new THREE.MeshBasicMaterial( {
              vertexColors: THREE.FaceColors,transparent: true,opacity:0.7,side:THREE.DoubleSide,depthWrite:false,
              //  clippingPlanes:[clipPlanes],
              // clipIntersection: true
            } )
          ];


          mesh_left_Cell3 = new THREE.SceneUtils.createMultiMaterialObject(geom_left_ForceFace3, materials_left_Cell3);

          var Cell_left_ForceFace4 = [
            new THREE.Face3(0, 2, 3),
            new THREE.Face3(0, 2, 4),
            new THREE.Face3(0, 3, 4)

          ];

          var geom_left_ForceFace4= new THREE.Geometry();
          geom_left_ForceFace4.vertices = vertices_ForceFace;
          geom_left_ForceFace4.faces = Cell_left_ForceFace4;
          geom_left_ForceFace4.computeFaceNormals();


          for (i = 0;i<geom_left_ForceFace4.faces.length;i++){
            var hex =0xCCCCCC;
            geom_left_ForceFace4.faces[i].color.setHex(hex);
          }


          var materials_left_Cell4 = [
            //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
            new THREE.MeshBasicMaterial({color: "white", wireframe: true,transparent: true,opacity:0.1}),
            new THREE.MeshBasicMaterial( {
              vertexColors: THREE.FaceColors,transparent: true,opacity:0.7,side:THREE.DoubleSide,depthWrite:false
            } )
          ];


          mesh_left_Cell4 = new THREE.SceneUtils.createMultiMaterialObject(geom_left_ForceFace4, materials_left_Cell4);

    

          mesh_left_Cell1.scale.set(0.7,0.7,0.7);
          mesh_left_Cell2.scale.set(0.7,0.7,0.7);
          mesh_left_Cell3.scale.set(0.7,0.7,0.7);
          mesh_left_Cell4.scale.set(0.7,0.7,0.7);


          mesh_left_Cell1.position.set(0.2,0,-0.05);

          mesh_left_Cell2.position.set(0,-0.2,-0.05);

          mesh_left_Cell3.position.set(-0.15,0.2,-0.05);

          mesh_left_Cell4.position.set(0,0,-0.2);

          scene.add(mesh_left_Cell1);
          scene.add(mesh_left_Cell2);
          scene.add(mesh_left_Cell3);
          //   scene.add(mesh_left_Cell4);

          for(i=0;i<2;i++)
          {
            mesh_left_Cell1.children[i].material.visible=false;
            mesh_left_Cell2.children[i].material.visible=false;
            mesh_left_Cell3.children[i].material.visible=false;
            mesh_left_Cell4.children[i].material.visible=false;

          }









          redraw();

          redraw_Force();

          redraw_right();

          Tube_group_right.traverse(function(obj) {//hide group
            if (obj.type === "Mesh") {
              obj.material.visible =false;
            }
          });





          // Transform control (a triad)
          trfm_ctrl = new THREE.TransformControls(camera, renderer.domElement);
          trfm_ctrl.addEventListener('change', render);

          trfm_ctrl.addEventListener('objectChange', function(e) {

            if(Math.abs(selectObj.position.x)<=2&&Math.abs(selectObj.position.y)<=2&&Math.abs(selectObj.position.z)<=2)
            {

              // if(selectObj.name.charAt(2)==='1')
              // {
              //   TubePoints1[1].x=selectObj.position.x;
              //   TubePoints1[1].y=selectObj.position.y;
              //   TubePoints1[1].z=selectObj.position.z;

              //   console.log("TubePoints1="+TubePoints1[1].z);

              // }

              if(selectObj.name.charAt(2)==='2')
              {
                TubePoints2[1].x=selectObj.position.x;
                TubePoints2[1].y=selectObj.position.y;
                TubePoints2[1].z=selectObj.position.z;

                console.log("TubePoints2="+TubePoints2[1].z);

              }
              if(selectObj.name.charAt(2)==='3')
              {
                TubePoints3[1].x=selectObj.position.x;
                TubePoints3[1].y=selectObj.position.y;
                TubePoints3[1].z=selectObj.position.z;

                console.log("TubePoints3="+TubePoints3[1].z);

              }
              if(selectObj.name.charAt(2)==='4')
              {
                TubePoints4[1].x=selectObj.position.x;
                TubePoints4[1].y=selectObj.position.y;
                TubePoints4[1].z=selectObj.position.z;

                console.log("TubePoints4="+TubePoints4[1].z);

              }

              redraw();
              if(controls_scale.Scale_face)
              redraw_Force();
              if(controls_scale.Control_Face)
              redraw_right();
              if(controls_scale.ForceFace_left)
              redraw_Faces6();
              if(controls_scale.Cell_Faces)
              redraw_Cell();
              if($("#ch6").prop('checked'))
              {
                redraw();
              mesh_TriFace_step_f1.children[0].material.visible=false;
              mesh_TriFace_step_f1.children[6].material.visible=false;
              mesh_TriFace_step_f2.children[6].material.visible=false;
              mesh_TriFace_step_f21.children[0].material.visible=false;
              mesh_TriFace_step_f21.children[6].material.visible=false;
              mesh_TriFace_step_f3.children[0].material.visible=false;
              mesh_TriFace_step_f3.children[6].material.visible=false;
              mesh_TriFace_step_f4.children[0].material.visible=false;
              mesh_TriFace_step_f4.children[6].material.visible=false;
              }
              if($("#ch18").prop('checked') & controls_scale.Step1)
              {
                redraw();

                mesh_TriFace_step_f1.children[0].material.visible=false;
                mesh_TriFace_step_f1.children[6].material.visible=false;


                mesh_TriFace_step_f2.children[6].material.visible=false;

                mesh_TriFace_step_f21.children[0].material.visible=false;
                mesh_TriFace_step_f21.children[6].material.visible=false;

                mesh_TriFace_step_f3.children[0].material.visible=false;
                mesh_TriFace_step_f3.children[6].material.visible=false;

                mesh_TriFace_step_f4.children[0].material.visible=false;
                mesh_TriFace_step_f4.children[6].material.visible=false;

                text_group2.children[0].material.visible=false;
                text_group2.children[1].material.visible=false;
                text_group2.children[2].material.visible=false;
                text_group2.children[3].material.visible=false;
                text_group2.children[4].material.visible=false;
                text_group2.children[5].material.visible=false;
                text_group2.children[6].material.visible=false;
                text_group2.children[7].material.visible=false;
                text_group2.children[8].material.visible=false;


                Tube_group.children[15].material.visible=false;
                Tube_group.children[21].material.visible=false;
                Tube_group.children[25].material.visible=false;
                Tube_group.children[10].material.visible=false;

                for(i=0;i<=4;i++){
                  text_group1.children[1].material.visible=false;
                  text_group1.children[2].material.visible=false;
                  text_group1.children[3].material.visible=false;
                }
                for(i=0;i<=4;i++){
                  text_group2.children[i].material.visible=false;
                }
                for(i=0;i<=6;i++){
                mesh_TriFace1.children[i].visible=false;
                mesh_TriFace2.children[i].visible=false;
                mesh_TriFace3.children[i].visible=false;
                mesh_TriFace4.children[i].visible=false;
                }
              }
              if($("#ch18").prop('checked') & controls_scale.Step2)
              {
                redraw();

                mesh_TriFace_step_f1.children[0].material.visible=false;
                mesh_TriFace_step_f1.children[6].material.visible=false;


                mesh_TriFace_step_f2.children[6].material.visible=false;

                mesh_TriFace_step_f21.children[0].material.visible=false;
                mesh_TriFace_step_f21.children[6].material.visible=false;

                mesh_TriFace_step_f3.children[0].material.visible=false;
                mesh_TriFace_step_f3.children[6].material.visible=false;

                mesh_TriFace_step_f4.children[0].material.visible=false;
                mesh_TriFace_step_f4.children[6].material.visible=false;

                text_group2.children[0].material.visible=false;
                text_group2.children[1].material.visible=false;
                text_group2.children[2].material.visible=false;
                text_group2.children[3].material.visible=false;
                text_group2.children[4].material.visible=false;
                text_group2.children[5].material.visible=false;
                text_group2.children[6].material.visible=false;
                text_group2.children[7].material.visible=false;
                text_group2.children[8].material.visible=false;

                Tube_group.children[15].material.visible=false;
                Tube_group.children[21].material.visible=false;
                Tube_group.children[25].material.visible=false;
                Tube_group.children[10].material.visible=false;

                for(i=0;i<=4;i++){
                  text_group1.children[1].material.visible=false;
                  text_group1.children[2].material.visible=false;
                  text_group1.children[3].material.visible=false;
                }
                for(i=0;i<=4;i++){
                  text_group2.children[i].material.visible=false;
                }
                for(i=0;i<=6;i++){
                mesh_TriFace1.children[i].visible=false;
                mesh_TriFace2.children[i].visible=false;
                mesh_TriFace3.children[i].visible=false;
                mesh_TriFace4.children[i].visible=false;
                }
                step_group_cell.children[0].visible=true;
                step_group_cell.children[1].visible=true;
                step_group_cell.children[2].visible=true;
                step_group_cell.children[3].visible=true;
                step_group_cell.children[4].material.visible=true;
                step_group_cell.children[5].material.visible=true;
                step_group_cell.children[6].material.visible=true;
                step_group_cell.children[7].material.visible=true;
              }

              if(controls_scale.Stepcell)
              {
                redraw();

                step_group_cell.children[0].visible=true;
                step_group_cell.children[1].visible=true;
                step_group_cell.children[2].visible=true;
                step_group_cell.children[3].visible=true;
                step_group_cell.children[4].material.visible=true;
                step_group_cell.children[5].material.visible=true;
                step_group_cell.children[6].material.visible=true;
                step_group_cell.children[7].material.visible=true;
                step_group_1_1.children[1].visible=true;
                step_group_1_1.children[0].visible=true;
                step_group_1_1.children[2].visible=true;
                step_group_1_1.children[12].visible=true;


              }

              if($("#ch18").prop('checked') & controls_scale.Step3)
              {
                redraw();

                mesh_TriFace_step_f1.children[0].material.visible=false;
                mesh_TriFace_step_f1.children[6].material.visible=false;


                mesh_TriFace_step_f2.children[6].material.visible=false;

                mesh_TriFace_step_f21.children[0].material.visible=false;
                mesh_TriFace_step_f21.children[6].material.visible=false;

                mesh_TriFace_step_f3.children[0].material.visible=false;
                mesh_TriFace_step_f3.children[6].material.visible=false;

                mesh_TriFace_step_f4.children[0].material.visible=false;
                mesh_TriFace_step_f4.children[6].material.visible=false;

                text_group2.children[0].material.visible=false;
                text_group2.children[1].material.visible=false;
                text_group2.children[2].material.visible=false;
                text_group2.children[3].material.visible=false;
                text_group2.children[4].material.visible=false;
                text_group2.children[5].material.visible=false;
                text_group2.children[6].material.visible=false;
                text_group2.children[7].material.visible=false;
                text_group2.children[8].material.visible=false;

                Tube_group.children[15].material.visible=false;
                Tube_group.children[21].material.visible=false;
                Tube_group.children[25].material.visible=false;
                Tube_group.children[10].material.visible=false;

                for(i=0;i<=4;i++){
                  text_group1.children[1].material.visible=false;
                  text_group1.children[2].material.visible=false;
                  text_group1.children[3].material.visible=false;
                }
                for(i=0;i<=4;i++){
                  text_group2.children[i].material.visible=false;
                }
                for(i=0;i<=6;i++){
                mesh_TriFace1.children[i].visible=false;
                mesh_TriFace2.children[i].visible=false;
                mesh_TriFace3.children[i].visible=false;
                mesh_TriFace4.children[i].visible=false;
                }
                step_group_1_1.children[4].visible=true;
                step_group_1_1.children[1].visible=true;
                step_group_1_1.children[0].visible=true;
                step_group_1_1.children[10].visible=true;

                for(i=0;i<=12;i++){
                  step_group_2.children[i].visible=false;
                }

                for(i=0;i<=13;i++){
                  step_group_1.children[i].visible=true;
                }
                step_group_1.children[4].visible=false;
                step_group_1.children[2].visible=false;
              }

              if($("#ch18").prop('checked') & controls_scale.Step4)
              {
                redraw();

                mesh_TriFace_step_f1.children[0].material.visible=false;
                mesh_TriFace_step_f1.children[6].material.visible=false;


                mesh_TriFace_step_f2.children[6].material.visible=false;

                mesh_TriFace_step_f21.children[0].material.visible=false;
                mesh_TriFace_step_f21.children[6].material.visible=false;

                mesh_TriFace_step_f3.children[0].material.visible=false;
                mesh_TriFace_step_f3.children[6].material.visible=false;

                mesh_TriFace_step_f4.children[0].material.visible=false;
                mesh_TriFace_step_f4.children[6].material.visible=false;

                text_group2.children[0].material.visible=false;
                text_group2.children[1].material.visible=false;
                text_group2.children[2].material.visible=false;
                text_group2.children[3].material.visible=false;
                text_group2.children[4].material.visible=false;
                text_group2.children[5].material.visible=false;
                text_group2.children[6].material.visible=false;
                text_group2.children[7].material.visible=false;
                text_group2.children[8].material.visible=false;

                Tube_group.children[15].material.visible=false;
                Tube_group.children[21].material.visible=false;
                Tube_group.children[25].material.visible=false;
                Tube_group.children[10].material.visible=false;

                for(i=0;i<=4;i++){
                  text_group1.children[1].material.visible=false;
                  text_group1.children[2].material.visible=false;
                  text_group1.children[3].material.visible=false;
                }
                for(i=0;i<=4;i++){
                  text_group2.children[i].material.visible=false;
                }
                for(i=0;i<=6;i++){
                mesh_TriFace1.children[i].visible=false;
                mesh_TriFace2.children[i].visible=false;
                mesh_TriFace3.children[i].visible=false;
                mesh_TriFace4.children[i].visible=false;
                }
                for(i=0;i<=11;i++){
                  step_group_1_1.children[i].visible=true;
                }
                step_group_1_1.children[4].visible=false;

                for(i=0;i<=12;i++){
                  step_group_2.children[i].visible=false;
                }

                for(i=0;i<=13;i++){
                  step_group_1.children[i].visible=true;
                }
              }

              if($("#ch18").prop('checked') & controls_scale.Step5)
              {
                redraw();

                mesh_TriFace_step_f1.children[0].material.visible=false;
                mesh_TriFace_step_f1.children[6].material.visible=false;


                mesh_TriFace_step_f2.children[6].material.visible=false;

                mesh_TriFace_step_f21.children[0].material.visible=false;
                mesh_TriFace_step_f21.children[6].material.visible=false;

                mesh_TriFace_step_f3.children[0].material.visible=false;
                mesh_TriFace_step_f3.children[6].material.visible=false;

                mesh_TriFace_step_f4.children[0].material.visible=false;
                mesh_TriFace_step_f4.children[6].material.visible=false;

                text_group2.children[0].material.visible=false;
                text_group2.children[1].material.visible=false;
                text_group2.children[2].material.visible=false;
                text_group2.children[3].material.visible=false;
                text_group2.children[4].material.visible=false;
                text_group2.children[5].material.visible=false;
                text_group2.children[6].material.visible=false;
                text_group2.children[7].material.visible=false;
                text_group2.children[8].material.visible=false;

                Tube_group.children[15].material.visible=false;
                Tube_group.children[21].material.visible=false;
                Tube_group.children[25].material.visible=false;
                Tube_group.children[10].material.visible=false;

                for(i=0;i<=4;i++){
                  text_group1.children[1].material.visible=false;
                  text_group1.children[2].material.visible=false;
                  text_group1.children[3].material.visible=false;
                }
                for(i=0;i<=4;i++){
                  text_group2.children[i].material.visible=false;
                }
                for(i=0;i<=6;i++){
                mesh_TriFace1.children[i].visible=false;
                mesh_TriFace2.children[i].visible=false;
                mesh_TriFace3.children[i].visible=false;
                mesh_TriFace4.children[i].visible=false;
                }

                mesh_TriFace1.children[0].material.visible=true;


                for(i=0;i<=1;i++){
                  mesh.children[i].material.visible=false;
                }
                for(i=0;i<=4;i++){
                  text_group1.children[1].material.visible=false;
                  text_group1.children[2].material.visible=false;
                  text_group1.children[3].material.visible=false;

                }

                text_group2.children[0].material.visible=true;
                text_group2.children[1].material.visible=false;
                text_group2.children[2].material.visible=false;
                text_group2.children[3].material.visible=false;

                Tube_group.children[15].material.visible=false;
                Tube_group.children[21].material.visible=false;
                Tube_group.children[25].material.visible=false;
                Tube_group.children[10].material.visible=false;


                mesh_TriFace1.children[4].visible=true;
                mesh_TriFace2.children[4].visible=false;
                mesh_TriFace3.children[4].visible=false;
                mesh_TriFace4.children[4].visible=false;

                mesh_TriFace1.children[5].material.visible=true;
                mesh_TriFace1.children[6].visible=true;

                for(i=0;i<=3;i++){
                  mesh_TriFace1.children[i].visible=true;
                  mesh_TriFace2.children[i].visible=true;
                  mesh_TriFace3.children[i].visible=false;
                  mesh_TriFace4.children[i].visible=false;
                }

                mesh_TriFace2.children[1].visible=false;
                mesh_TriFace2.children[2].visible=false;


                for(i=0;i<=11;i++){
                  step_group_1_1.children[i].visible=false;
                }
                  step_group_1_1.children[1].visible=true;
                  step_group_1_1.children[0].visible=true;
                  step_group_1_1.children[2].visible=true;


                for(i=0;i<=12;i++){
                  step_group_2.children[i].visible=true;
                }

                step_group_2.children[6].visible=false;
                step_group_2.children[8].visible=false;
              }
            }

            if($("#ch18").prop('checked') & controls_scale.Step6)
            {
              redraw();

              mesh_TriFace_step_f1.children[0].material.visible=false;
              mesh_TriFace_step_f1.children[6].material.visible=false;


              mesh_TriFace_step_f2.children[6].material.visible=false;

              mesh_TriFace_step_f21.children[0].material.visible=false;
              mesh_TriFace_step_f21.children[6].material.visible=false;

              mesh_TriFace_step_f3.children[0].material.visible=false;
              mesh_TriFace_step_f3.children[6].material.visible=false;

              mesh_TriFace_step_f4.children[0].material.visible=false;
              mesh_TriFace_step_f4.children[6].material.visible=false;

              text_group2.children[0].material.visible=false;
              text_group2.children[1].material.visible=false;
              text_group2.children[2].material.visible=false;
              text_group2.children[3].material.visible=false;
              text_group2.children[4].material.visible=false;
              text_group2.children[5].material.visible=false;
              text_group2.children[6].material.visible=false;
              text_group2.children[7].material.visible=false;
              text_group2.children[8].material.visible=false;

              Tube_group.children[15].material.visible=false;
              Tube_group.children[21].material.visible=false;
              Tube_group.children[25].material.visible=false;
              Tube_group.children[10].material.visible=false;

              for(i=0;i<=4;i++){
                text_group1.children[1].material.visible=false;
                text_group1.children[2].material.visible=false;
                text_group1.children[3].material.visible=false;
              }
              for(i=0;i<=4;i++){
                text_group2.children[i].material.visible=false;
              }
              for(i=0;i<=6;i++){
              mesh_TriFace1.children[i].visible=true;
              mesh_TriFace2.children[i].visible=true;
              mesh_TriFace3.children[i].visible=false;
              mesh_TriFace4.children[i].visible=false;
              }

              mesh_TriFace1.children[0].material.visible=true;
              mesh_TriFace2.children[0].material.visible=true;


              for(i=0;i<=1;i++){
                mesh.children[i].material.visible=false;
              }
              for(i=0;i<=4;i++){
                text_group1.children[1].material.visible=false;
                text_group1.children[2].material.visible=false;
                text_group1.children[3].material.visible=false;

              }

              text_group2.children[0].material.visible=true;
              text_group2.children[1].material.visible=true;
              text_group2.children[2].material.visible=false;
              text_group2.children[3].material.visible=false;

              Tube_group.children[15].material.visible=false;
              Tube_group.children[21].material.visible=false;
              Tube_group.children[25].material.visible=false;
              Tube_group.children[10].material.visible=false;


              mesh_TriFace1.children[4].visible=true;
              mesh_TriFace2.children[4].visible=true;
              mesh_TriFace3.children[4].visible=false;
              mesh_TriFace4.children[4].visible=false;

              mesh_TriFace1.children[5].material.visible=true;
              mesh_TriFace1.children[6].visible=true;

              for(i=0;i<=3;i++){
                mesh_TriFace1.children[i].visible=true;
                mesh_TriFace2.children[i].visible=true;
                mesh_TriFace3.children[i].visible=false;
                mesh_TriFace4.children[i].visible=false;
              }



              for(i=0;i<=11;i++){
                step_group_1_1.children[i].visible=false;
              }
              step_group_1_1.children[1].visible=true;
              step_group_1_1.children[0].visible=true;
              step_group_1_1.children[2].visible=true;
              step_group_1_1.children[12].visible=true;


              for(i=0;i<=12;i++){
                step_group_2.children[i].visible=true;
              }

            }

            if($("#ch18").prop('checked') & controls_scale.Step7)
            {
              redraw();

              mesh_TriFace_step_f1.children[0].material.visible=false;
              mesh_TriFace_step_f1.children[6].material.visible=false;


              mesh_TriFace_step_f2.children[6].material.visible=false;

              mesh_TriFace_step_f21.children[0].material.visible=false;
              mesh_TriFace_step_f21.children[6].material.visible=false;

              mesh_TriFace_step_f3.children[0].material.visible=false;
              mesh_TriFace_step_f3.children[6].material.visible=false;

              mesh_TriFace_step_f4.children[0].material.visible=false;
              mesh_TriFace_step_f4.children[6].material.visible=false;

              text_group2.children[0].material.visible=false;
              text_group2.children[1].material.visible=false;
              text_group2.children[2].material.visible=false;
              text_group2.children[3].material.visible=false;
              text_group2.children[4].material.visible=false;
              text_group2.children[5].material.visible=false;
              text_group2.children[6].material.visible=false;
              text_group2.children[7].material.visible=false;
              text_group2.children[8].material.visible=false;

              for(i=0;i<=4;i++){
                text_group1.children[1].material.visible=false;
                text_group1.children[2].material.visible=false;
                text_group1.children[3].material.visible=false;
              }
              for(i=0;i<=4;i++){
                text_group2.children[i].material.visible=false;
              }
              for(i=0;i<=6;i++){
              mesh_TriFace1.children[i].visible=true;
              mesh_TriFace2.children[i].visible=true;
              mesh_TriFace3.children[i].visible=true;
              mesh_TriFace4.children[i].visible=true;
              }

              mesh_TriFace1.children[0].material.visible=true;
              mesh_TriFace4.children[0].material.visible=true;
              mesh_TriFace_step_f2.children[0].material.visible=true;


              for(i=0;i<=1;i++){
                mesh.children[i].material.visible=false;
              }
              for(i=0;i<=4;i++){
                text_group1.children[1].material.visible=false;
                text_group1.children[2].material.visible=true;
                text_group1.children[3].material.visible=false;

              }

              text_group2.children[0].material.visible=true;
              text_group2.children[1].material.visible=true;
              text_group2.children[2].material.visible=true;
              text_group2.children[3].material.visible=true;

              Tube_group.children[15].material.visible=false;
              Tube_group.children[21].material.visible=true;
              Tube_group.children[25].material.visible=false;
              Tube_group.children[10].material.visible=false;


              mesh_TriFace1.children[4].visible=true;
              mesh_TriFace2.children[4].visible=true;
              mesh_TriFace3.children[4].visible=true;
              mesh_TriFace4.children[4].visible=true;

              mesh_TriFace1.children[5].material.visible=true;
              mesh_TriFace1.children[6].visible=true;

              for(i=0;i<=3;i++){
                mesh_TriFace1.children[i].visible=true;
                mesh_TriFace2.children[i].visible=true;
                mesh_TriFace3.children[i].visible=true;
                mesh_TriFace4.children[i].visible=true;
              }



              for(i=0;i<=11;i++){
                step_group_1_1.children[i].visible=false;
              }
              step_group_1_1.children[1].visible=true;
              step_group_1_1.children[0].visible=true;
              step_group_1_1.children[2].visible=true;
              step_group_1_1.children[12].visible=true;


              for(i=0;i<=12;i++){
                step_group_2.children[i].visible=false;
              }

            }
            //render();
          });

          trfm_ctrl.addEventListener('mouseDown', (evt) => {

            orbit_ctrl.enabled = false;
            if(controls_scale.Pair_Control)
            {

              for(i=0;i<=1;i++){
                mesh_F1_pair.children[i].material.visible=false;
                mesh_F2_pair.children[i].material.visible=false;
                mesh_F3_pair.children[i].material.visible=false;
                mesh_F4_pair.children[i].material.visible=false;
                mesh_left_pair.children[i].material.visible=false;
              }

              redraw();
              for(i=0;i<=1;i++){
                mesh.children[i].material.visible=true;
              }


              Tube_group_pair.traverse(function(obj) {//hide group
                if (obj.type === "Mesh") {
                  obj.material.visible =false;
                }
              });

              for(i=0;i<=1;i++){
                mesh_F1.children[i].material.visible=false;
                mesh_F2.children[i].material.visible=false;
                mesh_F3.children[i].material.visible=false;
                mesh_F4.children[i].material.visible=false;
                mesh_left.children[i].material.visible=false;
              }
            }



          });
          trfm_ctrl.addEventListener('mouseUp', (evt) => {
        
            orbit_ctrl.enabled = true;
          });





          scene.add(trfm_ctrl);

 
          document.addEventListener('mousedown', onMouseDown);
          document.addEventListener('mouseup', onMouseUp);
          document.addEventListener('mousemove', onMouseMove);

          document.oncontextmenu = function (event) {
            event.preventDefault();
          };



          var ambient = new THREE.AmbientLight(0xffffff );
          scene.add( ambient );
          scene2.add( ambient.clone() );

          var light = new THREE.DirectionalLight( 0xffffff );
          // light.position.set( 1, 1, 1 ).normalize();
          light.position.set( 0, 0, 20 );
          light.shadow.camera.left = -30; // or whatever value works for the scale of your scene
          light.shadow.camera.right = 30;
          light.shadow.camera.top = 30;
          light.shadow.camera.bottom = -30;
          light.shadow.camera.near = 0.01;
          light.shadow.camera.far = 100;
          light.castShadow = true;
          light.shadowMapHeight=4096;
          light.shadowMapWidth=4096;
          //light.shadow.map.width=512;
          //light.shadow.map.height=1000;

          scene.add( light );
          scene2.add( light.clone() );

          // var helper = new THREE.CameraHelper( light.shadow.camera );
          // scene1.add( helper );


          // ground plane for shadow effects
          var FLOOR = - 2.5;
          var geometry = new THREE.PlaneBufferGeometry( 100, 100 );
          // var planeMaterial = new THREE.MeshLambertMaterial( { color: 0xdddddd } );
          var planeMaterial = new THREE.ShadowMaterial();
          planeMaterial.opacity = 0.2;
          var ground = new THREE.Mesh( geometry, planeMaterial);
          ground.position.set( 0, 0, FLOOR);
          ground.rotation.x = 0;
          ground.scale.set( 100, 100, 100 );
          ground.castShadow = false;
          ground.receiveShadow = true;
          scene.add( ground );
          scene2.add( ground.clone() );




          for(i=0;i<=1;i++){

            mesh_left.children[i].material.visible=false;
          }
          mesh_F1.children[0].material.visible=false;
          mesh_F2.children[0].material.visible=false;
          mesh_F3.children[0].material.visible=false;
          mesh_F4.children[0].material.visible=false;
          for(i=0;i<=1;i++){




            mesh_left_pair.children[i].material.visible=false;
          }



          mesh_TriFace1.children[0].material.visible=false;
          mesh_TriFace2.children[0].material.visible=false;
          mesh_TriFace3.children[0].material.visible=false;
          mesh_TriFace4.children[0].material.visible=false;

          for(i=1;i<=3;i++){
            mesh_TriFace1.children[i].visible=false;
            mesh_TriFace2.children[i].visible=false;
            mesh_TriFace3.children[i].visible=false;
            mesh_TriFace4.children[i].visible=false;
          }










        }



        function createCircleFaceArrow(centerPt,radius,arr_dir)
        {

          var Vec_a=cross(arr_dir,new THREE.Vector3(1,0,0)); 

          if(Vec_a.x===0&&Vec_a.y===0&&Vec_a.z===0)
          {
            Vec_a=cross(arr_dir,new THREE.Vector3(0,1,0));
          }

          var Vec_b=cross(arr_dir,Vec_a);

          Vec_a.normalize();
          Vec_b.normalize();

          // console.log("vec_a,vec_b",Vec_a,Vec_b);

          var points = [];
          var length = 20;


          for (i = 0; i <= length; i++)
          {
            var Pts_Circle=new THREE.Vector3(0,0,0);
            Pts_Circle.x=centerPt.x + radius*Vec_a.x*Math.cos(Math.PI*1.5*i/length) + radius*Vec_b.x*Math.sin(Math.PI*1.5*i/length);
            Pts_Circle.y=centerPt.y + radius*Vec_a.y*Math.cos(Math.PI*1.5*i/length) + radius*Vec_b.y*Math.sin(Math.PI*1.5*i/length);
            Pts_Circle.z=centerPt.z + radius*Vec_a.z*Math.cos(Math.PI*1.5*i/length) + radius*Vec_b.z*Math.sin(Math.PI*1.5*i/length);

            points.push(Pts_Circle);

          }

          var geometrySpacedPoints = new THREE.BufferGeometry().setFromPoints(points);
          //var line2 = new THREE.Line( geometrySpacedPoints, material);

          var arcMaterial = new THREE.LineDashedMaterial({
            color: 0x00ff00,
            dashSize: 0.1,
            gapSize: 0.05
          });



          var CircleMesh = new THREE.Line(geometrySpacedPoints,arcMaterial);

          //console.log("points=",points[1],points[5]);

          CircleMesh.computeLineDistances();//dash

          var arrow_material1=new THREE.MeshBasicMaterial( {
            color:  "white"//green
          } );

          // var CircleMesh=createCylinderMesh(points[0],points[1],arrow_material1,0.02,0.02);

          for(i=0;i<length;i++)
          {
            var CircleMesh1=createCylinderMesh(points[i],points[i+1],arrow_material1,0.005,0.005);
            CircleMesh.add(CircleMesh1);
          }

          var Arr_Pt1=new THREE.Vector3(0,0,0);

          Arr_Pt1.x=centerPt.x + radius*Vec_a.x*Math.cos(Math.PI*1.6*i/length) + radius*Vec_b.x*Math.sin(Math.PI*1.6*i/length);
          Arr_Pt1.y=centerPt.y + radius*Vec_a.y*Math.cos(Math.PI*1.6*i/length) + radius*Vec_b.y*Math.sin(Math.PI*1.6*i/length);
          Arr_Pt1.z=centerPt.z + radius*Vec_a.z*Math.cos(Math.PI*1.6*i/length) + radius*Vec_b.z*Math.sin(Math.PI*1.6*i/length);


          var face_arrow1=createCylinderArrowMesh(points[length],Arr_Pt1,arrow_material1,0.01,0.02,0.01);

          CircleMesh.add(face_arrow1);



          // CircleMesh.position.x=centerPt.x;
          // CircleMesh.position.y=centerPt.y;
          // CircleMesh.position.z=centerPt.z;
          //scene2.add(CircleMesh);

          return CircleMesh;


        }

        function createCircleFaceArrow2(centerPt,radius,arr_dir)
        {

          var Vec_a=cross(arr_dir,new THREE.Vector3(1,0,0));

          if(Vec_a.x===0&&Vec_a.y===0&&Vec_a.z===0)
          {
            Vec_a=cross(arr_dir,new THREE.Vector3(0,1,0));
          }

          var Vec_b=cross(arr_dir,Vec_a);

          Vec_a.normalize();
          Vec_b.normalize();

          // console.log("vec_a,vec_b",Vec_a,Vec_b);

          var points = [];
          var length = 20;


          for (i = 0; i <= length; i++)
          {
            var Pts_Circle=new THREE.Vector3(0,0,0);
            Pts_Circle.x=centerPt.x + radius*Vec_a.x*Math.cos(Math.PI*1.5*i/length) + radius*Vec_b.x*Math.sin(Math.PI*1.5*i/length);
            Pts_Circle.y=centerPt.y + radius*Vec_a.y*Math.cos(Math.PI*1.5*i/length) + radius*Vec_b.y*Math.sin(Math.PI*1.5*i/length);
            Pts_Circle.z=centerPt.z + radius*Vec_a.z*Math.cos(Math.PI*1.5*i/length) + radius*Vec_b.z*Math.sin(Math.PI*1.5*i/length);

            points.push(Pts_Circle);

          }

          var geometrySpacedPoints = new THREE.BufferGeometry().setFromPoints(points);
          //var line2 = new THREE.Line( geometrySpacedPoints, material);

          var arcMaterial = new THREE.LineDashedMaterial({
            color: 0x00ff00,//color
            dashSize: 0.1,//size
            gapSize: 0.05//len
          });



          var CircleMesh = new THREE.Line(geometrySpacedPoints,arcMaterial);

          //console.log("points=",points[1],points[5]);

          CircleMesh.computeLineDistances();//dash

          var arrow_material1=new THREE.MeshPhongMaterial( {
            color:  0x009600//green
          } );

          // var CircleMesh=createCylinderMesh(points[0],points[1],arrow_material1,0.02,0.02);

          for(i=0;i<length;i++)
          {
            var CircleMesh1=createCylinderMesh(points[i],points[i+1],arrow_material1,0.005,0.005);
            CircleMesh.add(CircleMesh1);
          }

          var Arr_Pt1=new THREE.Vector3(0,0,0);

          Arr_Pt1.x=centerPt.x + radius*Vec_a.x*Math.cos(Math.PI*1.6*i/length) + radius*Vec_b.x*Math.sin(Math.PI*1.6*i/length);
          Arr_Pt1.y=centerPt.y + radius*Vec_a.y*Math.cos(Math.PI*1.6*i/length) + radius*Vec_b.y*Math.sin(Math.PI*1.6*i/length);
          Arr_Pt1.z=centerPt.z + radius*Vec_a.z*Math.cos(Math.PI*1.6*i/length) + radius*Vec_b.z*Math.sin(Math.PI*1.6*i/length);


          var face_arrow1=createCylinderArrowMesh(points[length],Arr_Pt1,arrow_material1,0.01,0.02,0.01);

          CircleMesh.add(face_arrow1);



          // CircleMesh.position.x=centerPt.x;
          // CircleMesh.position.y=centerPt.y;
          // CircleMesh.position.z=centerPt.z;
          //scene2.add(CircleMesh);

          return CircleMesh;


        }



        function createCylinderMesh(pointX, pointY, material1, radius, radius2) {
          if (radius === undefined) {
            radius = 1;
          }

          if (radius2 === undefined) {
            radius2 = radius;
          }

          var direction = new THREE.Vector3().subVectors(pointY, pointX);
          var orientation = new THREE.Matrix4();
          orientation.lookAt(pointX, pointY, new THREE.Object3D().up);
          orientation.multiply(new THREE.Matrix4().set(1, 0, 0, 0,
            0, 0, 1, 0,
            0, -1, 0, 0,
            0, 0, 0, 1));
            var edgeGeometry = new THREE.CylinderGeometry(radius, radius2, direction.length(), 8, 1);
            var edge = new THREE.Mesh(edgeGeometry, material1);
            edge.applyMatrix4(orientation);
            // position based on midpoints - there may be a better solution than this
            edge.position.x = (pointY.x + pointX.x) / 2;
            edge.position.y = (pointY.y + pointX.y) / 2;
            edge.position.z = (pointY.z + pointX.z) / 2;


            //console.log("pos=", edge.position.x);
            return edge;
          }


          function create_TriangleMesh(p1,p2,p3,direction,coreScale)
          {

            var corepoint=face_center(p1,p2,p3);



            var unit_direction=new THREE.Vector3();//normlize
            unit_direction.x=direction.x/norm(direction);
            unit_direction.y=direction.y/norm(direction);
            unit_direction.z=direction.z/norm(direction);


            // var Scale_direction=new THREE.Vector3();

            // Scale_direction.x=1.2*unit_direction.x;
            // Scale_direction.y=1.2*unit_direction.y;
            // Scale_direction.z=1.2*unit_direction.z;


            var direction1 = new THREE.Vector3().subVectors(direction, corepoint);
            var m = direction1.length();
            var direction2 = new THREE.Vector3().subVectors(coreScale, corepoint);
            var n = direction1.length();
            //var m = unit_direction.distanceTo(new THREE.Vector3(corepoint.x, corepoint.y,corepoint.z));





            var p1_1=new THREE.Vector3();
            p1_1.x=p1.x+m*unit_direction.x;
            p1_1.y=p1.y+m*unit_direction.y;
            p1_1.z=p1.z+m*unit_direction.z;

            var p2_1=new THREE.Vector3();
            p2_1.x=p2.x+m*unit_direction.x;
            p2_1.y=p2.y+m*unit_direction.y;
            p2_1.z=p2.z+m*unit_direction.z;

            var p3_1=new THREE.Vector3();
            p3_1.x=p3.x+m*unit_direction.x;
            p3_1.y=p3.y+m*unit_direction.y;
            p3_1.z=p3.z+m*unit_direction.z;

            //console.log("p1=",p1,"p2=",p2,"p3=",p3,"p1_1=",p1_1,"p2_1=",p2_1,"p3_1=",p3_1,"direction",direction,"dis",dis);



            var vertices_tri=[
              p1,p2,p3,p1_1,p2_1,p3_1
            ];

            var faces_tri=[
              new THREE.Face3(0, 1, 2),
              new THREE.Face3(0, 4, 1),
              new THREE.Face3(2, 1, 4),
              new THREE.Face3(0, 3, 4),
              new THREE.Face3(2, 4, 5),
              new THREE.Face3(0, 3, 5),
              new THREE.Face3(2, 0, 5),
              new THREE.Face3(3, 4, 5)

            ];

            var geo01 = new THREE.Geometry();
            geo01.vertices.push(p1);
            geo01.vertices.push(p1_1);

            var line01 = new THREE.Line(geo01, lattice_line_material4);

            var geo02 = new THREE.Geometry();
            geo02.vertices.push(p3);
            geo02.vertices.push(p3_1);

            var line02 = new THREE.Line(geo02, lattice_line_material4);

            var geo03 = new THREE.Geometry();
            geo03.vertices.push(p2);
            geo03.vertices.push(p2_1);

            var line03 = new THREE.Line(geo03, lattice_line_material4);

            var geo04 = new THREE.Geometry();
            geo04.vertices.push(p3_1);
            geo04.vertices.push(p1_1);

            var line04 = new THREE.Line(geo04, lattice_line_material4);

            var geo05 = new THREE.Geometry();
            geo05.vertices.push(p3_1);
            geo05.vertices.push(p2_1);

            var line05 = new THREE.Line(geo05, lattice_line_material4);

            var geo06 = new THREE.Geometry();
            geo06.vertices.push(p1_1);
            geo06.vertices.push(p2_1);

            var line06 = new THREE.Line(geo06, lattice_line_material4);

            var geom_tri = new THREE.Geometry();
            geom_tri.vertices = vertices_tri;
            geom_tri.faces = faces_tri;
            geom_tri.computeFaceNormals();


            for (i = 0;i<geom_tri.faces.length;i++){
              var hex =0x156289;
              geom_tri.faces[i].color.setHex(hex);
            }

            //  var materials = new THREE.MeshBasicMaterial( {
            // vertexColors: THREE.FaceColors
            // } );





            var materials_tri = [
              //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
              //       new THREE.MeshBasicMaterial({color: 0x156289, wireframe: true,transparent: true,opacity:0.001}),
              new THREE.MeshPhongMaterial( {
                vertexColors: THREE.FaceColors,transparent: true,opacity:0.1,side:THREE.DoubleSide
              } )
            ];



            var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);


            //var polyhedron =createMesh(new THREE.PolyhedronGeometry(vertices,faces));
            // mesh_tri.add(line01);
            // mesh_tri.add(line02);
            // mesh_tri.add(line03);
            // mesh_tri.add(line04);
            // mesh_tri.add(line05);
            // mesh_tri.add(line06);
            return mesh_tri;

          }

          function create_TriangleMesh_Apply(p1,p2,p3,direction,coreScale)//dir 
          {

            var corepoint=face_center(p1,p2,p3);



            var unit_direction=new THREE.Vector3();//normlize
            unit_direction.x=direction.x/norm(direction);
            unit_direction.y=direction.y/norm(direction);
            unit_direction.z=direction.z/norm(direction);


            // var Scale_direction=new THREE.Vector3();

            // Scale_direction.x=1.2*unit_direction.x;
            // Scale_direction.y=1.2*unit_direction.y;
            // Scale_direction.z=1.2*unit_direction.z;


            var direction1 = new THREE.Vector3().subVectors(direction, corepoint);
            var m = direction1.length();
            var direction2 = new THREE.Vector3().subVectors(coreScale, corepoint);
            var n = direction1.length();
            //var m = unit_direction.distanceTo(new THREE.Vector3(corepoint.x, corepoint.y,corepoint.z));




            var p1_1=new THREE.Vector3();
            p1_1.x=p1.x+m*unit_direction.x;
            p1_1.y=p1.y+m*unit_direction.y;
            p1_1.z=p1.z+m*unit_direction.z;

            var p2_1=new THREE.Vector3();
            p2_1.x=p2.x+m*unit_direction.x;
            p2_1.y=p2.y+m*unit_direction.y;
            p2_1.z=p2.z+m*unit_direction.z;

            var p3_1=new THREE.Vector3();
            p3_1.x=p3.x+m*unit_direction.x;
            p3_1.y=p3.y+m*unit_direction.y;
            p3_1.z=p3.z+m*unit_direction.z;

            //console.log("p1=",p1,"p2=",p2,"p3=",p3,"p1_1=",p1_1,"p2_1=",p2_1,"p3_1=",p3_1,"direction",direction,"dis",dis);


    

            var vertices_tri=[
              p1,p2,p3,p1_1,p2_1,p3_1
            ];

            var faces_tri=[
              new THREE.Face3(0, 1, 2),
              new THREE.Face3(0, 4, 1),
              new THREE.Face3(2, 1, 4),
              new THREE.Face3(0, 3, 4),
              new THREE.Face3(2, 4, 5),
              new THREE.Face3(0, 3, 5),
              new THREE.Face3(2, 0, 5),
              new THREE.Face3(3, 4, 5)

            ];

            var geo01 = new THREE.Geometry();
            geo01.vertices.push(p1);
            geo01.vertices.push(p1_1);

            var line01 = new THREE.Line(geo01, lattice_line_material4);

            var geo02 = new THREE.Geometry();
            geo02.vertices.push(p3);
            geo02.vertices.push(p3_1);

            var line02 = new THREE.Line(geo02, lattice_line_material4);

            var geo03 = new THREE.Geometry();
            geo03.vertices.push(p2);
            geo03.vertices.push(p2_1);

            var line03 = new THREE.Line(geo03, lattice_line_material4);

            var geo04 = new THREE.Geometry();
            geo04.vertices.push(p3_1);
            geo04.vertices.push(p1_1);

            var line04 = new THREE.Line(geo04, lattice_line_material4);

            var geo05 = new THREE.Geometry();
            geo05.vertices.push(p3_1);
            geo05.vertices.push(p2_1);

            var line05 = new THREE.Line(geo05, lattice_line_material4);

            var geo06 = new THREE.Geometry();
            geo06.vertices.push(p1_1);
            geo06.vertices.push(p2_1);

            var line06 = new THREE.Line(geo06, lattice_line_material4);


            var geom_tri = new THREE.Geometry();
            geom_tri.vertices = vertices_tri;
            geom_tri.faces = faces_tri;
            geom_tri.computeFaceNormals();


            for (i = 0;i<geom_tri.faces.length;i++){
              var hex =0x009600;
              geom_tri.faces[i].color.setHex(hex);
            }

            //  var materials = new THREE.MeshBasicMaterial( {
            // vertexColors: THREE.FaceColors
            // } );





            var materials_tri = [
              //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
              //       new THREE.MeshBasicMaterial({color: 0x156289, wireframe: true,transparent: true,opacity:0.001}),
              new THREE.MeshPhongMaterial( {
                vertexColors: THREE.FaceColors,transparent: true,opacity:0.1,side:THREE.DoubleSide
              } )
            ];



            var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);


            //var polyhedron =createMesh(new THREE.PolyhedronGeometry(vertices,faces));
            mesh_tri.add(line01);
            mesh_tri.add(line02);
            mesh_tri.add(line03);
            mesh_tri.add(line04);
            mesh_tri.add(line05);
            mesh_tri.add(line06);
            return mesh_tri;
              //mesh_tri.add(line01);

          }



  

          function create_Tri_FaceMesh_p(p1,p2,p3,arr_face_dir,Is_First,arr_dir,text)//dir 
          {

            var corepoint=face_center(p1,p2,p3);
            var m = 0.2;//scale

            //center
            var dirA=new THREE.Vector3().subVectors(corepoint,p1);
            var dirB=new THREE.Vector3().subVectors(corepoint,p2);
            var dirC=new THREE.Vector3().subVectors(corepoint,p3);

            dirA.normalize();
            dirB.normalize();
            dirC.normalize();


            var p1_1=new THREE.Vector3();
            // p1_1=subVec(p1,m*unit_dir1);
            p1_1.x=p1.x+m*dirA.x;
            p1_1.y=p1.y+m*dirA.y;
            p1_1.z=p1.z+m*dirA.z;

            var p2_1=new THREE.Vector3();
            p2_1.x=p2.x+m*dirB.x;
            p2_1.y=p2.y+m*dirB.y;
            p2_1.z=p2.z+m*dirB.z;

            var p3_1=new THREE.Vector3();
            p3_1.x=p3.x+m*dirC.x;
            p3_1.y=p3.y+m*dirC.y;
            p3_1.z=p3.z+m*dirC.z;



            var vertices_tri=[
              p1_1,p2_1,p3_1
            ];

            var faces_tri=[
              new THREE.Face3(2,1,0),

            ];

            var vertices_face=[
              p1_1,p2_1,p3_1
            ];

            var geom_tri = new THREE.Geometry();
            geom_tri.vertices = vertices_tri;
            geom_tri.faces = faces_tri;
            geom_tri.computeFaceNormals();

            for (i = 0;i<geom_tri.faces.length;i++){
              if(Is_First)
              {
                var hex =0x008000;
                geom_tri.faces[i].color.setHex(hex);
              }
              else
              {
                var hex =0x0F3150;
                geom_tri.faces[i].color.setHex(hex);
              }

            }

            //  var materials = new THREE.MeshBasicMaterial( {
            // vertexColors: THREE.FaceColors
            // } );

            var materials_tri = [
              //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
              // new THREE.MeshBasicMaterial({color: 0x4d4dff, wireframe: true,transparent: true,opacity:0.05}),
              new THREE.MeshBasicMaterial( {
                vertexColors: THREE.FaceColors,transparent: true,opacity:0.8,side:THREE.DoubleSide
              } )
            ];

            var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);

            // return mesh_tri;

            //arrowHelper1.add(mesh_tri)

            //var arrowHelper1;

            // var hex = 0x000000;//black
            if(Is_First)

            var arr_face_material=new THREE.MeshPhongMaterial( {
              color:  0x009600//force face green
            } );
            else
            var arr_face_material=new THREE.MeshPhongMaterial( {
              color:  0x000000//force face black
            } );

            var arr_material2;

            if(arr_dir<0)//T or P
            {
              arrow_material2=new THREE.MeshPhongMaterial( {
                color: 0xC00000//red
              });
              for (i = 0;i<geom_tri.faces.length;i++){
                if(Is_First)
                {
                  var hex =0x008000;
                  geom_tri.faces[i].color.setHex(hex);
                }
                else
                {
                  var hex =0xC00000;
                  geom_tri.faces[i].color.setHex(hex);
                }

              }
            }
            else
            {
              arrow_material2=new THREE.MeshPhongMaterial( {
                color: 0x0F3150//blue
              });
              for (i = 0;i<geom_tri.faces.length;i++){
                if(Is_First)
                {
                  var hex =0x008000;
                  geom_tri.faces[i].color.setHex(hex);
                }
                else
                {
                  var hex =0x0F3150;
                  geom_tri.faces[i].color.setHex(hex);
                }

              }

            }


                        var materials_tri = [
                          //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                          // new THREE.MeshBasicMaterial({color: 0x4d4dff, wireframe: true,transparent: true,opacity:0.05}),
                          new THREE.MeshBasicMaterial( {
                            vertexColors: THREE.FaceColors,transparent: true,opacity:0.8,side:THREE.DoubleSide
                          } )
                        ];

                        var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);
            //in or out

            var forceFaceDir=Pnt_copy(arr_face_dir);
            forceFaceDir.normalize();

            //in or out dir
            var out1=new THREE.Vector3();
            out1.x=corepoint.x+0.2*forceFaceDir.x;
            out1.y=corepoint.y+0.2*forceFaceDir.y;
            out1.z=corepoint.z+0.2*forceFaceDir.z;


            var out2=new THREE.Vector3();
            out2.x=corepoint.x-0.2*forceFaceDir.x;
            out2.y=corepoint.y-0.2*forceFaceDir.y;
            out2.z=corepoint.z-0.2*forceFaceDir.z;

            var out1_core=new THREE.Vector3().subVectors(out1,corePoint_body);
            var out2_core=new THREE.Vector3().subVectors(out2,corePoint_body);

            if(out1_core.length()>out2_core.length())//out
            {


              var arrowHP1=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow

              // var direction1 = new THREE.Vector3().subVectors(p1_1, p3_1);
              // var length1=direction1.length();
              // direction1.normalize();
              // var arrowHelper1 = new THREE.ArrowHelper(direction1, p3_1, length1,hex,0.2,0.05);
              mesh_tri.add(arrowHP1);

              // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
              // var length2=direction2.length();
              // direction2.normalize();
              // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.2,0.05);
              var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
              mesh_tri.add(arrowHP2);

              // var direction3 = new THREE.Vector3().subVectors(p2_1, p1_1);
              // var length3=direction3.length();
              // direction3.normalize();
              // var arrowHelper3 = new THREE.ArrowHelper(direction3, p1_1, length3,hex,0.2,0.05);
              var arrowHP3=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
              mesh_tri.add(arrowHP3);

              //normal arrow

              var corepoint2=new THREE.Vector3();
              corepoint2.x=corepoint.x+0.4*forceFaceDir.x;
              corepoint2.y=corepoint.y+0.4*forceFaceDir.y;
              corepoint2.z=corepoint.z+0.4*forceFaceDir.z;

              var corepoint3=new THREE.Vector3();
              corepoint3.x=corepoint.x+0.37*forceFaceDir.x;
              corepoint3.y=corepoint.y+0.37*forceFaceDir.y;
              corepoint3.z=corepoint.z+0.37*forceFaceDir.z;



              //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
              if(Is_First)//apply 
              {
                var arrow_material1=new THREE.MeshPhongMaterial( {
                  color: 0x009600
                } );
                var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.6);
                //
              }
              else
              var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material2,0.02,0.05,0.6);


              mesh_tri.add(arrowN);

              if(Is_First)//apply 
              {
                var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
                var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);
                //
              }
              else
              var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
              var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);



              mesh_tri.add(arrowN_O);
              arrowN_O.scale.multiplyScalar(1.2);

              var TXMesh=createSpriteText(text,corepoint2);

              text_group2.add(TXMesh);

              //face arrow

              var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
              cir_dir.normalize();

              var arrowpt=new THREE.Vector3();
              arrowpt.x=corepoint.x+0.2*cir_dir.x;
              arrowpt.y=corepoint.y+0.2*cir_dir.y;
              arrowpt.z=corepoint.z+0.2*cir_dir.z;

              //arr_dir.normalize();

              var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

              //var direction1 = new THREE.Vector3().subVectors(p1, p2);
              var length1=0.001;
              direction1.normalize();
              var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.05);

              //        mesh_tri.add(arrowHelper1);


              //dir arrow

              var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
              mesh_tri.add(circle_mesh);

              //var step_1=createCircleFaceArrow2(TubePoints1[1],0.2,forceFaceDir);
              // Tube_group.add(step_1);


            }
            else
            {

              // var direction1 = new THREE.Vector3().subVectors(p2_1, p1_1);
              // var length1=direction1.length();
              // direction1.normalize();
              // var arrowHelper1 = new THREE.ArrowHelper(direction1, p1_1, length1,hex,0.1,0.05);
              var arrowHP1=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
              mesh_tri.add(arrowHP1);

              // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
              // var length2=direction2.length();
              // direction2.normalize();
              // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.1,0.05);
              var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
              mesh_tri.add(arrowHP2);



              // var direction3 = new THREE.Vector3().subVectors(p1_1, p3_1);
              // var length3=direction3.length();
              // direction3.normalize();
              // var arrowHelper3 = new THREE.ArrowHelper(direction3, p3_1, length3,hex,0.1,0.05);
              var arrowHP3=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow
              mesh_tri.add(arrowHP3);



              var corepoint2=new THREE.Vector3();
              corepoint2.x=corepoint.x-0.4*forceFaceDir.x;
              corepoint2.y=corepoint.y-0.4*forceFaceDir.y;
              corepoint2.z=corepoint.z-0.4*forceFaceDir.z;

              var corepoint3=new THREE.Vector3();
              corepoint3.x=corepoint.x-0.37*forceFaceDir.x;
              corepoint3.y=corepoint.y-0.37*forceFaceDir.y;
              corepoint3.z=corepoint.z-0.37*forceFaceDir.z;

              if(Is_First)//apply 
              {
                var arrow_material1=new THREE.MeshPhongMaterial( {
                  color: 0x009600
                } );
                //var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.7);
                var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material1,0.02,0.05,0.6);

              }
              else
              var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material2,0.02,0.05,0.6);


              //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);



              //normal arrow

              //var dirN=cross(direction2,direction1);

              //dirN.normalize();


              //var arrowN=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
              mesh_tri.add(arrowN);

              if(Is_First)//apply 
              {
                var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
                var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);
                //
              }
              else
              var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
              var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);



              mesh_tri.add(arrowN_O);
              arrowN_O.scale.multiplyScalar(1.2);

              var TXMesh1=createSpriteText(text,corepoint2);

              text_group2.add(TXMesh1);

              // var Line_center=new THREE.Vector3((p1.x+p2.x)/2,(p1.y+p2.y)/2,(p1.z+p2.z)/2);

              var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
              cir_dir.normalize();

              var arrowpt=new THREE.Vector3();
              arrowpt.x=corepoint.x+0.2*cir_dir.x;
              arrowpt.y=corepoint.y+0.2*cir_dir.y;
              arrowpt.z=corepoint.z+0.2*cir_dir.z;

              //arr_dir.normalize();

              var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

              //var direction1 = new THREE.Vector3().subVectors(p1, p2);
              var length1=0.001;
              direction1.normalize();
              var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.1);

              //            mesh_tri.add(arrowHelper1);


              //dir arrow

              var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
              mesh_tri.add(circle_mesh);

       



            }





          //normal arrow



          return mesh_tri;




        }

        function create_Tri_FaceMesh_step(p1,p2,p3,arr_face_dir,Is_First,arr_dir,text)//dir 
        {

          var corepoint=face_center(p1,p2,p3);
          var m = 0.2;//scale

          //center
          var dirA=new THREE.Vector3().subVectors(corepoint,p1);
          var dirB=new THREE.Vector3().subVectors(corepoint,p2);
          var dirC=new THREE.Vector3().subVectors(corepoint,p3);

          dirA.normalize();
          dirB.normalize();
          dirC.normalize();

          // var unit_dir1=new THREE.Vector3();//normlize
          // unit_dir1.x=dirA.x/norm(dirA);
          // unit_dir1.y=dirA.y/norm(dirA);
          // unit_dir1.z=dirA.z/norm(dirA);

          // var unit_dir2=new THREE.Vector3();//normlize
          // unit_dir2.x=dirB.x/norm(dirB);
          // unit_dir2.y=dirB.y/norm(dirB);
          // unit_dir2.z=dirB.z/norm(dirB);

          // var unit_dir3=new THREE.Vector3();//normlize
          // unit_dir3.x=dirC.x/norm(dirC);
          // unit_dir3.y=dirC.y/norm(dirC);
          // unit_dir3.z=dirC.z/norm(dirC);


          //point move

          var p1_1=new THREE.Vector3();
          // p1_1=subVec(p1,m*unit_dir1);
          p1_1.x=p1.x+m*dirA.x;
          p1_1.y=p1.y+m*dirA.y;
          p1_1.z=p1.z+m*dirA.z;

          var p2_1=new THREE.Vector3();
          p2_1.x=p2.x+m*dirB.x;
          p2_1.y=p2.y+m*dirB.y;
          p2_1.z=p2.z+m*dirB.z;

          var p3_1=new THREE.Vector3();
          p3_1.x=p3.x+m*dirC.x;
          p3_1.y=p3.y+m*dirC.y;
          p3_1.z=p3.z+m*dirC.z;



          var vertices_tri=[
            p1_1,p2_1,p3_1
          ];

          var faces_tri=[
            new THREE.Face3(2,1,0),

          ];

          var vertices_face=[
            p1_1,p2_1,p3_1
          ];

          var geom_tri = new THREE.Geometry();
          geom_tri.vertices = vertices_tri;
          geom_tri.faces = faces_tri;
          geom_tri.computeFaceNormals();

          for (i = 0;i<geom_tri.faces.length;i++){
            if(Is_First)
            {
              var hex =0x008000;
              geom_tri.faces[i].color.setHex(hex);
            }
            else
            {
              var hex =0x0F3150;
              geom_tri.faces[i].color.setHex(hex);
            }

          }

          //  var materials = new THREE.MeshBasicMaterial( {
          // vertexColors: THREE.FaceColors
          // } );

          var materials_tri = [
            //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
            // new THREE.MeshBasicMaterial({color: 0x4d4dff, wireframe: true,transparent: true,opacity:0.05}),
            new THREE.MeshBasicMaterial( {
              vertexColors: THREE.FaceColors,transparent: true,opacity:0.8,side:THREE.DoubleSide
            } )
          ];

          var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);

          // return mesh_tri;

          //arrowHelper1.add(mesh_tri)

          //var arrowHelper1;

          // var hex = 0x000000;//black
          if(Is_First)

          var arr_face_material=new THREE.MeshPhongMaterial( {
            color:  "black"//force face green
          } );
          else
          var arr_face_material=new THREE.MeshPhongMaterial( {
            color:  0x000000//force face black
          } );

          var arr_material2;

          if(arr_dir<0)//T or P
          {
            arrow_material2=new THREE.MeshPhongMaterial( {
              color: "black"//red
            });
            for (i = 0;i<geom_tri.faces.length;i++){
              if(Is_First)
              {
                var hex =0x008000;
                geom_tri.faces[i].color.setHex(hex);
              }
              else
              {
                var hex =0xC00000;
                geom_tri.faces[i].color.setHex(hex);
              }

            }
          }
          else
          {
            arrow_material2=new THREE.MeshPhongMaterial( {
              color: "black"//blue
            });
            for (i = 0;i<geom_tri.faces.length;i++){
              if(Is_First)
              {
                var hex =0x008000;
                geom_tri.faces[i].color.setHex(hex);
              }
              else
              {
                var hex =0x0F3150;
                geom_tri.faces[i].color.setHex(hex);
              }

            }

          }


                      var materials_tri = [
                        //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                        // new THREE.MeshBasicMaterial({color: 0x4d4dff, wireframe: true,transparent: true,opacity:0.05}),
                        new THREE.MeshBasicMaterial( {
                          vertexColors: THREE.FaceColors,transparent: true,opacity:0.8,side:THREE.DoubleSide
                        } )
                      ];

                      var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);
          //in or out

          var forceFaceDir=Pnt_copy(arr_face_dir);
          forceFaceDir.normalize();

          //in or out dir
          var out1=new THREE.Vector3();
          out1.x=corepoint.x+0.2*forceFaceDir.x;
          out1.y=corepoint.y+0.2*forceFaceDir.y;
          out1.z=corepoint.z+0.2*forceFaceDir.z;


          var out2=new THREE.Vector3();
          out2.x=corepoint.x-0.2*forceFaceDir.x;
          out2.y=corepoint.y-0.2*forceFaceDir.y;
          out2.z=corepoint.z-0.2*forceFaceDir.z;

          var out1_core=new THREE.Vector3().subVectors(out1,corePoint_body);
          var out2_core=new THREE.Vector3().subVectors(out2,corePoint_body);

          if(out1_core.length()>out2_core.length())//out
          {


            var arrowHP1=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow

            // var direction1 = new THREE.Vector3().subVectors(p1_1, p3_1);
            // var length1=direction1.length();
            // direction1.normalize();
            // var arrowHelper1 = new THREE.ArrowHelper(direction1, p3_1, length1,hex,0.2,0.05);
            mesh_tri.add(arrowHP1);

            // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
            // var length2=direction2.length();
            // direction2.normalize();
            // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.2,0.05);
            var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP2);

            // var direction3 = new THREE.Vector3().subVectors(p2_1, p1_1);
            // var length3=direction3.length();
            // direction3.normalize();
            // var arrowHelper3 = new THREE.ArrowHelper(direction3, p1_1, length3,hex,0.2,0.05);
            var arrowHP3=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP3);

            //normal arrow

            var corepoint2=new THREE.Vector3();
            corepoint2.x=corepoint.x+0.4*forceFaceDir.x;
            corepoint2.y=corepoint.y+0.4*forceFaceDir.y;
            corepoint2.z=corepoint.z+0.4*forceFaceDir.z;

            var corepoint3=new THREE.Vector3();
            corepoint3.x=corepoint.x+0.37*forceFaceDir.x;
            corepoint3.y=corepoint.y+0.37*forceFaceDir.y;
            corepoint3.z=corepoint.z+0.37*forceFaceDir.z;



            //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
            if(Is_First)//apply 
            {
              var arrow_material1=new THREE.MeshPhongMaterial( {
                color: "black"
              } );
              var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.6);
              //
            }
            else
            var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material2,0.02,0.05,0.6);


            mesh_tri.add(arrowN);

            if(Is_First)//apply 
            {
              var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
              var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);
              //
            }
            else
            var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
            var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);



            mesh_tri.add(arrowN_O);
            arrowN_O.scale.multiplyScalar(1.2);

            var TXMesh=createSpriteText(text,corepoint2);

            text_group2.add(TXMesh);

            //face arrow

            var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
            cir_dir.normalize();

            var arrowpt=new THREE.Vector3();
            arrowpt.x=corepoint.x+0.2*cir_dir.x;
            arrowpt.y=corepoint.y+0.2*cir_dir.y;
            arrowpt.z=corepoint.z+0.2*cir_dir.z;

            //arr_dir.normalize();

            var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

            //var direction1 = new THREE.Vector3().subVectors(p1, p2);
            var length1=0.001;
            direction1.normalize();
            var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.05);

            //        mesh_tri.add(arrowHelper1);


            //dir arrow

            var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
            mesh_tri.add(circle_mesh);

            //var step_1=createCircleFaceArrow2(TubePoints1[1],0.2,forceFaceDir);
            // Tube_group.add(step_1);


          }
          else
          {

            // var direction1 = new THREE.Vector3().subVectors(p2_1, p1_1);
            // var length1=direction1.length();
            // direction1.normalize();
            // var arrowHelper1 = new THREE.ArrowHelper(direction1, p1_1, length1,hex,0.1,0.05);
            var arrowHP1=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP1);

            // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
            // var length2=direction2.length();
            // direction2.normalize();
            // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.1,0.05);
            var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP2);



            // var direction3 = new THREE.Vector3().subVectors(p1_1, p3_1);
            // var length3=direction3.length();
            // direction3.normalize();
            // var arrowHelper3 = new THREE.ArrowHelper(direction3, p3_1, length3,hex,0.1,0.05);
            var arrowHP3=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP3);



            var corepoint2=new THREE.Vector3();
            corepoint2.x=corepoint.x-0.4*forceFaceDir.x;
            corepoint2.y=corepoint.y-0.4*forceFaceDir.y;
            corepoint2.z=corepoint.z-0.4*forceFaceDir.z;

            var corepoint3=new THREE.Vector3();
            corepoint3.x=corepoint.x-0.37*forceFaceDir.x;
            corepoint3.y=corepoint.y-0.37*forceFaceDir.y;
            corepoint3.z=corepoint.z-0.37*forceFaceDir.z;

            if(Is_First)//apply 
            {
              var arrow_material1=new THREE.MeshPhongMaterial( {
                color: 0x009600
              } );
              //var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.7);
              var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material1,0.02,0.05,0.6);

            }
            else
            var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material2,0.02,0.05,0.6);


            //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);



            //normal arrow

            //var dirN=cross(direction2,direction1);

            //dirN.normalize();


            //var arrowN=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
            mesh_tri.add(arrowN);

            if(Is_First)//apply 
            {
              var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
              var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);
              //
            }
            else
            var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
            var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);



            mesh_tri.add(arrowN_O);
            arrowN_O.scale.multiplyScalar(1.2);

            var TXMesh1=createSpriteText(text,corepoint2);

            text_group2.add(TXMesh1);

            // var Line_center=new THREE.Vector3((p1.x+p2.x)/2,(p1.y+p2.y)/2,(p1.z+p2.z)/2);

            var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
            cir_dir.normalize();

            var arrowpt=new THREE.Vector3();
            arrowpt.x=corepoint.x+0.2*cir_dir.x;
            arrowpt.y=corepoint.y+0.2*cir_dir.y;
            arrowpt.z=corepoint.z+0.2*cir_dir.z;

            //arr_dir.normalize();

            var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

            //var direction1 = new THREE.Vector3().subVectors(p1, p2);
            var length1=0.001;
            direction1.normalize();
            var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.1);

            //            mesh_tri.add(arrowHelper1);


            //dir arrow

            var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
            mesh_tri.add(circle_mesh);

            //arrow




          }





        //normal arrow



        return mesh_tri;





        //mink



        //return arrowHelper1;








      }


        function create_Tri_FaceMesh_t(p1,p2,p3,arr_face_dir,Is_First,arr_dir,text)//dir 
        {

          var corepoint=face_center(p1,p2,p3);
          var m = 0.2;//scale

          //center
          var dirA=new THREE.Vector3().subVectors(corepoint,p1);
          var dirB=new THREE.Vector3().subVectors(corepoint,p2);
          var dirC=new THREE.Vector3().subVectors(corepoint,p3);

          dirA.normalize();
          dirB.normalize();
          dirC.normalize();

          // var unit_dir1=new THREE.Vector3();//normlize
          // unit_dir1.x=dirA.x/norm(dirA);
          // unit_dir1.y=dirA.y/norm(dirA);
          // unit_dir1.z=dirA.z/norm(dirA);

          // var unit_dir2=new THREE.Vector3();//normlize
          // unit_dir2.x=dirB.x/norm(dirB);
          // unit_dir2.y=dirB.y/norm(dirB);
          // unit_dir2.z=dirB.z/norm(dirB);

          // var unit_dir3=new THREE.Vector3();//normlize
          // unit_dir3.x=dirC.x/norm(dirC);
          // unit_dir3.y=dirC.y/norm(dirC);
          // unit_dir3.z=dirC.z/norm(dirC);


          //point move

          var p1_1=new THREE.Vector3();
          // p1_1=subVec(p1,m*unit_dir1);
          p1_1.x=p1.x+m*dirA.x;
          p1_1.y=p1.y+m*dirA.y;
          p1_1.z=p1.z+m*dirA.z;

          var p2_1=new THREE.Vector3();
          p2_1.x=p2.x+m*dirB.x;
          p2_1.y=p2.y+m*dirB.y;
          p2_1.z=p2.z+m*dirB.z;

          var p3_1=new THREE.Vector3();
          p3_1.x=p3.x+m*dirC.x;
          p3_1.y=p3.y+m*dirC.y;
          p3_1.z=p3.z+m*dirC.z;



          var vertices_tri=[
            p1,p2,p3
          ];

          var faces_tri=[
            new THREE.Face3(2,1,0),

          ];

          var vertices_face=[
            p1,p2,p3_1
          ];

          var geom_tri = new THREE.Geometry();
          geom_tri.vertices = vertices_tri;
          geom_tri.faces = faces_tri;
          geom_tri.computeFaceNormals();


          // return mesh_tri;

          //arrowHelper1.add(mesh_tri)

          //var arrowHelper1;

          // var hex = 0x000000;//black
          if(Is_First)

          var arr_face_material=new THREE.MeshPhongMaterial( {
            color:  0x009600//force face green
          } );
          else
          var arr_face_material=new THREE.MeshPhongMaterial( {
            color:  0x000000//force face black
          } );

          var arr_material2;


                      if(arr_dir<0)//T or P
                      {
                        arrow_material2=new THREE.MeshPhongMaterial( {
                          color: 0xC00000//red
                        });
                        for (i = 0;i<geom_tri.faces.length;i++){
                          if(Is_First)
                          {
                            var hex =0x008000;
                            geom_tri.faces[i].color.setHex(hex);
                          }
                          else
                          {
                            //var hex =0xCC0549;
                            var hex =0xD72F62;
                            geom_tri.faces[i].color.setHex(hex);
                          }

                        }
                      }
                      else
                      {
                        arrow_material2=new THREE.MeshPhongMaterial( {
                          color: 0x0F3150//blue
                        });
                        for (i = 0;i<geom_tri.faces.length;i++){
                          if(Is_First)
                          {
                            var hex =0x008000;
                            geom_tri.faces[i].color.setHex(hex);
                          }
                          else
                          {
                            var hex =0x0F3150;
                            geom_tri.faces[i].color.setHex(hex);
                          }

                        }

                      }
                      var materials_tri = [
                        //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                        // new THREE.MeshBasicMaterial({color: 0x4d4dff, wireframe: true,transparent: true,opacity:0.05}),
                        new THREE.MeshBasicMaterial( {
                          vertexColors: THREE.FaceColors,transparent: true,opacity:0.9,side:THREE.DoubleSide
                        } )
                      ];

                      var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);


          //in or out

          var forceFaceDir=Pnt_copy(arr_face_dir);
          forceFaceDir.normalize();

          //in or out dir
          var out1=new THREE.Vector3();
          out1.x=corepoint.x+0.2*forceFaceDir.x;
          out1.y=corepoint.y+0.2*forceFaceDir.y;
          out1.z=corepoint.z+0.2*forceFaceDir.z;


          var out2=new THREE.Vector3();
          out2.x=corepoint.x-0.2*forceFaceDir.x;
          out2.y=corepoint.y-0.2*forceFaceDir.y;
          out2.z=corepoint.z-0.2*forceFaceDir.z;

          var out1_core=new THREE.Vector3().subVectors(out1,corePoint_body);
          var out2_core=new THREE.Vector3().subVectors(out2,corePoint_body);

          if(out1_core.length()>out2_core.length())//out
          {


            var arrowHP1=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow

            // var direction1 = new THREE.Vector3().subVectors(p1_1, p3_1);
            // var length1=direction1.length();
            // direction1.normalize();
            // var arrowHelper1 = new THREE.ArrowHelper(direction1, p3_1, length1,hex,0.2,0.05);
            mesh_tri.add(arrowHP1);

            // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
            // var length2=direction2.length();
            // direction2.normalize();
            // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.2,0.05);
            var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP2);

            // var direction3 = new THREE.Vector3().subVectors(p2_1, p1_1);
            // var length3=direction3.length();
            // direction3.normalize();
            // var arrowHelper3 = new THREE.ArrowHelper(direction3, p1_1, length3,hex,0.2,0.05);
            var arrowHP3=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP3);

            //normal arrow

            var corepoint2=new THREE.Vector3();
            corepoint2.x=corepoint.x+0.4*forceFaceDir.x;
            corepoint2.y=corepoint.y+0.4*forceFaceDir.y;
            corepoint2.z=corepoint.z+0.4*forceFaceDir.z;

            var corepoint3=new THREE.Vector3();
            corepoint3.x=corepoint.x+0.37*forceFaceDir.x;
            corepoint3.y=corepoint.y+0.37*forceFaceDir.y;
            corepoint3.z=corepoint.z+0.37*forceFaceDir.z;



            //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
            if(Is_First)//apply 
            {
              var arrow_material1=new THREE.MeshPhongMaterial( {
                color: 0x009600
              } );
              var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.6);
              //
            }
            else
            var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material2,0.02,0.05,0.6);


            mesh_tri.add(arrowN);

            if(Is_First)//apply 
            {
              var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
              var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);
              //
            }
            else
            var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
            var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);



            mesh_tri.add(arrowN_O);
            arrowN_O.scale.multiplyScalar(1.2);

            var TXMesh=createSpriteText(text,corepoint2);

            text_group2.add(TXMesh);

            //face arrow

            var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
            cir_dir.normalize();

            var arrowpt=new THREE.Vector3();
            arrowpt.x=corepoint.x+0.2*cir_dir.x;
            arrowpt.y=corepoint.y+0.2*cir_dir.y;
            arrowpt.z=corepoint.z+0.2*cir_dir.z;

            //arr_dir.normalize();

            var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

            //var direction1 = new THREE.Vector3().subVectors(p1, p2);
            var length1=0.001;
            direction1.normalize();
            var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.05);

            //        mesh_tri.add(arrowHelper1);


            //dir arrow

            var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
            mesh_tri.add(circle_mesh);

            //var step_1=createCircleFaceArrow2(TubePoints1[1],0.2,forceFaceDir);
            // Tube_group.add(step_1);


          }
          else
          {

            // var direction1 = new THREE.Vector3().subVectors(p2_1, p1_1);
            // var length1=direction1.length();
            // direction1.normalize();
            // var arrowHelper1 = new THREE.ArrowHelper(direction1, p1_1, length1,hex,0.1,0.05);
            var arrowHP1=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP1);

            // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
            // var length2=direction2.length();
            // direction2.normalize();
            // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.1,0.05);
            var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP2);



            // var direction3 = new THREE.Vector3().subVectors(p1_1, p3_1);
            // var length3=direction3.length();
            // direction3.normalize();
            // var arrowHelper3 = new THREE.ArrowHelper(direction3, p3_1, length3,hex,0.1,0.05);
            var arrowHP3=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow
            mesh_tri.add(arrowHP3);



            var corepoint2=new THREE.Vector3();
            corepoint2.x=corepoint.x-0.4*forceFaceDir.x;
            corepoint2.y=corepoint.y-0.4*forceFaceDir.y;
            corepoint2.z=corepoint.z-0.4*forceFaceDir.z;

            var corepoint3=new THREE.Vector3();
            corepoint3.x=corepoint.x-0.37*forceFaceDir.x;
            corepoint3.y=corepoint.y-0.37*forceFaceDir.y;
            corepoint3.z=corepoint.z-0.37*forceFaceDir.z;

            if(Is_First)//apply 
            {
              var arrow_material1=new THREE.MeshPhongMaterial( {
                color: 0x009600
              } );
              //var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.7);
              var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material1,0.02,0.05,0.6);

            }
            else
            var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material2,0.02,0.05,0.6);


            //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);



            //normal arrow

            //var dirN=cross(direction2,direction1);

            //dirN.normalize();


            //var arrowN=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
            mesh_tri.add(arrowN);

            if(Is_First)//apply 
            {
              var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
              var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);
              //
            }
            else
            var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
            var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);



            mesh_tri.add(arrowN_O);
            arrowN_O.scale.multiplyScalar(1.2);

            var TXMesh1=createSpriteText(text,corepoint2);

            text_group2.add(TXMesh1);

            // var Line_center=new THREE.Vector3((p1.x+p2.x)/2,(p1.y+p2.y)/2,(p1.z+p2.z)/2);

            var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
            cir_dir.normalize();

            var arrowpt=new THREE.Vector3();
            arrowpt.x=corepoint.x+0.2*cir_dir.x;
            arrowpt.y=corepoint.y+0.2*cir_dir.y;
            arrowpt.z=corepoint.z+0.2*cir_dir.z;

            //arr_dir.normalize();

            var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

            //var direction1 = new THREE.Vector3().subVectors(p1, p2);
            var length1=0.001;
            direction1.normalize();
            var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.1);

            //            mesh_tri.add(arrowHelper1);


            //dir arrow

            var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
            mesh_tri.add(circle_mesh);

            //arrow




          }





        //normal arrow



        return mesh_tri;




        //var polyhedron =createMesh(new THREE.PolyhedronGeometry(vertices,faces));















        // var Scale_direction=new THREE.Vector3();

        // Scale_direction.x=1.2*unit_direction.x;
        // Scale_direction.y=1.2*unit_direction.y;
        // Scale_direction.z=1.2*unit_direction.z;


        //var direction1 = new THREE.Vector3().subVectors(coreScale, corepoint);




        //var dis=distance(,);//dis

        //console.log("m=",m);


        //var m=Math.sqrt((dis*dis)/(norm(unit_direction)*norm(unit_direction)));





        //console.log("p1=",p1,"p2=",p2,"p3=",p3,"p1_1=",p1_1,"p2_1=",p2_1,"p3_1=",p3_1,"direction",direction,"dis",dis);


        //mink



        //return arrowHelper1;








      }

            function create_Tri_FaceMesh(p1,p2,p3,arr_face_dir,Is_First,arr_dir,text)//dir 
            {

              var corepoint=face_center(p1,p2,p3);
              var m = 0.2;//scale

              //center
              var dirA=new THREE.Vector3().subVectors(corepoint,p1);
              var dirB=new THREE.Vector3().subVectors(corepoint,p2);
              var dirC=new THREE.Vector3().subVectors(corepoint,p3);

              dirA.normalize();
              dirB.normalize();
              dirC.normalize();

              // var unit_dir1=new THREE.Vector3();//normlize
              // unit_dir1.x=dirA.x/norm(dirA);
              // unit_dir1.y=dirA.y/norm(dirA);
              // unit_dir1.z=dirA.z/norm(dirA);

              // var unit_dir2=new THREE.Vector3();//normlize
              // unit_dir2.x=dirB.x/norm(dirB);
              // unit_dir2.y=dirB.y/norm(dirB);
              // unit_dir2.z=dirB.z/norm(dirB);

              // var unit_dir3=new THREE.Vector3();//normlize
              // unit_dir3.x=dirC.x/norm(dirC);
              // unit_dir3.y=dirC.y/norm(dirC);
              // unit_dir3.z=dirC.z/norm(dirC);


              //point move

              var p1_1=new THREE.Vector3();
              // p1_1=subVec(p1,m*unit_dir1);
              p1_1.x=p1.x+m*dirA.x;
              p1_1.y=p1.y+m*dirA.y;
              p1_1.z=p1.z+m*dirA.z;

              var p2_1=new THREE.Vector3();
              p2_1.x=p2.x+m*dirB.x;
              p2_1.y=p2.y+m*dirB.y;
              p2_1.z=p2.z+m*dirB.z;

              var p3_1=new THREE.Vector3();
              p3_1.x=p3.x+m*dirC.x;
              p3_1.y=p3.y+m*dirC.y;
              p3_1.z=p3.z+m*dirC.z;



              var vertices_tri=[
                p1_1,p2_1,p3_1
              ];

              var faces_tri=[
                new THREE.Face3(2,1,0),

              ];

              var vertices_face=[
                p1_1,p2_1,p3_1
              ];

              var geom_tri = new THREE.Geometry();
              geom_tri.vertices = vertices_tri;
              geom_tri.faces = faces_tri;
              geom_tri.computeFaceNormals();

              var geom_face = new THREE.Geometry();
              geom_face.vertices = vertices_tri;
              geom_face.faces = faces_tri;
              geom_face.computeFaceNormals();



              for (i = 0;i<geom_tri.faces.length;i++){
                if(Is_First)
                {
                  var hex =0x008000;
                  geom_tri.faces[i].color.setHex(hex);
                }
                else
                {
                  var hex =0xa9a9a9;
                  geom_tri.faces[i].color.setHex(hex);
                }

              }

              //  var materials = new THREE.MeshBasicMaterial( {
              // vertexColors: THREE.FaceColors
              // } );

              var materials_tri = [
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                // new THREE.MeshBasicMaterial({color: 0x4d4dff, wireframe: true,transparent: true,opacity:0.05}),
                new THREE.MeshBasicMaterial( {
                  vertexColors: THREE.FaceColors,transparent: true,opacity:0.2,side:THREE.DoubleSide
                } )
              ];

              var mesh_tri = new THREE.SceneUtils.createMultiMaterialObject(geom_tri, materials_tri);

              // return mesh_tri;

              //arrowHelper1.add(mesh_tri)

              //var arrowHelper1;

              // var hex = 0x000000;//black
              if(Is_First)

              var arr_face_material=new THREE.MeshPhongMaterial( {
                color:  0x009600//force face green
              } );
              else
              var arr_face_material=new THREE.MeshPhongMaterial( {
                color:  0x000000//force face black
              } );

              var arr_material2;

              if(arr_dir<0)//T or P
              {
                arrow_material2=new THREE.MeshPhongMaterial( {
                  color: 0xC00000//red
                });

              }
              else
              {
                arrow_material2=new THREE.MeshPhongMaterial( {

                  color: 0x0F3150//blue
                });

              }


              //in or out

              var forceFaceDir=Pnt_copy(arr_face_dir);
              forceFaceDir.normalize();

              //in or out dir
              var out1=new THREE.Vector3();
              out1.x=corepoint.x+0.2*forceFaceDir.x;
              out1.y=corepoint.y+0.2*forceFaceDir.y;
              out1.z=corepoint.z+0.2*forceFaceDir.z;


              var out2=new THREE.Vector3();
              out2.x=corepoint.x-0.2*forceFaceDir.x;
              out2.y=corepoint.y-0.2*forceFaceDir.y;
              out2.z=corepoint.z-0.2*forceFaceDir.z;

              var out1_core=new THREE.Vector3().subVectors(out1,corePoint_body);
              var out2_core=new THREE.Vector3().subVectors(out2,corePoint_body);

              if(out1_core.length()>out2_core.length())//out
              {


                var arrowHP1=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow

                // var direction1 = new THREE.Vector3().subVectors(p1_1, p3_1);
                // var length1=direction1.length();
                // direction1.normalize();
                // var arrowHelper1 = new THREE.ArrowHelper(direction1, p3_1, length1,hex,0.2,0.05);
                mesh_tri.add(arrowHP1);

                // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
                // var length2=direction2.length();
                // direction2.normalize();
                // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.2,0.05);
                var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
                mesh_tri.add(arrowHP2);

                // var direction3 = new THREE.Vector3().subVectors(p2_1, p1_1);
                // var length3=direction3.length();
                // direction3.normalize();
                // var arrowHelper3 = new THREE.ArrowHelper(direction3, p1_1, length3,hex,0.2,0.05);
                var arrowHP3=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
                mesh_tri.add(arrowHP3);

                //normal arrow

                var corepoint2=new THREE.Vector3();
                corepoint2.x=corepoint.x+0.4*forceFaceDir.x;
                corepoint2.y=corepoint.y+0.4*forceFaceDir.y;
                corepoint2.z=corepoint.z+0.4*forceFaceDir.z;

                var corepoint3=new THREE.Vector3();
                corepoint3.x=corepoint.x+0.37*forceFaceDir.x;
                corepoint3.y=corepoint.y+0.37*forceFaceDir.y;
                corepoint3.z=corepoint.z+0.37*forceFaceDir.z;



                //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
                if(Is_First)//apply 
                {
                  var arrow_material1=new THREE.MeshPhongMaterial( {
                    color: 0x009600
                  } );
                  var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.6);
                  //
                }
                else
                var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material2,0.02,0.05,0.6);


                mesh_tri.add(arrowN);

                if(Is_First)//apply 
                {
                  var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
                  var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);
                  //
                }
                else
                var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
                var arrowN_O=createCylinderArrowMesh(corepoint,corepoint3,arrow_material_outline,0.025,0.05,0.55);



                mesh_tri.add(arrowN_O);
                arrowN_O.scale.multiplyScalar(1.2);

                var TXMesh=createSpriteText(text,corepoint2);

                text_group2.add(TXMesh);

                //face arrow

                var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
                cir_dir.normalize();

                var arrowpt=new THREE.Vector3();
                arrowpt.x=corepoint.x+0.2*cir_dir.x;
                arrowpt.y=corepoint.y+0.2*cir_dir.y;
                arrowpt.z=corepoint.z+0.2*cir_dir.z;

                //arr_dir.normalize();

                var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

                //var direction1 = new THREE.Vector3().subVectors(p1, p2);
                var length1=0.001;
                direction1.normalize();
                var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.05);

                //        mesh_tri.add(arrowHelper1);


                //dir arrow

                var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
                mesh_tri.add(circle_mesh);

                //var step_1=createCircleFaceArrow2(TubePoints1[1],0.2,forceFaceDir);
                // Tube_group.add(step_1);


              }
              else
              {

                // var direction1 = new THREE.Vector3().subVectors(p2_1, p1_1);
                // var length1=direction1.length();
                // direction1.normalize();
                // var arrowHelper1 = new THREE.ArrowHelper(direction1, p1_1, length1,hex,0.1,0.05);
                var arrowHP1=createCylinderArrowMesh(p1_1,p2_1,arr_face_material,0.01,0.03,0.9);//face arrow
                mesh_tri.add(arrowHP1);

                // var direction2 = new THREE.Vector3().subVectors(p3_1, p2_1);
                // var length2=direction2.length();
                // direction2.normalize();
                // var arrowHelper2 = new THREE.ArrowHelper(direction2, p2_1, length2,hex,0.1,0.05);
                var arrowHP2=createCylinderArrowMesh(p2_1,p3_1,arr_face_material,0.01,0.03,0.9);//face arrow
                mesh_tri.add(arrowHP2);



                // var direction3 = new THREE.Vector3().subVectors(p1_1, p3_1);
                // var length3=direction3.length();
                // direction3.normalize();
                // var arrowHelper3 = new THREE.ArrowHelper(direction3, p3_1, length3,hex,0.1,0.05);
                var arrowHP3=createCylinderArrowMesh(p3_1,p1_1,arr_face_material,0.01,0.03,0.9);//face arrow
                mesh_tri.add(arrowHP3);



                var corepoint2=new THREE.Vector3();
                corepoint2.x=corepoint.x-0.4*forceFaceDir.x;
                corepoint2.y=corepoint.y-0.4*forceFaceDir.y;
                corepoint2.z=corepoint.z-0.4*forceFaceDir.z;

                var corepoint3=new THREE.Vector3();
                corepoint3.x=corepoint.x-0.37*forceFaceDir.x;
                corepoint3.y=corepoint.y-0.37*forceFaceDir.y;
                corepoint3.z=corepoint.z-0.37*forceFaceDir.z;

                if(Is_First)//apply 
                {
                  var arrow_material1=new THREE.MeshPhongMaterial( {
                    color: 0x009600
                  } );
                  //var arrowN=createCylinderArrowMesh(corepoint,corepoint2,arrow_material1,0.02,0.05,0.7);
                  var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material1,0.02,0.05,0.6);

                }
                else
                var arrowN=createCylinderArrowMesh(corepoint2,corepoint,arrow_material2,0.02,0.05,0.6);


                //=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);



                //normal arrow

                //var dirN=cross(direction2,direction1);

                //dirN.normalize();


                //var arrowN=new THREE.ArrowHelper(forceFaceDir,corepoint,0.5*forceFaceDir.length(),0x00ff00,0.2,0.1);
                mesh_tri.add(arrowN);

                if(Is_First)//apply 
                {
                  var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
                  var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);
                  //
                }
                else
                var arrow_material_outline= new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );
                var arrowN_O=createCylinderArrowMesh(corepoint3,corepoint,arrow_material_outline,0.025,0.05,0.55);



                mesh_tri.add(arrowN_O);
                arrowN_O.scale.multiplyScalar(1.2);

                var TXMesh1=createSpriteText(text,corepoint2);

                text_group2.add(TXMesh1);

                // var Line_center=new THREE.Vector3((p1.x+p2.x)/2,(p1.y+p2.y)/2,(p1.z+p2.z)/2);

                var cir_dir=new THREE.Vector3().subVectors(corepoint,p1);
                cir_dir.normalize();

                var arrowpt=new THREE.Vector3();
                arrowpt.x=corepoint.x+0.2*cir_dir.x;
                arrowpt.y=corepoint.y+0.2*cir_dir.y;
                arrowpt.z=corepoint.z+0.2*cir_dir.z;

                //arr_dir.normalize();

                var direction1=cir_dir.applyAxisAngle(forceFaceDir,Math.PI/2);

                //var direction1 = new THREE.Vector3().subVectors(p1, p2);
                var length1=0.001;
                direction1.normalize();
                var arrowHelper1 = new THREE.ArrowHelper(direction1, arrowpt, length1,"black",0.1,0.1);

                //            mesh_tri.add(arrowHelper1);


                //dir arrow

                var circle_mesh=createCircleFaceArrow(corepoint,0.2,forceFaceDir);
                mesh_tri.add(circle_mesh);

                //arrow




              }





            //normal arrow



            return mesh_tri;




            //var polyhedron =createMesh(new THREE.PolyhedronGeometry(vertices,faces));















            // var Scale_direction=new THREE.Vector3();

            // Scale_direction.x=1.2*unit_direction.x;
            // Scale_direction.y=1.2*unit_direction.y;
            // Scale_direction.z=1.2*unit_direction.z;


            //var direction1 = new THREE.Vector3().subVectors(coreScale, corepoint);




            //var dis=distance(,);//dis

            //console.log("m=",m);


            //var m=Math.sqrt((dis*dis)/(norm(unit_direction)*norm(unit_direction)));





            //console.log("p1=",p1,"p2=",p2,"p3=",p3,"p1_1=",p1_1,"p2_1=",p2_1,"p3_1=",p3_1,"direction",direction,"dis",dis);


            //mink



            //return arrowHelper1;








          }

          var fontloaded;


          function createTextMesh(text,position)
          {



            //var text = "three.js";
            var loader = new THREE.FontLoader();
            var posdir=Pnt_copy(position);

            posdir.normalize();





            loader.load('libs/fonts/optimer_regular.typeface.json', function (font1) {



              
              var fontMaterial = new THREE.MeshLambertMaterial({
                color: 0x2F4F4F,
                side: THREE.DoubleSide
              });


              var options={

                size: 0.15, //size
                height: 0.04, //h
                weight: 'normal', //b n
                font: font1, //
                style: 'italics', //
                bevelThickness: 0.01, //
                bevelSize: 0.01, //
                curveSegments: 10,//
                bevelEnabled: true, //

              }

              //var text1 = new THREE.FontLoader().load('libs/fonts/helvetiker_bold.typeface.json', function(text) {
              var gem = new THREE.TextGeometry(text, options);


              
              //var shapes = font1.generateShapes(text, 1, 1);
              // var fontGeometry = new THREE.ShapeGeometry(shapes);

              //fontGeometry.computeBoundingBox();
              var font2 = new THREE.Mesh(gem, fontMaterial);

         

              font2.position.x =position.x+0.5*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
              font2.position.y =position.y+0.5*posdir.y;
              font2.position.z =position.z+0.5*posdir.z;
              font2.rotation.x=Math.PI/2;
              font2.rotation.y=Math.PI/2;

              text_group1.add(font2);


            });





            //return font;





          }

          function createSpriteText(text,pos){
           
            var canvas = document.createElement("canvas");
            canvas.width=240;
            canvas.height=240;
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "black";
            ctx.font = "Bold 100px Palatino";
            ctx.lineWidth = 2;
            ctx.fillText(text.charAt(0),150,150);
            ctx.fillStyle = "black";
            ctx.font = "50px Palatino";
            ctx.lineWidth = 2;
            ctx.fillText(text.charAt(1),210,170);

            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

        
            var material = new THREE.SpriteMaterial({map:texture,depthWrite: false});
            var textObj = new THREE.Sprite(material);
            textObj.scale.set(0.5, 0.5, 0.5);


            //textObj.position.set(pos1);

            var posdir=Pnt_copy(pos);

            posdir.normalize();

            textObj.position.x =pos.x+0.2*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
            textObj.position.y =pos.y+0.3*posdir.y;
            textObj.position.z =pos.z+0.1*posdir.z;


            return textObj;
          }


          function createSpriteText3(text,pos){
          
            var canvas = document.createElement("canvas");
            canvas.width=240;
            canvas.height=240;
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "black";
            ctx.font = "Bold 100px Palatino";
            ctx.lineWidth = 2;
            ctx.fillText(text.charAt(0),150,150);
            ctx.fillStyle = "black";
            ctx.font = "50px Palatino";
            ctx.lineWidth = 2;
            ctx.fillText(text.charAt(1),190,170);

            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

         
            var material = new THREE.SpriteMaterial({map:texture,depthWrite: false});
            var textObj = new THREE.Sprite(material);
            textObj.scale.set(0.5, 0.5, 0.5);


            //textObj.position.set(pos1);

            var posdir=Pnt_copy(pos);

            posdir.normalize();

            textObj.position.x =pos.x+0.5*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
            textObj.position.y =pos.y+0.5*posdir.y;
            textObj.position.z =pos.z+0.5*posdir.z;


            return textObj;
          }

          function createSpriteText4(text,pos){
           
            var canvas = document.createElement("canvas");
            canvas.width=240;
            canvas.height=240;
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = 0xDCDCDC;
            ctx.font = "80px Arial";
            ctx.lineWidth = 2;
            ctx.fillText(text.charAt(0),150,150);
            ctx.fillStyle = 0xDCDCDC;
            ctx.font = "50px Arial";
            ctx.lineWidth = 2;
            ctx.fillText(text.charAt(1),190,150);

            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

        
            var material = new THREE.SpriteMaterial({map:texture,depthWrite: false});
            var textObj = new THREE.Sprite(material);
            textObj.scale.set(0.5, 0.5, 0.5);


            //textObj.position.set(pos1);

            var posdir=Pnt_copy(pos);

            posdir.normalize();

            textObj.position.x =pos.x+0.1*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
            textObj.position.y =pos.y+0.1*posdir.y;
            textObj.position.z =pos.z+0.1*posdir.z;


            return textObj;
          }

          function createSpriteText1(text,pos){
   
            var canvas = document.createElement("canvas");
            canvas.width=240;
            canvas.height=240;
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "black";
            ctx.font = "Bold 100px Palatino";
            ctx.lineWidth = 2;
            ctx.fillText(text,150,150);


            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            var material = new THREE.SpriteMaterial({map:texture,depthWrite: false});
            var textObj = new THREE.Sprite(material);
            textObj.scale.set(0.5, 0.5, 0.5);


            //textObj.position.set(pos1);

            var posdir=Pnt_copy(pos);

            posdir.normalize();

            textObj.position.x =pos.x+0.1*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
            textObj.position.y =pos.y+0.1*posdir.y;
            textObj.position.z =pos.z+0.1*posdir.z;


            return textObj;
          }

          function createSpriteTextstep1(text,pos){
        
            var canvas = document.createElement("canvas");
            canvas.width=240;
            canvas.height=240;
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "black";
            ctx.font = "60px Palatino";
            ctx.lineWidth = 2;
            ctx.fillText(text,150,150);


            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            var material = new THREE.SpriteMaterial({map:texture,depthWrite: false});
            var textObj = new THREE.Sprite(material);
            textObj.scale.set(0.5, 0.5, 0.5);


            //textObj.position.set(pos1);

            var posdir=Pnt_copy(pos);

            posdir.normalize();

            textObj.position.x =pos.x+0.1*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
            textObj.position.y =pos.y+0.1*posdir.y;
            textObj.position.z =pos.z+0.1*posdir.z;


            return textObj;
          }

          function createSpriteTextstep1_1(text,pos){
           
            var canvas = document.createElement("canvas");
            canvas.width=240;
            canvas.height=240;
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "black";
            ctx.font = "60px Palatino";
            ctx.lineWidth = 2;
            ctx.fillText(text,150,150);


            var texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

         
            var material = new THREE.SpriteMaterial({map:texture,depthWrite: false});
            var textObj = new THREE.Sprite(material);
            textObj.scale.set(0.5, 0.5, 0.5);


            //textObj.position.set(pos1);

            var posdir=Pnt_copy(pos);

            posdir.normalize();

            textObj.position.x =pos.x+0.1*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
            textObj.position.y =pos.y+0.1*posdir.y;
            textObj.position.z =pos.z+0.1


            return textObj;
          }

          function createTextMesh1(text,position)
          {



            //var text = "three.js";
            var loader = new THREE.FontLoader();
            var posdir=Pnt_copy(position);

            posdir.normalize();





            loader.load('libs/fonts/optimer_regular.typeface.json', function (font1) {



         
              var fontMaterial = new THREE.MeshLambertMaterial({
                color: 0x2F4F4F,
                side: THREE.DoubleSide
              });


              var options={

                size: 0.1, //size
                height: 0.03, //h
                weight: 'normal', //b n
                font: font1, //
                style: 'italics', //
                bevelThickness: 0.01, //
                bevelSize: 0.01, //
                curveSegments: 10,//
                bevelEnabled: true, //

              }

              //var text1 = new THREE.FontLoader().load('libs/fonts/helvetiker_bold.typeface.json', function(text) {
              var gem = new THREE.TextGeometry(text, options);


         
              //fontGeometry.computeBoundingBox();
              var font2 = new THREE.Mesh(gem, fontMaterial);


              font2.position.x =position.x+0.1*posdir.x; //* (fontGeometry.boundingBox.max.x - fontGeometry.boundingBox.min.x);
              font2.position.y =position.y+0.1*posdir.y;
              font2.position.z =position.z+0.1*posdir.z;
              font2.rotation.x=Math.PI/2;
              font2.rotation.y=Math.PI/2;

              text_group2.add(font2);


            });





            //return font;





          }



          function createCylinderArrowMesh(pointX, pointY, material, radius, radiusCone, edgeLengthRatio) {

            var direction = new THREE.Vector3().subVectors(pointY, pointX);
            var l = direction.length();

            if (radius === undefined) {
              radius = l * 0.01;
            }

            // fixedConeLength = fixedConeLength !== undefined ? fixedConeLength : 4;

            if (radiusCone === undefined) {
              radiusCone = 2 * radius;
            }

            // edgeLengthRatio = edgeLengthRatio !== undefined ? edgeLengthRatio : 0.7 ;

            var pointMid = new THREE.Vector3().addVectors(pointX, edgeLengthRatio * direction);

            var orientation = new THREE.Matrix4();
            orientation.lookAt(pointX, pointY, new THREE.Object3D().up);
            orientation.multiply(new THREE.Matrix4().set(1, 0, 0, 0,
              0, 0, 1, 0,
              0, -1, 0, 0,
              0, 0, 0, 1));

              var edgeGeometry;
              var coneGeometry;
              if (edgeLengthRatio !== undefined) {
                edgeGeometry = new THREE.CylinderGeometry(radius, radius, edgeLengthRatio * l, 8, 1);
                coneGeometry = new THREE.CylinderGeometry(0, radiusCone, (1-edgeLengthRatio) * l, 8, 1);
                edgeGeometry.translate( 0,  -(0.5 - 0.5 * edgeLengthRatio) * l, 0 );
                var translate = new THREE.Matrix4().makeTranslation( 0,  (0.5 - 0.5 * (1 - edgeLengthRatio)) * l, 0 );
                edgeGeometry.merge(coneGeometry, translate);
              } else {
                // fixed length cone
                var fixedConeLength = 1;
                edgeGeometry = new THREE.CylinderGeometry(radius, radius, l - fixedConeLength, 8, 1);
                coneGeometry = new THREE.CylinderGeometry(0, radiusCone, fixedConeLength, 8, 1);
                edgeGeometry.translate( 0, - 0.5 * fixedConeLength, 0 );
                var translate = new THREE.Matrix4().makeTranslation( 0, 0.5 * (l - fixedConeLength), 0 );
                edgeGeometry.merge(coneGeometry, translate);
              }



              var arrow = new THREE.Mesh(edgeGeometry, material);

              arrow.applyMatrix4(orientation);

              arrow.position.x = (pointY.x + pointX.x) / 2;
              arrow.position.y = (pointY.y + pointX.y) / 2;
              arrow.position.z = (pointY.z + pointX.z) / 2;



              return arrow;
            }

            window.addEventListener( 'keydown', function ( event ) {

              switch ( event.keyCode ) {

                case 87: // W
                trfm_ctrl.detach();
                //scene.remove(trfm_ctrl);
                break;


              }

            } );




            var leftMouseDown, rightMouseDown;
            var selectObj=null;
            var lastPosition;
            var lastIntersection, nowIntersection;
            var mouseX, mouseY;
            var control;
            // var mouse = new THREE.Vector2();

            function onMouseDown(event) {
              //event.preventDefault();

              rayCaster.setFromCamera(mouse, camera);


              //var rayCaster = getRay(event);
              var intersects = rayCaster.intersectObjects(Ctrl_pts);
             
              if (event.button === 2) { 

                trfm_ctrl.detach();





              }



              //document.addEventListener('mousemove', onMouseMove);


              if (event.button === 0&&intersects[0]) {



                selectObj = intersects[0].object;
                console.log("selectobj.name="+intersects[0].object.name.charAt(2));
               
                lastPosition = selectObj.position;
                

                if(controls_scale.Pair_Control)
                {

                  for(i=0;i<=1;i++){
                    mesh_F1_pair.children[i].material.visible=false;
                    mesh_F2_pair.children[i].material.visible=false;
                    mesh_F3_pair.children[i].material.visible=false;
                    mesh_F4_pair.children[i].material.visible=false;
                    mesh_left_pair.children[i].material.visible=false;
                  }

                  redraw();
                  for(i=0;i<=1;i++){
                    mesh.children[i].material.visible=true;
                  }

                  // mesh_left_ForceFace.children.forEach(function (e) {
                  //     e.geometry.vertices = vertices;
                  //     e.geometry.verticesNeedUpdate = true;

                  //     // e.geometry.faces[0].color.set(0xff00ee);
                  //     // e.geometry.facesNeedUpdate=true;
                  //     e.geometry.elementsNeedUpdate = true;
                  //     e.geometry.computeFaceNormals();
                  //     //e.geometry.center();
                  // });

                  Tube_group_pair.traverse(function(obj) {//hide group
                    if (obj.type === "Mesh") {
                      obj.material.visible =false;
                    }
                  });

                  for(i=0;i<=1;i++){
                    mesh_left.children[i].material.visible=false;
                  }
                  mesh_F1.children[0].material.visible=false;
                  mesh_F2.children[0].material.visible=false;
                  mesh_F3.children[0].material.visible=false;
                  mesh_F4.children[0].material.visible=false;
                }










                trfm_ctrl.attach(selectObj);
                // leftMouseDown = true;
              }

              // mouseX = event.clientX;
              // mouseY = event.clientY;

              //document.addEventListener('mousemove', onMouseMove);
            }


            function onMouseUp(event) {
              leftMouseDown = false;
              rightMouseDown = false;
              //document.removeEventListener('mousemove', onMouseMove);
            }

            function onMouseMove(event) {
              

              event.preventDefault();
              mouse.x = ((event.clientX*2)/window.innerWidth) * 2 - 1;
              mouse.y = -(event.clientY/window.innerHeight) * 2 + 1;

              //mouse.x = ((event.clientX*2)/window.innerWidth) * 2 - 1;
              // mouse.y = -(event.clientY/window.innerHeight) * 2 + 1;

              //event.clientX=event.clientX/2;


              if (rightMouseDown) {
               
              }
             
              if (leftMouseDown) {

                for(i=0;i<=1;i++){

                  mesh_left.children[i].material.visible=false;
                }
                mesh_F1.children[0].material.visible=false;
                mesh_F2.children[0].material.visible=false;
                mesh_F3.children[0].material.visible=false;
                mesh_F4.children[0].material.visible=false;


                for(i=0;i<2;i++)
                {
                  mesh_left_Cell1.children[i].material.visible=false;
                  mesh_left_Cell2.children[i].material.visible=false;
                  mesh_left_Cell3.children[i].material.visible=false;
                  mesh_left_Cell4.children[i].material.visible=false;

                }


                // var deltaX = event.clientX - mouseX;
                // mouseX = event.clientX;
                // var deltaY = event.clientY - mouseY;
                // mouseY = event.clientY;
                // rotation(deltaX, deltaY);
              }
            }



            function redraw_right(){

              scene2.remove(Tube_group_right);
              //scene.remove(Face_group_left);
              Tube_group_right=new THREE.Group();
              //Face_group_left=new THREE.Group();


              var materialA = new THREE.MeshPhongMaterial({color: 0xdcdcdc, transparent: false});

              var spGeomA = new THREE.SphereGeometry(0.02);
              var sp_TubeA= new THREE.Mesh(spGeomA, materialA);

              sp_TubeA.name="fpA0";
              sp_TubeA.position.copy(P_A_Right);
              //sp_Tube0.castShadow=true;

              //Ctrl_tubes.push(sp_TubeA);


              Tube_group_right.add(sp_TubeA);

              var materialB = new THREE.MeshPhongMaterial({color: 0xdcdcdc, transparent: false});

              var spGeomB = new THREE.SphereGeometry(0.02);
              var sp_TubeB= new THREE.Mesh(spGeomB, materialB);

              sp_TubeB.name="fpB1";
              sp_TubeB.position.copy(P_B_Right);
              //sp_Tube0.castShadow=true;

              //Ctrl_tubes.push(sp_TubeB);


              Tube_group_right.add(sp_TubeB);

              var materialC = new THREE.MeshPhongMaterial({color: 0xdcdcdc, transparent: false});

              var spGeomC = new THREE.SphereGeometry(0.02);
              var sp_TubeC= new THREE.Mesh(spGeomC, materialC);

              sp_TubeC.name="fpC2";
              sp_TubeC.position.copy(P_C_Right);
              //sp_Tube0.castShadow=true;

              ///Ctrl_tubes.push(sp_TubeC);


              Tube_group_right.add(sp_TubeC);

              var materialD = new THREE.MeshPhongMaterial({color: 0xdcdcdc, transparent: false});

              var spGeomD = new THREE.SphereGeometry(0.02);
              var sp_TubeD= new THREE.Mesh(spGeomD, materialD);

              sp_TubeD.name="fpD3";
              sp_TubeD.position.copy(P_D_Right);



              //sp_Tube0.castShadow=true;

              //Ctrl_tubes.push(sp_TubeD);


              Tube_group_right.add(sp_TubeD);



              var materialAB = new THREE.MeshPhongMaterial({color: 0xc0c0c0, transparent: false});
              var tubeMeshAB=createCylinderMesh(P_A_Right,P_B_Right,materialAB,0.01,0.01);

              tubeMeshAB.name="ftAB0";
              Ctrl_tubes.push(tubeMeshAB);

              Tube_group_right.add(tubeMeshAB);

              var materialBC = new THREE.MeshPhongMaterial({color: 0xc0c0c0, transparent: false});
              var tubeMeshBC=createCylinderMesh(P_B_Right,P_C_Right,materialBC,0.01,0.01);

              tubeMeshBC.name="ftBC1";
              Ctrl_tubes.push(tubeMeshBC);

              Tube_group_right.add(tubeMeshBC);

              var materialAC = new THREE.MeshPhongMaterial({color: 0xc0c0c0, transparent: false});
              var tubeMeshAC=createCylinderMesh(P_A_Right,P_C_Right,materialAC,0.01,0.01);

              tubeMeshAC.name="ftAC2";
              Ctrl_tubes.push(tubeMeshAC);

              Tube_group_right.add(tubeMeshAC);

              var materialAD = new THREE.MeshPhongMaterial({color: 0xc0c0c0, transparent: false});
              var tubeMeshAD=createCylinderMesh(P_A_Right,P_D_Right,materialAD,0.01,0.01);

              tubeMeshAD.name="ftAD3";
              Ctrl_tubes.push(tubeMeshAD);

              Tube_group_right.add(tubeMeshAD);


              var materialBD = new THREE.MeshPhongMaterial({color: 0xc0c0c0, transparent: false});
              var tubeMeshBD=createCylinderMesh(P_B_Right,P_D_Right,materialBD,0.01,0.01);

              tubeMeshBD.name="ftBD4";
              Ctrl_tubes.push(tubeMeshBD);

              Tube_group_right.add(tubeMeshBD);

              var materialCD = new THREE.MeshPhongMaterial({color: 0xc0c0c0, transparent: false});
              var tubeMeshCD=createCylinderMesh(P_C_Right,P_D_Right,materialCD,0.01,0.01);

              tubeMeshCD.name="ftCD5";
              Ctrl_tubes.push(tubeMeshCD);

              Tube_group_right.add(tubeMeshCD);

              scene2.add(Tube_group_right);

            }



            function redraw_Faces6(){
            

              var vertices = [
                new THREE.Vector3(0,0,0),TubePoints1[1],TubePoints2[1],TubePoints3[1],TubePoints4[1]
              ];


              //console.log("TubePoints1="+P_A.z);

              // for (i = 0;i<geom.faces.length;i++){
              //         var hex = Math.random() * 0xffffff;
              //         geom.faces[i].color.setHex(hex);
              //     }

              mesh_left_ForceFace.children.forEach(function (e) {
                e.geometry.vertices = vertices;
                e.geometry.verticesNeedUpdate = true;

                // e.geometry.faces[0].color.set(0xff00ee);
                // e.geometry.facesNeedUpdate=true;
                e.geometry.elementsNeedUpdate = true;
                e.geometry.computeFaceNormals();
                //e.geometry.center();
              });
            }




            function redraw_Cell()
            {

              var vertices = [
                new THREE.Vector3(0,0,0),TubePoints1[1],TubePoints2[1],TubePoints3[1],TubePoints4[1]
              ];

              mesh_left_Cell1.children.forEach(function (e) {
                e.geometry.vertices = vertices;
                e.geometry.verticesNeedUpdate = true;

                // e.geometry.faces[0].color.set(0xff00ee);
                // e.geometry.facesNeedUpdate=true;
                e.geometry.elementsNeedUpdate = true;
                e.geometry.computeFaceNormals();
                //e.geometry.center();
              });

              mesh_left_Cell2.children.forEach(function (e) {
                e.geometry.vertices = vertices;
                e.geometry.verticesNeedUpdate = true;

                // e.geometry.faces[0].color.set(0xff00ee);
                // e.geometry.facesNeedUpdate=true;
                e.geometry.elementsNeedUpdate = true;
                e.geometry.computeFaceNormals();
                //e.geometry.center();
              });

              mesh_left_Cell3.children.forEach(function (e) {
                e.geometry.vertices = vertices;
                e.geometry.verticesNeedUpdate = true;

                // e.geometry.faces[0].color.set(0xff00ee);
                // e.geometry.facesNeedUpdate=true;
                e.geometry.elementsNeedUpdate = true;
                e.geometry.computeFaceNormals();
                //e.geometry.center();
              });

              mesh_left_Cell4.children.forEach(function (e) {
                e.geometry.vertices = vertices;
                e.geometry.verticesNeedUpdate = true;

                // e.geometry.faces[0].color.set(0xff00ee);
                // e.geometry.facesNeedUpdate=true;
                e.geometry.elementsNeedUpdate = true;
                e.geometry.computeFaceNormals();
                //e.geometry.center();
              });
            }

   



            var mesh_TriFace1;
            var mesh_TriFace2;
            var mesh_TriFace3;
            var mesh_TriFace4;
            var mesh_TriFace_step_f1;
            var mesh_TriFace_step_f2;
            var mesh_TriFace_step_f21;
            var mesh_TriFace_step_f3;
            var mesh_TriFace_step_f4;


            var text_group1;
            var text_group2;
            var Tube_group_pair;
            var Tube_group_force;











            function redraw(){


              scene.remove(Tube_group);
              // scene2.remove(Tube_group_pair);
              Ctrl_pts=[];
              Ctrl_tubes=[];
              scene.remove(step_group_1);
              scene.remove(step_group_2);
              scene.remove(step_group_cell);
              // scene2.remove(face_arrow1);
              // scene2.remove(face_arrow2);
              // scene2.remove(face_arrow3);
              // scene2.remove(face_arrow4);

              scene2.remove(step_group_1_1);
              scene2.remove(mesh_TriFace1);
              scene2.remove(mesh_TriFace2);
              scene2.remove(mesh_TriFace3);
              scene2.remove(mesh_TriFace4);
              scene2.remove(mesh_TriFace_step_f1);
              scene2.remove(mesh_TriFace_step_f2);
              scene2.remove(mesh_TriFace_step_f21);
              scene2.remove(mesh_TriFace_step_f3);
              scene2.remove(mesh_TriFace_step_f4);

              scene2.remove(Tube_group_force);

              scene.remove(text_group1);
              scene2.remove(text_group2);

              // scene.remove(textf1);
              // scene.remove(textf2);



      
              var arr_direction=arrow_direction(TubePoints1[1],TubePoints2[1],TubePoints3[1],TubePoints4[1]);

              console.log("n1=",TubePoints1[1],"n2=",TubePoints2[1],"n3=",TubePoints3[1],"n4=",TubePoints4[1]);

              var arrow_material2=new THREE.MeshPhongMaterial({
                color: 0xC00000
              } );






              Tube_group=new THREE.Group();
              step_group_1=new THREE.Group();
              step_group_2=new THREE.Group();
              step_group_1_1=new THREE.Group();
              step_group_cell=new THREE.Group();
              // Tube_group_pair=new THREE.Group();
              Tube_group_force=new THREE.Group();
              text_group1=new THREE.Group();
              text_group2=new THREE.Group();

              var material = new THREE.MeshPhongMaterial({color: "lightgrey", transparent: false});

              var spGeom0 = new THREE.SphereGeometry(0.05);
              var sp_Tube0 = new THREE.Mesh(spGeom0, material);


              sp_Tube0.name="sp0";
              sp_Tube0.position.copy(new THREE.Vector3(0,0,0));
              sp_Tube0.castShadow=true;

              Ctrl_tubes.push(sp_Tube0);

              var outlineMaterial1 = new THREE.MeshBasicMaterial( { color: "black", transparent: false, side: THREE.BackSide } );
              var outlineMesh1 = new THREE.Mesh( spGeom0, outlineMaterial1 );
              outlineMesh1.position = sp_Tube0.position;
              outlineMesh1.scale.multiplyScalar(1.55);
              Tube_group.add( outlineMesh1 );
              //scene.add(text0);
              //text0.position.copy(new THREE.vertices(0.2,0,0));
              //text_group1.add(text0);

              Tube_group.add(sp_Tube0);
              //add the points as a group to the scene
              //scene.add(spMesh);



              var SphereTest = new THREE.Sphere(new THREE.Vector3(0,0,0),0.07);
              var PointClose1 = SphereTest.clampPoint(TubePoints2[1]);
              var SphereTest2 = new THREE.Sphere(PointClose1,0.05);
              var PointClose2 = SphereTest2.clampPoint(TubePoints2[1]);
              var SphereTest3 = new THREE.Sphere(PointClose2,0.045);

              var arrow_apply_1=new THREE.MeshPhongMaterial( {
                color:  0x009600//green
              } );


              var SphereTest4 = new THREE.Sphere(new THREE.Vector3(0,0,0),0.75);
              var PointClose3 = SphereTest4.clampPoint(TubePoints1[1]);
              var tubeMesh_apply_1=createCylinderMesh(PointClose3,TubePoints1[1],arrow_apply_1,0.01,0.01);
              //Tube_group.add(tubeMesh_apply_1);

  //construct apply load dash line
              var o = new THREE.Vector3(0,0,0)
              var od1 = o.distanceTo(TubePoints1[1]);

              var dl0 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.08/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.08/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.08/od1));
              var dl1 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.25/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.25/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.25/od1));

              var dl2 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.28/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.28/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.28/od1));
              var dl3 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.45/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.45/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.45/od1));

              var dl4 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.48/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.48/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.48/od1));
              var dl5 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.65/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.65/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.65/od1));

              var dl6 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.68/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.68/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.68/od1));
              var dl7 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.85/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.85/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.85/od1));

              var dl8 = new THREE.Vector3((TubePoints1[0].x + (TubePoints1[1].x-TubePoints1[0].x)*0.88/od1),(TubePoints1[0].y + (TubePoints1[1].y-TubePoints1[0].y)*0.88/od1),(TubePoints1[0].z + (TubePoints1[1].z-TubePoints1[0].z)*0.88/od1));

              var al1 = createCylinderMesh(dl0,dl1,arrow_apply_1,0.01,0.01);
              Tube_group.add(al1);
              var al2 = createCylinderMesh(dl2,dl3,arrow_apply_1,0.01,0.01);
              Tube_group.add(al2);
              var al3 = createCylinderMesh(dl4,dl5,arrow_apply_1,0.01,0.01);
              Tube_group.add(al3);
              var al4 = createCylinderMesh(dl6,dl7,arrow_apply_1,0.01,0.01);
              Tube_group.add(al4);
              var al5 = createCylinderMesh(dl8,TubePoints1[1],arrow_apply_1,0.01,0.01);
              Tube_group.add(al5);

              var step_1=createCircleFaceArrow2(TubePoints1[1],0.2,Force_face_dir[0]);
              step_group_1.add(step_1);

  //construct form faces for step 1 - face 1



              var stepface12 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.75);
              var PointClosestepface12 = stepface12.clampPoint(TubePoints1[0]);

              var stepface1 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.9);
              var PointClosestepface1 = stepface1.clampPoint(TubePoints2[1]);
              var PointClosestepface13 = stepface1.clampPoint(TubePoints3[1]);

              var spacedivide = new THREE.Vector3(PointClosestepface1.x,PointClosestepface1.y,PointClosestepface12.z);
              var spacedivide_2 = new THREE.Vector3(TubePoints2[1].x,TubePoints2[1].y,PointClosestepface1.z);
              var spacedivide_23 = new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,PointClosestepface1.z);




              var cb = new THREE.Vector3(),
              ab = new THREE.Vector3(),
              normal1 = new THREE.Vector3();
              cb.subVectors(PointClosestepface1, PointClosestepface12);
              ab.subVectors(TubePoints1[1], PointClosestepface12);
              cb.cross(ab);
              normal1.copy(cb).normalize();

              var nn = new THREE.Vector3(0.6*normal1.x, 0.6*normal1.y, normal1.z)


                            var cb3 = new THREE.Vector3(),
                            ab3 = new THREE.Vector3(),
                            normal13 = new THREE.Vector3();
                            cb3.subVectors(PointClosestepface13, PointClosestepface12);
                            ab3.subVectors(TubePoints1[1], PointClosestepface12);
                            cb3.cross(ab3);
                            normal13.copy(cb3).normalize();

                            var nn3 = new THREE.Vector3(0.2*normal13.x, 0.2*normal13.y, normal13.z)


              var stepface2 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.9);
              var PointClosestepface2 = stepface2.clampPoint(TubePoints4[1]);
              var cb12 = new THREE.Vector3(),
              ab12 = new THREE.Vector3(),
              normal12 = new THREE.Vector3();
              cb12.subVectors(PointClosestepface2, PointClosestepface12);
              ab12.subVectors(TubePoints1[1], PointClosestepface12);
              cb12.cross(ab12);
              normal12.copy(cb12).normalize();

              var nn12 = new THREE.Vector3(0.2*normal12.x, 0.2*normal12.y, normal12.z)

              var stepface2 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.9);
              var PointClosestepface3 = stepface2.clampPoint(TubePoints3[1]);
              var cb13 = new THREE.Vector3(),
              ab13 = new THREE.Vector3(),
              normal13 = new THREE.Vector3();
              cb13.subVectors(PointClosestepface3, PointClosestepface12);
              ab13.subVectors(TubePoints1[1], PointClosestepface12);
              cb13.cross(ab13);
              normal13.copy(cb13).normalize();

              var nn13 = new THREE.Vector3(0.2*normal13.x, 0.2*normal13.y, normal13.z)


              var p1 = new THREE.Vector3(PointClosestepface12.x, PointClosestepface12.y, PointClosestepface12.z);
              var p2 = new THREE.Vector3(TubePoints2[1].x, TubePoints2[1].y, PointClosestepface12.z);

              var p3 = new THREE.Vector3(PointClosestepface12.x, PointClosestepface12.y, PointClosestepface12.z);
              var p4 = new THREE.Vector3(TubePoints4[1].x, TubePoints4[1].y, PointClosestepface12.z);

              var p5 = new THREE.Vector3(PointClosestepface12.x, PointClosestepface12.y, PointClosestepface12.z);
              var p6 = new THREE.Vector3(TubePoints3[1].x, TubePoints3[1].y, PointClosestepface12.z);


              function distanceVector( v1, v2 )
              {
                var dx = v1.x - v2.x;
                var dy = v1.y - v2.y;
                var dz = v1.z - v2.z;

                return Math.sqrt( dx * dx + dy * dy + dz * dz );
              }

              var l2 = distanceVector(p1, p2);
              var pt_t = new THREE.Vector3((PointClosestepface12.x + (0.5/(l2-0.5))*TubePoints2[1].x)/(1+0.5/(l2-0.5)),(PointClosestepface12.y + (0.5/(l2-0.5))*TubePoints2[1].y)/(1+0.5/(l2-0.5)),(PointClosestepface12.z + (0.5/(l2-0.5))*PointClosestepface12.z)/(1+0.5/(l2-0.5)));

              var l3 = distanceVector(p3, p4);
              var pt_t2 = new THREE.Vector3((PointClosestepface12.x + (0.5/(l3-0.5))*TubePoints4[1].x)/(1+0.5/(l3-0.5)),(PointClosestepface12.y + (0.5/(l3-0.5))*TubePoints4[1].y)/(1+0.5/(l3-0.5)),(PointClosestepface12.z + (0.5/(l3-0.5))*PointClosestepface12.z)/(1+0.5/(l3-0.5)));

              var l4 = distanceVector(p5, p6);
              var pt_t3 = new THREE.Vector3((PointClosestepface12.x + (0.5/(l4-0.5))*TubePoints3[1].x)/(1+0.5/(l4-0.5)),(PointClosestepface12.y + (0.5/(l4-0.5))*TubePoints3[1].y)/(1+0.5/(l4-0.5)),(PointClosestepface12.z + (0.5/(l4-0.5))*PointClosestepface12.z)/(1+0.5/(l4-0.5)));


              var step1_arr2 = new THREE.MeshPhongMaterial({color:0x009600});

              var new1 = new THREE.Vector3(nn3.x+pt_t3.x, nn3.y+pt_t3.y, nn3.z+pt_t3.z);
              var new11 = new THREE.Vector3(nn.x+pt_t.x, nn.y+pt_t.y, nn.z+pt_t.z);
              var vecab = new THREE.Vector3(new1.x - pt_t3.x, new1.y - pt_t3.y,new1.z - pt_t3.z);
              var spacedivide_geo1a1 = createCylinderArrowMesh(pt_t,new11,step1_arr2,0.01,0.02,0.6);

              var lterA = new THREE.Vector3((pt_t.x+pt_t3.x)/2,(pt_t.y+pt_t3.y)/2,(pt_t.z+pt_t3.z)/2);
              var oldLength = lterA.distanceTo(new THREE.Vector3(PointClosestepface12.x,PointClosestepface12.y,PointClosestepface12.z));
              // var jiaodu = pt_t.angleTo(pt_t3);
              // var degrees1 = THREE.Math.radToDeg(jiaodu );
              var jiaodu2 = pt_t3.angleTo(pt_t);
              var degrees2 = THREE.Math.radToDeg(jiaodu2 );

              var j1 = new THREE.Vector3(TubePoints2[1].x, TubePoints2[1].y, 0);
              var j2 = new THREE.Vector3(TubePoints3[1].x, TubePoints3[1].y, 0);
              var j3 = new THREE.Vector3(TubePoints4[1].x, TubePoints4[1].y, 0);
              var jiaodu = j1.angleTo(j2);
              var degrees1 = THREE.Math.radToDeg(jiaodu );
              var ol1=j1.distanceTo(j2);
              var ol2=j2.distanceTo(j3);

              if(ol1>ol2 & ol1<1){
              var TXMeshST1=createSpriteTextstep1("A",new THREE.Vector3((PointClosestepface12.x - (lterA.x-PointClosestepface12.x)*0.5/oldLength), (PointClosestepface12.y - (lterA.y-PointClosestepface12.y)*0.5/oldLength), (PointClosestepface12.z - (lterA.z-PointClosestepface12.z)*0.5/oldLength)));
              // step_group_1.add(TXMeshST1);
            };
              if(degrees1 < (360 -degrees1)){
              var TXMeshST1=createSpriteTextstep1("A",new THREE.Vector3((PointClosestepface12.x + (lterA.x-PointClosestepface12.x)*0.5/oldLength), (PointClosestepface12.y + (lterA.y-PointClosestepface12.y)*0.5/oldLength), (PointClosestepface12.z + (lterA.z-PointClosestepface12.z)*0.5/oldLength)));
                // step_group_1.add(TXMeshST1);}

              };
                step_group_1.add(TXMeshST1);

                console.log("de=",degrees1);

       

              //add step arrow 1
              step_group_1.add(spacedivide_geo1a1);

              var new12 = new THREE.Vector3(nn12.x+pt_t2.x, nn12.y+pt_t2.y, nn12.z+pt_t2.z);
              var vecab12 = new THREE.Vector3(new12.x - pt_t2.x, new12.y - pt_t2.y,new12.z - pt_t2.z);
              var spacedivide_geo1a2 = createCylinderArrowMesh(pt_t2,new12,step1_arr2,0.01,0.02,0.6);

              var TXMeshST2=createSpriteTextstep1("B",new THREE.Vector3(1.2*(pt_t2.x+pt_t3.x)/2,1.2*(pt_t2.y+pt_t3.y)/2,(pt_t2.z+pt_t3.z)/2));
              step_group_1.add(TXMeshST2);

              //add step arrow 1
              step_group_1.add(spacedivide_geo1a2);

              var new13 = new THREE.Vector3(nn13.x+pt_t3.x, nn13.y+pt_t3.y, nn13.z+pt_t3.z);
              var vecab13 = new THREE.Vector3(new13.x - pt_t3.x, new13.y - pt_t3.y,new13.z - pt_t3.z);
              var spacedivide_geo1a3 = createCylinderArrowMesh(pt_t3,new13,step1_arr2,0.01,0.02,0.6);

              var lterA2 = new THREE.Vector3((pt_t.x+pt_t2.x)/2,(pt_t.y+pt_t2.y)/2,(pt_t.z+pt_t2.z)/2);
              var oldLength2 = lterA2.distanceTo(new THREE.Vector3(PointClosestepface12.x,PointClosestepface12.y,PointClosestepface12.z));
              var jiaodu_2 = pt_t.angleTo(pt_t2);
              var jiaodu2_2 = pt_t2.angleTo(pt_t);

              //var TXMeshST3=createSpriteTextstep1("C",new THREE.Vector3(1.2*(pt_t.x+pt_t2.x)/2,1.2*(pt_t.y+pt_t2.y)/2,(pt_t.z+pt_t2.z)/2));
              // step_group_1.add(TXMeshST3);

              if(jiaodu_2 >= jiaodu2_2){
              var TXMeshST3=createSpriteTextstep1("C",new THREE.Vector3((PointClosestepface12.x + (lterA2.x-PointClosestepface12.x)*0.5/oldLength2), (PointClosestepface12.y + (lterA2.y-PointClosestepface12.y)*0.5/oldLength2), (PointClosestepface12.z + (lterA2.z-PointClosestepface12.z)*0.5/oldLength2)));
              // step_group_1.add(TXMeshST1);
              }
              else {
              var TXMeshST3=createSpriteTextstep1("C",new THREE.Vector3((PointClosestepface12.x - (lterA2.x-PointClosestepface12.x)*0.5/oldLength2), (PointClosestepface12.y - (lterA2.y-PointClosestepface12.y)*0.5/oldLength2), (PointClosestepface12.z - (lterA2.z-PointClosestepface12.z)*0.5/oldLength2)));
                // step_group_1.add(TXMeshST1);}

              };
                step_group_1.add(TXMeshST3);

              //add step arrow 1
              step_group_1.add(spacedivide_geo1a3);


              //add step divider 1
              var spacedivide_geo1 = createCylinderMesh(pt_t,PointClosestepface12,new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.6}),0.008,0.008);

              step_group_1.add( spacedivide_geo1 );

              var spacedivide_geo12 = createCylinderMesh(pt_t2,PointClosestepface12,new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.6}),0.008,0.008);

              step_group_1.add( spacedivide_geo12 );

              var spacedivide_geo13 = createCylinderMesh(pt_t3,PointClosestepface12,new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.6}),0.008,0.008);

              step_group_1.add( spacedivide_geo13 );

              var vertices = [
                pt_t,TubePoints1[1],PointClosestepface12
              ];

              var faces = [
                new THREE.Face3(0, 1, 2),
              ];


              var geom = new THREE.Geometry();
              geom.vertices = vertices;
              geom.faces = faces;
              geom.computeFaceNormals();
              var material_step_1 = [
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.2}),
                new THREE.MeshPhongMaterial({
                  color: 0x009600,transparent: true,opacity:0.3,side:THREE.DoubleSide,depthWrite:false
                } )
              ];

              var step_1_face_1 = THREE.SceneUtils.createMultiMaterialObject(geom, material_step_1);

              //add step face 1
              step_group_1.add(step_1_face_1);



              //construct form faces step 1 - face 2

              var stepface2 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.9);
              var PointClosestepface2 = stepface2.clampPoint(TubePoints4[1]);

              var spacedivide2 = new THREE.Vector3(PointClosestepface2.x,PointClosestepface2.y,PointClosestepface12.z);
              var spacedivide2_2 = new THREE.Vector3(TubePoints4[1].x,TubePoints4[1].y,PointClosestepface2.z);


              var stepface22 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.75);
              var PointClosestepface22 = stepface22.clampPoint(TubePoints1[0]);

              var vertices = [
                pt_t2,TubePoints1[1],PointClosestepface22
              ];

              var faces = [
                new THREE.Face3(0, 1, 2),


              ];

              var geom = new THREE.Geometry();
              geom.vertices = vertices;
              geom.faces = faces;
              geom.computeFaceNormals();
              var material_step_2 =[
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.2}),
                new THREE.MeshPhongMaterial({
                  color: 0x009600,transparent: true,opacity:0.3,side:THREE.DoubleSide,depthWrite:false
                } )
              ];

              var step_1_face_2 = THREE.SceneUtils.createMultiMaterialObject(geom, material_step_2);
              step_group_1.add(step_1_face_2);


              var cb2 = new THREE.Vector3(),
              ab2 = new THREE.Vector3(),
              normal2 = new THREE.Vector3();
              cb2.subVectors(PointClosestepface2, PointClosestepface22);
              ab2.subVectors(TubePoints1[1], PointClosestepface22);
              cb2.cross(ab2);
              normal2.copy(cb2).normalize();

              var nn2 = new THREE.Vector3(0.2*normal2.x, 0.2*normal2.y, normal2.z)



              //construct form faces step 1 - face 3

              var stepface3 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.9);
              var PointClosestepface3 = stepface3.clampPoint(TubePoints3[1]);

              var spacedivide3 = new THREE.Vector3(PointClosestepface3.x,PointClosestepface3.y,PointClosestepface12.z);
              var spacedivide3_2 = new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,PointClosestepface3.z);

              var stepface32 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.75);
              var PointClosestepface32 = stepface32.clampPoint(TubePoints1[0]);

              var vertices = [
                pt_t3,TubePoints1[1],PointClosestepface32
              ];

              var faces = [
                new THREE.Face3(0, 1, 2),
              ];

              var geom = new THREE.Geometry();
              geom.vertices = vertices;
              geom.faces = faces;
              geom.computeFaceNormals();

              var material_step_3 = [
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.2}),
                new THREE.MeshPhongMaterial({
                  color: 0x009600,transparent: true,opacity:0.3,side:THREE.DoubleSide,depthWrite:false
                } )
              ];


              var step_1_face_3 = THREE.SceneUtils.createMultiMaterialObject(geom, material_step_3);
              //          var material_step_3 = new THREE.MeshPhongMaterial({color: 0x009600, transparent: true, opacity:0.3, side: THREE.DoubleSide});
              //          var step_1_face_3 = new THREE.Mesh(geom,material_step_3);
              step_group_1.add(step_1_face_3);

//construct form faces for step 1 - face 1



              var cb3 = new THREE.Vector3(),
              ab3 = new THREE.Vector3(),
              normal3 = new THREE.Vector3();
              cb3.subVectors(PointClosestepface3, PointClosestepface32);
              ab3.subVectors(TubePoints1[1], PointClosestepface32);
              cb3.cross(ab3);
              normal3.copy(cb3).normalize();

              var nn3 = new THREE.Vector3(0.2*normal3.x, 0.2*normal3.y, normal3.z)

              // offset test

              var Sphere_offset_1 = new THREE.Sphere(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z),0.1);
              var Point_offset_1_1 = Sphere_offset_1.clampPoint(PointClosestepface1);
              var Point_offset_1_2 = Sphere_offset_1.clampPoint(PointClosestepface2);
              var offset_mid_1 = new THREE.Vector3( (Point_offset_1_1.x+Point_offset_1_2.x)/2, (Point_offset_1_1.y+Point_offset_1_2.y)/2, (Point_offset_1_1.z+Point_offset_1_2.z)/2 );
              var offset_mid_geo1 = new THREE.SphereGeometry(0.02);
              var offset_midpoint = new THREE.Mesh(offset_mid_geo1, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //      offset_midpoint.position.copy(offset_mid_1);
              //      step_group_1.add(offset_midpoint);

              var Sphere_offset_2 = new THREE.Sphere(new THREE.Vector3(PointClosestepface1.x,PointClosestepface1.y,PointClosestepface1.z),0.1);
              var Point_offset_2_1 = Sphere_offset_2.clampPoint(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z));
              var Point_offset_2_2 = Sphere_offset_2.clampPoint(PointClosestepface2);
              var offset_mid_2 = new THREE.Vector3( (Point_offset_2_1.x+Point_offset_2_2.x)/2, (Point_offset_2_1.y+Point_offset_2_2.y)/2, (Point_offset_2_1.z+Point_offset_2_2.z)/2 );
              var offset_mid_geo2 = new THREE.SphereGeometry(0.02);
              var offset_midpoint2 = new THREE.Mesh(offset_mid_geo2, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //      offset_midpoint2.position.copy(offset_mid_2);
              //      step_group_1.add(offset_midpoint2);

              var Sphere_offset_3 = new THREE.Sphere(new THREE.Vector3(PointClosestepface2.x,PointClosestepface2.y,PointClosestepface2.z),0.1);
              var Point_offset_3_1 = Sphere_offset_3.clampPoint(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z));
              var Point_offset_3_2 = Sphere_offset_3.clampPoint(PointClosestepface1);
              var offset_mid_3 = new THREE.Vector3( (Point_offset_3_1.x+Point_offset_3_2.x)/2, (Point_offset_3_1.y+Point_offset_3_2.y)/2, (Point_offset_3_1.z+Point_offset_3_2.z)/2 );
              var offset_mid_geo3 = new THREE.SphereGeometry(0.02);
              var offset_midpoint3 = new THREE.Mesh(offset_mid_geo3, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //    offset_midpoint3.position.copy(offset_mid_3);
              //    step_group_1.add(offset_midpoint3);


              var points_offset = [
                new THREE.Vector3(offset_mid_1.x,offset_mid_1.y,offset_mid_1.z),
                new THREE.Vector3(offset_mid_2.x,offset_mid_2.y,offset_mid_2.z),

              ];

              var radius = 0.01;
              var smoothness = 12;

              var geom_offset = roundedCornerLine(points_offset, radius, smoothness, true);
              var line1_offset = new THREE.Line(geom_offset, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              line1_offset.computeLineDistances();
              //      step_group_1.add(line1_offset);

              var points_offset = [
                new THREE.Vector3(offset_mid_1.x,offset_mid_1.y,offset_mid_1.z),
                new THREE.Vector3(offset_mid_3.x,offset_mid_3.y,offset_mid_3.z),

              ];

              var radius = 0.01;
              var smoothness = 12;

              var geom_offset = roundedCornerLine(points_offset, radius, smoothness, true);
              var line1_2offset = new THREE.Line(geom_offset, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              line1_2offset.computeLineDistances();
              //      step_group_1.add(line1_2offset);


              //curve

              var control_p1 = new THREE.Vector3( (spacedivide_2.x+spacedivide2_2.x)/2, (spacedivide_2.y+spacedivide2_2.y)/2, (spacedivide_2.z+spacedivide2_2.z)/2 );

              var control_s1 = new THREE.Sphere(new THREE.Vector3(PointClosestepface12.x,PointClosestepface12.y,PointClosestepface12.z),0.5);
              var control_p2 = control_s1.clampPoint(control_p1);

              var curvet = new THREE.QuadraticBezierCurve3(
                offset_mid_3,
                control_p2,
                offset_mid_2
              );


              var pointst = curvet.getPoints( 50 );
              var geometryt = new THREE.BufferGeometry().setFromPoints( pointst );

              var materialt = new THREE.LineBasicMaterial( { color : 0xff0000 } );

              // Create the final object to add to the scene
              var curveObject = new THREE.Line( geometryt, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              curveObject.computeLineDistances();
              //step_group_1.add(curveObject);


              // offset test 2

              var Sphere_offset_12 = new THREE.Sphere(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z),0.1);
              var Point_offset_1_12 = Sphere_offset_12.clampPoint(PointClosestepface1);
              var Point_offset_1_22 = Sphere_offset_12.clampPoint(PointClosestepface3);
              var offset_mid_12 = new THREE.Vector3( (Point_offset_1_12.x+Point_offset_1_22.x)/2, (Point_offset_1_12.y+Point_offset_1_22.y)/2, (Point_offset_1_12.z+Point_offset_1_22.z)/2 );
              var offset_mid_geo12 = new THREE.SphereGeometry(0.02);
              var offset_2midpoint = new THREE.Mesh(offset_mid_geo12, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //  offset_midpoint.position.copy(offset_mid_1);
              //  step_group_1.add(offset_midpoint);

              var Sphere_offset_22 = new THREE.Sphere(new THREE.Vector3(PointClosestepface1.x,PointClosestepface1.y,PointClosestepface1.z),0.1);
              var Point_offset_2_12 = Sphere_offset_2.clampPoint(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z));
              var Point_offset_2_22 = Sphere_offset_2.clampPoint(PointClosestepface3);
              var offset_mid_22 = new THREE.Vector3( (Point_offset_2_12.x+Point_offset_2_22.x)/2, (Point_offset_2_12.y+Point_offset_2_22.y)/2, (Point_offset_2_12.z+Point_offset_2_22.z)/2 );
              var offset_mid_geo22 = new THREE.SphereGeometry(0.02);
              var offset_2midpoint2 = new THREE.Mesh(offset_mid_geo22, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //    offset_midpoint2.position.copy(offset_mid_2);
              //    step_group_1.add(offset_midpoint2);

              var Sphere_offset_32 = new THREE.Sphere(new THREE.Vector3(PointClosestepface3.x,PointClosestepface3.y,PointClosestepface3.z),0.1);
              var Point_offset_3_12 = Sphere_offset_32.clampPoint(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z));
              var Point_offset_3_22 = Sphere_offset_32.clampPoint(PointClosestepface1);
              var offset_mid_32 = new THREE.Vector3( (Point_offset_3_12.x+Point_offset_3_22.x)/2, (Point_offset_3_12.y+Point_offset_3_22.y)/2, (Point_offset_3_12.z+Point_offset_3_22.z)/2 );
              var offset_mid_geo32 = new THREE.SphereGeometry(0.02);
              var offset_2midpoint3 = new THREE.Mesh(offset_mid_geo32, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //    offset_midpoint3.position.copy(offset_mid_3);
              //    step_group_1.add(offset_midpoint3);


              var points_offset2 = [
                new THREE.Vector3(offset_mid_12.x,offset_mid_12.y,offset_mid_12.z),

                new THREE.Vector3(offset_mid_32.x,offset_mid_32.y,offset_mid_32.z),
              ];

              var radius = 0.01;
              var smoothness = 12;

              var geom_offset2 = roundedCornerLine(points_offset2, radius, smoothness, true);
              var line1_offset2 = new THREE.Line(geom_offset2, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              line1_offset2.computeLineDistances();
              //      step_group_1.add(line1_offset2);

              var points_offset22 = [
                new THREE.Vector3(offset_mid_12.x,offset_mid_12.y,offset_mid_12.z),
                new THREE.Vector3(offset_mid_22.x,offset_mid_22.y,offset_mid_22.z),

              ];

              var radius = 0.01;
              var smoothness = 12;

              var geom_offset22 = roundedCornerLine(points_offset22, radius, smoothness, true);
              var line1_offset22 = new THREE.Line(geom_offset22, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              line1_offset22.computeLineDistances();
              //    step_group_1.add(line1_offset22);


              //curve

              var control_p12 = new THREE.Vector3( (spacedivide_2.x+spacedivide3_2.x)/2, (spacedivide_2.y+spacedivide3_2.y)/2, (spacedivide_2.z+spacedivide3_2.z)/2 );

              var control_s12 = new THREE.Sphere(new THREE.Vector3(PointClosestepface22.x,PointClosestepface22.y,PointClosestepface22.z),0.5);
              var control_p22 = control_s12.clampPoint(control_p12);


              var curvet2 = new THREE.QuadraticBezierCurve3(
                offset_mid_22,
                control_p22,
                offset_mid_32
              );

              var pointst2 = curvet2.getPoints( 50 );
              var geometryt2 = new THREE.BufferGeometry().setFromPoints( pointst2 );


              // Create the final object to add to the scene
              var curveObject2 = new THREE.Line( geometryt2, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              curveObject2.computeLineDistances();
              //      step_group_1.add(curveObject2);


              // offset test 3

              var Sphere_offset_13 = new THREE.Sphere(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z),0.1);
              var Point_offset_1_13 = Sphere_offset_13.clampPoint(PointClosestepface2);
              var Point_offset_1_23 = Sphere_offset_13.clampPoint(PointClosestepface3);
              var offset_mid_13 = new THREE.Vector3( (Point_offset_1_13.x+Point_offset_1_23.x)/2, (Point_offset_1_13.y+Point_offset_1_23.y)/2, (Point_offset_1_13.z+Point_offset_1_23.z)/2 );
              var offset_mid_geo13 = new THREE.SphereGeometry(0.02);
              var offset_3midpoint = new THREE.Mesh(offset_mid_geo13, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //  offset_midpoint.position.copy(offset_mid_1);
              //  step_group_1.add(offset_midpoint);

              var Sphere_offset_23 = new THREE.Sphere(new THREE.Vector3(PointClosestepface2.x,PointClosestepface2.y,PointClosestepface2.z),0.1);
              var Point_offset_2_13 = Sphere_offset_23.clampPoint(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z));
              var Point_offset_2_23 = Sphere_offset_23.clampPoint(PointClosestepface3);
              var offset_mid_23 = new THREE.Vector3( (Point_offset_2_13.x+Point_offset_2_23.x)/2, (Point_offset_2_13.y+Point_offset_2_23.y)/2, (Point_offset_2_13.z+Point_offset_2_23.z)/2 );
              var offset_mid_geo23 = new THREE.SphereGeometry(0.02);
              var offset_3midpoint2 = new THREE.Mesh(offset_mid_geo23, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //    offset_midpoint2.position.copy(offset_mid_2);
              //    step_group_1.add(offset_midpoint2);

              var Sphere_offset_33 = new THREE.Sphere(new THREE.Vector3(PointClosestepface3.x,PointClosestepface3.y,PointClosestepface3.z),0.1);
              var Point_offset_3_13 = Sphere_offset_33.clampPoint(new THREE.Vector3(PointClosestepface32.x,PointClosestepface32.y,PointClosestepface32.z));
              var Point_offset_3_23 = Sphere_offset_33.clampPoint(PointClosestepface2);
              var offset_mid_33 = new THREE.Vector3( (Point_offset_3_13.x+Point_offset_3_23.x)/2, (Point_offset_3_13.y+Point_offset_3_23.y)/2, (Point_offset_3_13.z+Point_offset_3_23.z)/2 );
              var offset_mid_geo33 = new THREE.SphereGeometry(0.02);
              var offset_3midpoint3 = new THREE.Mesh(offset_mid_geo33, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));

              //    offset_midpoint3.position.copy(offset_mid_3);
              //    step_group_1.add(offset_midpoint3);


              var points_offset3 = [
                new THREE.Vector3(offset_mid_13.x,offset_mid_13.y,offset_mid_13.z),

                new THREE.Vector3(offset_mid_33.x,offset_mid_33.y,offset_mid_33.z),
              ];

              var points_offset32 = [
                new THREE.Vector3(offset_mid_13.x,offset_mid_13.y,offset_mid_13.z),
                new THREE.Vector3(offset_mid_23.x,offset_mid_23.y,offset_mid_23.z),

              ];

              var radius = 0.01;
              var smoothness = 12;

              var geom_offset3 = roundedCornerLine(points_offset3, radius, smoothness, true);
              var line1_offset3 = new THREE.Line(geom_offset3, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              line1_offset3.computeLineDistances();
              //    step_group_1.add(line1_offset3);

              var geom_offset32 = roundedCornerLine(points_offset32, radius, smoothness, true);
              var line1_offset32 = new THREE.Line(geom_offset32, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              line1_offset32.computeLineDistances();
              //    step_group_1.add(line1_offset32);

              //curve

              var control_p13 = new THREE.Vector3( (spacedivide2_2.x+spacedivide3_2.x)/2, (spacedivide2_2.y+spacedivide3_2.y)/2, (spacedivide2_2.z+spacedivide3_2.z)/2 );

              var control_s13 = new THREE.Sphere(new THREE.Vector3(PointClosestepface22.x,PointClosestepface22.y,PointClosestepface22.z),0.5);
              var control_p23 = control_s13.clampPoint(control_p13);


              var curvet3 = new THREE.QuadraticBezierCurve3(
                offset_mid_23,
                control_p23,
                offset_mid_33
              );

              var pointst3 = curvet3.getPoints( 50 );
              var geometryt3 = new THREE.BufferGeometry().setFromPoints( pointst3 );


              // Create the final object to add to the scene
              var curveObject3 = new THREE.Line( geometryt3, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.05,
                gapSize: 0.03,
                linewidth: 1

              }));
              curveObject3.computeLineDistances();
              //  step_group_1.add(curveObject3);





              //draw step 1 space 1

              var point2z = new THREE.Vector3( TubePoints2[1].x, TubePoints2[1].y, TubePoints1[1].z);
              var point3z = new THREE.Vector3( TubePoints3[1].x, TubePoints3[1].y, TubePoints1[1].z);
              var point4z = new THREE.Vector3( TubePoints4[1].x, TubePoints4[1].y, TubePoints1[1].z);

              var midpoint_24 = new THREE.Vector3( (point2z.x+point4z.x)/2, (point2z.y+point4z.y)/2, (point2z.z+point4z.z)/2 );
              var Sphere_step_1 = new THREE.Sphere(new THREE.Vector3(0,0,TubePoints1[1].z),0.4);
              var Point_step_1 = Sphere_step_1.clampPoint(Pnt_copy(P_A));
              var spGeom_step_1 = new THREE.SphereGeometry(0.02);
              var sp_step_1 = new THREE.Mesh(spGeom_step_1, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              sp_step_1.position.copy(Point_step_1);
              //      step_group_1.add(sp_step_1);



              var step1_pA = new THREE.Vector3(0.1*P_A.x, 0.1*P_A.y, PointClosestepface32.z);
              var step1_pB = new THREE.Vector3(0.1*P_B.x, 0.1*P_B.y, PointClosestepface32.z);
              var step1_pC = new THREE.Vector3(0.1*P_C.x, 0.1*P_C.y, PointClosestepface32.z);

              var points_offset_q = [
                step1_pA,
                step1_pB,
                step1_pC,
              ];

              var radius = 0.01;
              var smoothness = 12;

              var geom_offset_q = roundedCornerLine(points_offset_q, radius, smoothness, true);
              var line1_offset_q = new THREE.Line(geom_offset_q, new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.1,
                gapSize: 0.03,
                linewidth: 1

              }));
              line1_offset_q.computeLineDistances();
              //step_group_1.add(line1_offset_q);



              var geometryc = new THREE.CircleGeometry( 0.5, 32, 1);
              var materialc = new THREE.MeshBasicMaterial( { color: "grey", transparent:true, opacity:0.5, side: THREE.DoubleSide} );
              var circle = new THREE.Mesh( geometryc, materialc );
              step_group_1.add( circle );
              circle.position.copy(PointClosestepface32);
              //circle.rotateOnAxis(vecab,Math.PI/2);






              var zeroPoint2 = offset_mid_12;
              var pointStart2 = new THREE.Vector3(offset_mid_32.x, offset_mid_32.y,PointClosestepface32.z);
              var pointEnd2 = new THREE.Vector3(offset_mid_22.x, offset_mid_22.y,PointClosestepface32.z);



                  var triGeom = new THREE.Geometry();
                  triGeom.vertices.push(pointStart2, zeroPoint2, pointEnd2);
                  triGeom.faces.push(new THREE.Face3(0, 1, 2));
                  var line = new THREE.Line(triGeom, new THREE.LineDashedMaterial({
                    color: "black",//color
                    dashSize: 0.05,//size
                    gapSize: 0.05//len
                  }));
                  //step_group_1.add(line);
                  line.computeLineDistances();

                  var zeroPoint3 = offset_mid_1;
                  var pointStart3 = new THREE.Vector3(offset_mid_2.x, offset_mid_2.y,PointClosestepface32.z);
                  var pointEnd3 = new THREE.Vector3(offset_mid_3.x, offset_mid_3.y,PointClosestepface32.z);

                  var newArc3 = setArc3D(pointStart3, pointEnd3, zeroPoint3, 50, "lime", true);
                  //step_group_1.add(newArc1);

                  var newArc4 = setArc3D(pointStart3, pointEnd3, zeroPoint3, 50, "black", false);
                  //step_group_1.add(newArc4);

                  var triGeom = new THREE.Geometry();
                  triGeom.vertices.push(pointStart3, zeroPoint3, pointEnd3);
                  triGeom.faces.push(new THREE.Face3(0, 1, 2));
                  var line2 = new THREE.Line(triGeom, new THREE.LineDashedMaterial({
                    color: "black",//color
                    dashSize: 0.05,//size
                    gapSize: 0.05//len
                  }));
                  //step_group_1.add(line2);
                  line2.computeLineDistances();



                  var zeroPoint4 = offset_mid_13;
                  var pointStart4 = new THREE.Vector3(offset_mid_23.x, offset_mid_23.y,PointClosestepface32.z);
                  var pointEnd4 = new THREE.Vector3(offset_mid_33.x, offset_mid_33.y,PointClosestepface32.z);

                  var newArc5 = setArc3D(pointStart4, pointEnd4, zeroPoint4, 50, "orange", true);
                  //step_group_1.add(newArc5);

                  var newArc6 = setArc3D2(pointStart4, pointEnd4, zeroPoint4, 50, "red", false);
                  //step_group_1.add(newArc6);

                  var triGeom = new THREE.Geometry();
                  triGeom.vertices.push(pointStart4, zeroPoint4, pointEnd4);
                  triGeom.faces.push(new THREE.Face3(0, 1, 2));
                  var line3 = new THREE.Line(triGeom, new THREE.LineDashedMaterial({
                    color: "black",//color
                    dashSize: 0.05,//size
                    gapSize: 0.05//len
                  }));
                  //step_group_1.add(line3);
                  line3.computeLineDistances();


                  function setArc3D(pointStart, pointEnd, center, smoothness, color, clockWise) {
                    // calculate normal
                    var cb = new THREE.Vector3(),
                    ab = new THREE.Vector3(),
                    normal = new THREE.Vector3();
                    cb.subVectors(center, pointEnd);
                    ab.subVectors(pointStart, pointEnd);
                    cb.cross(ab);
                    normal.copy(cb).normalize();

                    // get angle between vectors
                    var angle = pointStart.angleTo(pointEnd);
                    if (clockWise) angle = angle - Math.PI * 2;
                    var angleDelta = angle / (smoothness - 1);

                    var geometry = new THREE.Geometry();
                    for (var i = 0; i < smoothness; i++) {
                      geometry.vertices.push(pointStart.clone().applyAxisAngle(normal, angleDelta * i))
                    }
                    var arc = new THREE.Line(geometry, new THREE.LineDashedMaterial({
                      color: color,//color
                      dashSize: 0.05,//size
                      gapSize: 0.05//len
                    })

                  );
                  arc.computeLineDistances();
                  return arc;
                };

                function setArc3D2(pointStart, pointEnd, center, smoothness, color, clockWise) {
                  // calculate normal
                  var cb = new THREE.Vector3(),
                  ab = new THREE.Vector3(),
                  normal = new THREE.Vector3();
                  cb.subVectors(center, pointEnd);
                  ab.subVectors(pointStart, pointEnd);
                  cb.cross(ab);
                  normal.copy(cb).normalize();

                  // get angle between vectors
                  var angle = pointStart.angleTo(pointEnd);
                  if (clockWise) angle = angle - Math.PI * 2;
                  var angleDelta = angle / (smoothness - 1);

                  var geometry = new THREE.Geometry();
                  for (var i = 0; i < smoothness; i++) {
                    geometry.vertices.push(pointStart.clone().applyAxisAngle(normal, angleDelta * i))
                  }
                  var arc = new THREE.Line(geometry, new THREE.LineBasicMaterial({
                    color: color,//color
                  })

                );
                return arc;
              };


              var step1_arr = new THREE.MeshPhongMaterial({color:0x009600});
              var step1_arr2 = new THREE.MeshPhongMaterial({color:"black"});

              var step1_arr_A1 = new THREE.Sphere(step1_pA,0.05);
              var step1_arr_p1 = step1_arr_A1.clampPoint(step1_pB);
              var step1_arr_B1 = new THREE.Sphere(step1_pA,0.25);
              var step1_arr_p2 = step1_arr_B1.clampPoint(step1_pB);

              var step1_arr_B2 = new THREE.Sphere(step1_pB,0.05);
              var step1_arr_p3 = step1_arr_B2.clampPoint(step1_pC);
              var step1_arr_B3 = new THREE.Sphere(step1_pB,0.25);
              var step1_arr_p4 = step1_arr_B3.clampPoint(step1_pC);

              var step1_arr_C1 = new THREE.Sphere(step1_pC,0.05);
              var step1_arr_p5 = step1_arr_C1.clampPoint(step1_pA);
              var step1_arr_C2 = new THREE.Sphere(step1_pC,0.25);
              var step1_arr_p6 = step1_arr_C2.clampPoint(step1_pA);


              var step1_arr_1 = createCylinderArrowMesh(step1_arr_p1,step1_arr_p2,step1_arr2,0.01,0.02,0.6);
              //  step_group_1.add(step1_arr_1);
              step1_arr_1.translateX(-0.3);
              step1_arr_1.translateZ(-0.1);
              step1_arr_1.translateY(0.1);

              var step1_arr_2 = createCylinderArrowMesh(step1_arr_p3,step1_arr_p4,step1_arr,0.01,0.02,0.6);
              //  step_group_1.add(step1_arr_2);
              step1_arr_2.translateX(0.3);
              step1_arr_2.translateZ(0.1);
              step1_arr_2.translateY(0.1);

              var step1_arr_3 = createCylinderArrowMesh(step1_arr_p5,step1_arr_p6,step1_arr,0.01,0.02,0.6);
              //  step_group_1.add(step1_arr_3);
              step1_arr_3.translateX(-0.3);
              step1_arr_3.translateZ(-0.1);
              step1_arr_3.translateY(0.1);



              var TXMeshS21=createSpriteTextstep1("A",new THREE.Vector3(P_A_Right.x,P_A_Right.y,1.4*P_A_Right.z));
              step_group_1_1.add(TXMeshS21);


              var midpoint_23 = new THREE.Vector3( (point2z.x+point3z.x)/2, (point2z.y+point3z.y)/2, (point2z.z+point3z.z)/2 );
              var Sphere_step_2 = new THREE.Sphere(new THREE.Vector3(0,0,TubePoints1[1].z),0.4);
              var Point_step_2 = Sphere_step_2.clampPoint(Pnt_copy(P_B));
              var spGeom_step_2 = new THREE.SphereGeometry(0.02);
              var sp_step_2 = new THREE.Mesh(spGeom_step_2, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              sp_step_2.position.copy(Point_step_2);
              //      step_group_1.add(sp_step_2);


              var TXMeshS22=createSpriteTextstep1("B",new THREE.Vector3(0.9*P_B_Right.x,0.9*P_B_Right.y,1.4*P_B_Right.z));
              step_group_1_1.add(TXMeshS22);


              var midpoint_34 = new THREE.Vector3( (point4z.x+point3z.x)/2, (point4z.y+point3z.y)/2, (point4z.z+point3z.z)/2 );
              var Sphere_step_3 = new THREE.Sphere(new THREE.Vector3(0,0,TubePoints1[1].z),0.4);
              var Point_step_3 = Sphere_step_2.clampPoint(Pnt_copy(P_C));
              var spGeom_step_3 = new THREE.SphereGeometry(0.02);
              var sp_step_3 = new THREE.Mesh(spGeom_step_3, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              sp_step_3.position.copy(Point_step_3);
              //      step_group_1.add(sp_step_3);


              var TXMeshS23=createSpriteTextstep1("C",new THREE.Vector3(0.9*P_C_Right.x,1*P_C_Right.y,1.4*P_C_Right.z));
              step_group_1_1.add(TXMeshS23);


              //Test Cell

              var cp_123mid = new THREE.Vector3((TubePoints3[1].x+TubePoints2[1].x)/2, (TubePoints3[1].y+TubePoints2[1].y)/2, (TubePoints3[1].z+TubePoints2[1].z)/2 );
              var cp_123mid2 = new THREE.Vector3((cp_123mid.x+TubePoints1[1].x)/2, (cp_123mid.y+TubePoints1[1].y)/2, (cp_123mid.z+TubePoints1[1].z)/2 )
              var cpGeom_1 = new THREE.SphereGeometry(0.02);
              var cp_step1_1 = new THREE.Mesh(cpGeom_1, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_1.position.copy(cp_123mid2);
              //step_group_1.add(cp_step1_1);

              var cp_f1_1 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.32);
              var cell_p1 = cp_f1_1.clampPoint(cp_123mid2);
              var cpGeom_2 = new THREE.SphereGeometry(0.02);
              var cp_step1_2 = new THREE.Mesh(cpGeom_2, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_2.position.copy(cell_p1);
              //step_group_1.add(cp_step1_2);

              var cp_f0_1 = new THREE.Sphere(new THREE.Vector3(TubePoints1[0].x,TubePoints1[0].y,TubePoints1[0].z),0.15);
              var cell_p2 = cp_f0_1.clampPoint(cp_123mid2);
              var cpGeom_3 = new THREE.SphereGeometry(0.02);
              var cp_step1_3 = new THREE.Mesh(cpGeom_3, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_3.position.copy(cell_p2);
              //step_group_1.add(cp_step1_3);

              var cp_f2_1 = new THREE.Sphere(new THREE.Vector3(TubePoints2[1].x,TubePoints2[1].y,TubePoints2[1].z),0.45);
              var cell_p3 = cp_f2_1.clampPoint(cp_123mid2);
              var cpGeom_4 = new THREE.SphereGeometry(0.02);
              var cp_step1_4 = new THREE.Mesh(cpGeom_4, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_4.position.copy(cell_p3);
              //step_group_1.add(cp_step1_4);

              var cp_f3_1 = new THREE.Sphere(new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z),0.45);
              var cell_p4 = cp_f3_1.clampPoint(cp_123mid2);
              var cpGeom_5 = new THREE.SphereGeometry(0.02);
              var cp_step1_5 = new THREE.Mesh(cpGeom_5, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_5.position.copy(cell_p4);
              //step_group_1.add(cp_step1_5);


              //cell 2

              var cp_124mid = new THREE.Vector3((TubePoints4[1].x+TubePoints2[1].x)/2, (TubePoints4[1].y+TubePoints2[1].y)/2, (TubePoints4[1].z+TubePoints2[1].z)/2 );
              var cp_124mid2 = new THREE.Vector3((cp_124mid.x+TubePoints1[1].x)/2, (cp_124mid.y+TubePoints1[1].y)/2, (cp_124mid.z+TubePoints1[1].z)/2 );


              var cp_f1_2 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.32);
              var cell_p21 = cp_f1_2.clampPoint(cp_124mid2);
              var cpGeom_6 = new THREE.SphereGeometry(0.02);
              var cp_step1_6 = new THREE.Mesh(cpGeom_2, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_6.position.copy(cell_p21);
              //step_group_1.add(cp_step1_2);

              var cp_f0_2 = new THREE.Sphere(new THREE.Vector3(TubePoints1[0].x,TubePoints1[0].y,TubePoints1[0].z),0.15);
              var cell_p22 = cp_f0_2.clampPoint(cp_124mid2);
              var cpGeom_7 = new THREE.SphereGeometry(0.02);
              var cp_step1_7 = new THREE.Mesh(cpGeom_7, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_7.position.copy(cell_p22);
              //step_group_1.add(cp_step1_3);

              var cp_f2_2 = new THREE.Sphere(new THREE.Vector3(TubePoints2[1].x,TubePoints2[1].y,TubePoints2[1].z),0.45);
              var cell_p23 = cp_f2_2.clampPoint(cp_124mid2);
              var cpGeom_8 = new THREE.SphereGeometry(0.02);
              var cp_step1_8 = new THREE.Mesh(cpGeom_8, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_8.position.copy(cell_p3);
              //step_group_1.add(cp_step1_4);

              var cp_f3_2 = new THREE.Sphere(new THREE.Vector3(TubePoints4[1].x,TubePoints4[1].y,TubePoints4[1].z),0.45);
              var cell_p24 = cp_f3_2.clampPoint(cp_124mid2);
              var cpGeom_9 = new THREE.SphereGeometry(0.02);
              var cp_step1_9 = new THREE.Mesh(cpGeom_9, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_9.position.copy(cell_p24);
              //step_group_1.add(cp_step1_5);

              //cell 3


              var cp_134mid = new THREE.Vector3((TubePoints4[1].x+TubePoints3[1].x)/2, (TubePoints4[1].y+TubePoints3[1].y)/2, (TubePoints4[1].z+TubePoints3[1].z)/2 );
              var cp_134mid2 = new THREE.Vector3((cp_134mid.x+TubePoints1[1].x)/2, (cp_134mid.y+TubePoints1[1].y)/2, (cp_134mid.z+TubePoints1[1].z)/2 );


              var cp_f1_3 = new THREE.Sphere(new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z),0.32);
              var cell_p31 = cp_f1_3.clampPoint(cp_134mid2);
              var cpGeom_10 = new THREE.SphereGeometry(0.02);
              var cp_step1_10 = new THREE.Mesh(cpGeom_10, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              //cp_step1_6.position.copy(cell_p21);
              //step_group_1.add(cp_step1_2);

              var cp_f0_3 = new THREE.Sphere(new THREE.Vector3(TubePoints1[0].x,TubePoints1[0].y,TubePoints1[0].z),0.15);
              var cell_p32 = cp_f0_3.clampPoint(cp_134mid2);
              var cpGeom_11 = new THREE.SphereGeometry(0.02);
              var cp_step1_11 = new THREE.Mesh(cpGeom_11, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_7.position.copy(cell_p22);
              //step_group_1.add(cp_step1_3);

              var cp_f2_3 = new THREE.Sphere(new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z),0.45);
              var cell_p33 = cp_f2_3.clampPoint(cp_134mid2);
              var cpGeom_12 = new THREE.SphereGeometry(0.02);
              var cp_step1_12 = new THREE.Mesh(cpGeom_12, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              //cp_step1_8.position.copy(cell_p3);
              //step_group_1.add(cp_step1_4);

              var cp_f3_3 = new THREE.Sphere(new THREE.Vector3(TubePoints4[1].x,TubePoints4[1].y,TubePoints4[1].z),0.45);
              var cell_p34 = cp_f3_3.clampPoint(cp_134mid2);
              var cpGeom_13 = new THREE.SphereGeometry(0.02);
              var cp_step1_13 = new THREE.Mesh(cpGeom_13, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              //cp_step1_9.position.copy(cell_p24);
              //step_group_1.add(cp_step1_5);


              //cell 4


              var cp_234mid = new THREE.Vector3((TubePoints4[1].x+TubePoints3[1].x)/2, (TubePoints4[1].y+TubePoints3[1].y)/2, (TubePoints4[1].z+TubePoints3[1].z)/2 );
              var cp_234mid2 = new THREE.Vector3((cp_234mid.x+TubePoints2[1].x)/2, (cp_234mid.y+TubePoints2[1].y)/2, (cp_234mid.z+TubePoints2[1].z)/2 );
              var cp_234mid3 = new THREE.Vector3(0, 0,cp_234mid2.z );


              var cp_f1_4 = new THREE.Sphere(new THREE.Vector3(TubePoints2[1].x,TubePoints2[1].y,TubePoints2[1].z),0.32);
              var cell_p41 = cp_f1_4.clampPoint(cp_234mid3);
              var cpGeom_14 = new THREE.SphereGeometry(0.02);
              var cp_step1_14 = new THREE.Mesh(cpGeom_14, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              //cp_step1_6.position.copy(cell_p21);
              //step_group_1.add(cp_step1_2);

              var cp_f0_4 = new THREE.Sphere(new THREE.Vector3(TubePoints1[0].x,TubePoints1[0].y,TubePoints1[0].z),0.15);
              var cell_p42 = cp_f0_4.clampPoint(cp_234mid3);
              var cpGeom_15 = new THREE.SphereGeometry(0.02);
              var cp_step1_15 = new THREE.Mesh(cpGeom_15, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              cp_step1_7.position.copy(cell_p22);
              //step_group_1.add(cp_step1_3);

              var cp_f2_4 = new THREE.Sphere(new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z),0.45);
              var cell_p43 = cp_f2_4.clampPoint(cp_234mid3);
              var cpGeom_16 = new THREE.SphereGeometry(0.02);
              var cp_step1_16 = new THREE.Mesh(cpGeom_16, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              //cp_step1_8.position.copy(cell_p3);
              //step_group_1.add(cp_step1_4);

              var cp_f3_4 = new THREE.Sphere(new THREE.Vector3(TubePoints4[1].x,TubePoints4[1].y,TubePoints4[1].z),0.45);
              var cell_p44 = cp_f3_4.clampPoint(cp_234mid3);
              var cpGeom_17 = new THREE.SphereGeometry(0.02);
              var cp_step1_17 = new THREE.Mesh(cpGeom_17, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              //cp_step1_9.position.copy(cell_p24);
              //step_group_1.add(cp_step1_5);


              var vertices = [
                cell_p1,cell_p2,cell_p3,cell_p4
              ];

              var faces = [
                new THREE.Face3(0, 1, 2),
                new THREE.Face3(0, 1, 3),
                new THREE.Face3(1, 2, 3),
              ];

              var geom = new THREE.Geometry();
              geom.vertices = vertices;
              geom.faces = faces;
              geom.computeFaceNormals();
              var material_step_2 =[
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.9}),
                new THREE.MeshPhongMaterial({
                  color: "grey",transparent: true,opacity:0.95,side:THREE.DoubleSide
                } )
              ];

              var step_1_cell_1 = THREE.SceneUtils.createMultiMaterialObject(geom, material_step_2);
              step_group_cell.add(step_1_cell_1);

              var vertices = [
                cell_p21,cell_p22,cell_p23,cell_p24
              ];

              var faces = [
                new THREE.Face3(0, 1, 2),
                new THREE.Face3(0, 1, 3),
                new THREE.Face3(1, 2, 3),
              ];

              var geom = new THREE.Geometry();
              geom.vertices = vertices;
              geom.faces = faces;
              geom.computeFaceNormals();
              var material_step_2 =[
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.9}),
                new THREE.MeshPhongMaterial({
                  color: "grey",transparent: true,opacity:0.95,side:THREE.DoubleSide
                } )
              ];

              var step_1_cell_2 = THREE.SceneUtils.createMultiMaterialObject(geom, material_step_2);
              step_group_cell.add(step_1_cell_2);

              var vertices = [
                cell_p31,cell_p32,cell_p33,cell_p34
              ];

              var faces = [
                new THREE.Face3(0, 1, 2),
                new THREE.Face3(0, 1, 3),
                new THREE.Face3(1, 2, 3),
              ];

              var geom = new THREE.Geometry();
              geom.vertices = vertices;
              geom.faces = faces;
              geom.computeFaceNormals();
              var material_step_2 =[
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.9}),
                new THREE.MeshPhongMaterial({
                  color: "grey",transparent: true,opacity:0.95,side:THREE.DoubleSide
                } )
              ];

              var step_1_cell_3 = THREE.SceneUtils.createMultiMaterialObject(geom, material_step_2);
              step_group_cell.add(step_1_cell_3);

              var vertices = [
                cell_p41,cell_p42,cell_p43,cell_p44
              ];

              var faces = [
                new THREE.Face3(0, 1, 2),
                new THREE.Face3(0, 1, 3),
                new THREE.Face3(1, 2, 3),
              ];

              var geom = new THREE.Geometry();
              geom.vertices = vertices;
              geom.faces = faces;
              geom.computeFaceNormals();
              var material_step_2 =[
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.9}),
                new THREE.MeshPhongMaterial({
                  color: "grey",transparent: true,opacity:0.95,side:THREE.DoubleSide
                } )
              ];

              var step_1_cell_4 = THREE.SceneUtils.createMultiMaterialObject(geom, material_step_2);
              step_group_cell.add(step_1_cell_4);

              var TXMeshS1=createSpriteTextstep1_1("A",new THREE.Vector3((cell_p1.x+cell_p4.x+cell_p3.x)/3, (cell_p1.y+cell_p4.y+cell_p3.y)/3, (cell_p1.z+cell_p4.z+cell_p3.z)/3 ));
              step_group_cell.add(TXMeshS1);

              var TXMeshS2=createSpriteTextstep1_1("B",new THREE.Vector3((cell_p21.x+cell_p24.x+cell_p23.x)/3, (cell_p21.y+cell_p24.y+cell_p23.y)/3, (cell_p21.z+cell_p24.z+cell_p23.z)/3 ));
              step_group_cell.add(TXMeshS2);

              var TXMeshS3=createSpriteTextstep1_1("C",new THREE.Vector3((cell_p31.x+cell_p34.x+cell_p33.x)/3, (cell_p31.y+cell_p34.y+cell_p33.y)/3, (cell_p31.z+cell_p34.z+cell_p33.z)/3 ));
              step_group_cell.add(TXMeshS3);

              var TXMeshS4=createSpriteTextstep1_1("D",new THREE.Vector3((cell_p41.x+cell_p44.x+cell_p43.x)/3, (cell_p41.y+cell_p44.y+cell_p43.y)/3, (cell_p41.z+cell_p44.z+cell_p43.z)/3 ));
              step_group_cell.add(TXMeshS4);

              step_group_cell.children[0].visible=false;
              step_group_cell.children[1].visible=false;
              step_group_cell.children[2].visible=false;
              step_group_cell.children[3].visible=false;

              step_group_cell.children[4].material.visible=false;
              step_group_cell.children[5].material.visible=false;
              step_group_cell.children[6].material.visible=false;
              step_group_cell.children[7].material.visible=false;

              var stepMesh1=createCylinderMesh(TubePoints2[1],TubePoints1[0],new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.3}),0.02,0.02);
              step_group_1.add(stepMesh1);
              stepMesh1.castShadow = true;
              var stepMesh2=createCylinderMesh(TubePoints3[1],TubePoints1[0],new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.3}),0.02,0.02);
              step_group_1.add(stepMesh2);
              stepMesh2.castShadow = true;
              var stepMesh3=createCylinderMesh(TubePoints4[1],TubePoints1[0],new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.3}),0.02,0.02);
              step_group_1.add(stepMesh3);
              stepMesh3.castShadow = true;

              for(i=0;i<=13;i++){
                step_group_1.children[i].visible=false;
              }




              geometry44 = new THREE.SphereGeometry( 0.03);
              material44 = new THREE.MeshPhongMaterial({color: "grey"});

              mesh44 = new THREE.Mesh( geometry44, material44 );
              //        scene2.add( mesh44 );

              P_A_Left=Pnt_copy(P_A);
              P_B_Left=Pnt_copy(P_B);
              P_C_Left=Pnt_copy(P_C);
              P_D_Left=Pnt_copy(P_D);

              geometry45 = new THREE.SphereGeometry( 0.03);
              material45 = new THREE.MeshPhongMaterial({color: "black"});

              mesh45 = new THREE.Mesh( geometry45, material45 );
              //step_group_1_1.add( mesh45 );
              mesh45.position.copy(P_A_Left);


              mesh46 = new THREE.Mesh( geometry45, material45 );
              //step_group_1_1.add( mesh46 );
              mesh46.position.copy(P_B_Left);

              mesh47 = new THREE.Mesh( geometry45, material45 );
              //step_group_1_1.add( mesh47 );
              mesh47.position.copy(P_C_Left);

              //var tween1 = new TWEEN.Tween( mesh44.position ).to( P_A_Right, 3000 );
              //var tween2 = new TWEEN.Tween( mesh44.position ).to( P_B_Right, 3000 );
              //var tween3 = new TWEEN.Tween( mesh44.position ).to( P_C_Right, 3000 );

              //  tween1.chain( tween2 );
              //  tween2.chain( tween3 );
              //  tween3.chain( tween1 );

              //tween1.start();



              var step_1_line = new THREE.Geometry();

              P_A_Right=Pnt_copy(P_A);
              P_B_Right=Pnt_copy(P_B);
              P_C_Right=Pnt_copy(P_C);
              P_D_Right=Pnt_copy(P_D);


              var vertices2 = [
                P_A_Right,P_B_Right,P_C_Right
              ];

              //    var step_1_force = [];
              //    step_1_force.push(P_A_Right);
              //    step_1_force.push(P_B_Right);
              //    step_1_force.push(P_C_Right);

              //    var step_1_force_p = new THREE.Geometry().setFromPoints( step_1_force );

              var faces2 = [
                new THREE.Face3(0, 1, 2),

              ];


              var geomstep1 = new THREE.Geometry();
              geomstep1.vertices = vertices2;
              geomstep1.faces = faces2;
              geomstep1.computeFaceNormals();

              //    var step_1_line_Material = new THREE.LineDashedMaterial({
              //                             color: "black",//color
              //                             dashSize: 0.1,//size
              //                            gapSize: 0.05//len
              //                             });



              //    var step_1_force_path = new THREE.LineSegments(step_1_force_p,step_1_line_Material);
              //    step_1_force_path.computeLineDistances();//dash

              //    step_1_force_path = THREE.SceneUtils.createMultiMaterialObject(geomstep1, materialsp1);
              //  step_1_force_path.children.forEach(function (e) {
              //      e.geometry.vertices = vertices2;
              //      e.geometry.verticesNeedUpdate = true;

              // e.geometry.faces[0].color.set(0xff00ee);
              // e.geometry.facesNeedUpdate=true;
              //      e.geometry.elementsNeedUpdate = true;
              //      e.geometry.computeFaceNormals();
              //e.geometry.center();
              //  });
              //  step_group_1_1.add( step_1_force_path );

              var materialsp1 = [
                //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                new THREE.MeshBasicMaterial({color: "black", wireframe: true, transparent: true,opacity:0.2}),
                new THREE.MeshLambertMaterial({
                  colors: 0x009600,transparent: true,opacity:0.4,side:THREE.DoubleSide,depthWrite:false
                } )
              ];


              step_1_line_Path = THREE.SceneUtils.createMultiMaterialObject(geomstep1, materialsp1);
              step_1_line_Path.children.forEach(function (e) {
                e.geometry.vertices = vertices2;
                e.geometry.verticesNeedUpdate = true;

                // e.geometry.faces[0].color.set(0xff00ee);
                // e.geometry.facesNeedUpdate=true;
                e.geometry.elementsNeedUpdate = true;
                e.geometry.computeFaceNormals();
                //e.geometry.center();
              });

              step_group_1_1.add( step_1_line_Path );

              var SphereTest_step_1 = new THREE.Sphere(P_A_Right,1.2);
              var PointClose1_step_1 = SphereTest_step_1.clampPoint(P_B_Right);
              //        var SphereTest2_2 = new THREE.Sphere(PointClose1_2,0.05);
              //        var PointClose2_2 = SphereTest2_2.clampPoint(TubePoints3[1]);
              //        var SphereTest3_2 = new THREE.Sphere(PointClose2_2,0.045);

              var SphereTest_step_12 = new THREE.Sphere(P_A_Right,1.7);
              var PointClose1_step_12 = SphereTest_step_12.clampPoint(P_B_Right);

              var SphereTest_step2_1 = new THREE.Sphere(P_B_Right,1.2);
              var PointClose1_step2_1 = SphereTest_step2_1.clampPoint(P_C_Right);

              var SphereTest_step2_2 = new THREE.Sphere(P_B_Right,1.7);
              var PointClose1_step2_2 = SphereTest_step2_2.clampPoint(P_C_Right);

              var SphereTest_step3_1 = new THREE.Sphere(P_C_Right,1.2);
              var PointClose1_step3_1 = SphereTest_step3_1.clampPoint(P_A_Right);

              var SphereTest_step3_2 = new THREE.Sphere(P_C_Right,1.7);
              var PointClose1_step3_2 = SphereTest_step3_2.clampPoint(P_A_Right);

              var materialar1 =
              //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),

              new THREE.MeshPhongMaterial({
                color: 0x009600,transparent: false,side:THREE.DoubleSide
              } );

              var materialar2 =
              //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),

              new THREE.MeshLambertMaterial({
                color: 0x009600,transparent: false,side:THREE.DoubleSide
              } );

              var setp_1_arrow_12 = createCylinderArrowMesh(PointClose1_step_1,PointClose1_step_12,materialar1,0.023,0.05,0.7);
              step_group_1_1.add( setp_1_arrow_12 );

              var setp_1_arrow_1 = createCylinderArrowMesh(P_A_Right,P_B_Right,materialar1,0.023,0.05,0.9);
              step_group_1_1.add( setp_1_arrow_1 );

              //setp_1_arrow_1.position.copy(P_A_Right);

              var setp_1_arrow2_1 = createCylinderArrowMesh(PointClose1_step2_1,PointClose1_step2_2,materialar2,0.023,0.05,0.7);
              step_group_1_1.add( setp_1_arrow2_1 );

              var setp_1_arrow2_1 = createCylinderArrowMesh(PointClose1_step3_1,PointClose1_step3_2,materialar2,0.023,0.05,0.7);
              step_group_1_1.add( setp_1_arrow2_1 );

              var step_1_force = [];

              step_1_force.push(P_B_Right);
              step_1_force.push(P_C_Right);

              var step_1_force_p = new THREE.Geometry().setFromPoints( step_1_force );

              var step_1_force2 = [];

              step_1_force2.push(P_C_Right);
              step_1_force2.push(P_A_Right);

              var step_1_force3 = [];

              step_1_force3.push(P_A_Right);
              step_1_force3.push(P_B_Right);

              var step_1_force_p2 = new THREE.Geometry().setFromPoints( step_1_force2 );

              var step_1_force_p3 = new THREE.Geometry().setFromPoints( step_1_force3 );

              var step_1_line_Material = new THREE.LineDashedMaterial({
                color: "black",//color
                dashSize: 0.1,//size
                gapSize: 0.05//len
              });
              var step_1_force_path = new THREE.LineSegments(step_1_force_p,step_1_line_Material);
              step_1_force_path.computeLineDistances();//dash
              step_group_1_1.add( step_1_force_path );

              var step_1_force_path2 = new THREE.LineSegments(step_1_force_p2,step_1_line_Material);
              step_1_force_path2.computeLineDistances();//dash
              step_group_1_1.add( step_1_force_path2 );

              var step_1_force_path3 = new THREE.LineSegments(step_1_force_p3,step_1_line_Material);
              step_1_force_path3.computeLineDistances();//dash
              step_group_1_1.add( step_1_force_path3 );

              var spC = new THREE.SphereGeometry(0.02);
              var spC2 = new THREE.Mesh(spC, new THREE.MeshPhongMaterial({color: 0x009600, transparent: true, opacity:0.9}));
              spC2.position.copy(P_C_Right);
              step_group_1_1.add(spC2);



              var TXMeshS24=createSpriteTextstep1("D",new THREE.Vector3(0.6*P_D_Right.x,2*P_D_Right.y,0.8*P_D_Right.z));
              step_group_1_1.add(TXMeshS24);

              var spC = new THREE.SphereGeometry(0.02);
              var spC3 = new THREE.Mesh(spC, new THREE.MeshPhongMaterial({color: 0x009600, transparent: true, opacity:0.9}));
              spC3.position.copy(P_A_Right);
              step_group_1_1.add(spC3);

              var spC = new THREE.SphereGeometry(0.02);
              var spC4 = new THREE.Mesh(spC, new THREE.MeshPhongMaterial({color: 0x009600, transparent: true, opacity:0.9}));
              spC4.position.copy(P_B_Right);
              step_group_1_1.add(spC4);

              for(i=0;i<=14;i++){
                step_group_1_1.children[i].visible=false;
              }
              var SphereTest_step_1_2 = new THREE.Sphere(P_B_Right,2.5);
              var PointClose1_step_1_2 = SphereTest_step_1_2.clampPoint(P_C_Right);

              var setp_1_arrow_2 = createCylinderArrowMesh(P_B_Right,P_C_Right,material45,0.023,0.05,0.9);
              //step_group_1_1.add( setp_1_arrow_2 );
              //setp_1_arrow_2.position.copy(P_B_Right);

              var SphereTest_step_1_3 = new THREE.Sphere(P_C_Right,2.5);
              var PointClose1_step_1_3 = SphereTest_step_1_3.clampPoint(P_A_Right);

              var setp_1_arrow_3 = createCylinderArrowMesh(P_C_Right,P_A_Right,material45,0.023,0.05,0.9);
              //step_group_1_1.add( setp_1_arrow_3 );
              //setp_1_arrow_3.position.copy(P_C_Right);

              //var tween4 = new TWEEN.Tween( setp_1_arrow_1.position ).to( P_B_Right, 2000 );
              //var tween5 = new TWEEN.Tween( setp_1_arrow_2.position ).to( P_C_Right, 2000 );
              //var tween6 = new TWEEN.Tween( setp_1_arrow_3.position ).to( P_A_Right, 2000 );

              //tween4.chain( tween5 );
              //tween5.chain( tween6 );
              //tween6.chain( tween4 );

              //tween4.start();
              //      tween5.start();
              //      tween6.start();
              //      step_1_line_Path.scale.set(0.5,0.5,0.5);




              //step group 2


              var Sphere_step_2_1 = new THREE.Sphere(new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z),0.9);
              var Point_step_2_1 = Sphere_step_2_1.clampPoint(TubePoints1[1]);
              var spGeom_step_2_1 = new THREE.SphereGeometry(0.02);
              var sp_step_2_1 = new THREE.Mesh(spGeom_step_2_1, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              sp_step_2_1.position.copy(Point_step_2_1);
              //step_group_2.add(sp_step_2_1);

              var Sphere_step_2_12 = new THREE.Sphere(new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z),0.8);
              var Point_step_2_12 = Sphere_step_2_12.clampPoint(TubePoints1[0]);
              var spGeom_step_2_12 = new THREE.SphereGeometry(0.2);
              var sp_step_2_12 = new THREE.Mesh(spGeom_step_2_12, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              sp_step_2_12.position.copy(Point_step_2_12);
              //step_group_2.add(sp_step_2_12);

              var Sphere_step_2_13 = new THREE.Sphere(new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z),0.9);
              var Point_step_2_13 = Sphere_step_2_13.clampPoint(TubePoints4[1]);
              var spGeom_step_2_13 = new THREE.SphereGeometry(0.2);
              var sp_step_2_13 = new THREE.Mesh(spGeom_step_2_13, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              sp_step_2_13.position.copy(Point_step_2_13);
              //step_group_2.add(sp_step_2_13);

              var Sphere_step_2_14 = new THREE.Sphere(new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z),0.9);
              var Point_step_2_14 = Sphere_step_2_14.clampPoint(TubePoints2[1]);
              var spGeom_step_2_14 = new THREE.SphereGeometry(0.2);
              var sp_step_2_14 = new THREE.Mesh(spGeom_step_2_14, new THREE.MeshPhongMaterial({color: "black", transparent: true, opacity:0.7}));
              sp_step_2_14.position.copy(Point_step_2_14);
              //step_group_2.add(sp_step_2_13);


              var geometryc = new THREE.CircleGeometry( 0.5, 32, 1);
              var materialc = new THREE.MeshBasicMaterial( { color: "grey", transparent:true, opacity:0.5, side: THREE.DoubleSide} );
              var circle2 = new THREE.Mesh( geometryc, materialc );
              step_group_2.add( circle2 );
              circle2.position.copy(Point_step_2_12);

              var p3 = new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,Point_step_2_12.z);
              var p4 = new THREE.Vector3(Point_step_2_12.x,Point_step_2_12.y,Point_step_2_12.z);
              var p5 = new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z);

              var l3 = distanceVector(p3, p4);
              var pt_t2 = new THREE.Vector3((Point_step_2_12.x + (0.5/(l3-0.5))*TubePoints3[1].x)/(1+0.5/(l3-0.5)),(Point_step_2_12.y + (0.5/(l3-0.5))*TubePoints3[1].y)/(1+0.5/(l3-0.5)),(Point_step_2_12.z + (0.5/(l3-0.5))*Point_step_2_12.z)/(1+0.5/(l3-0.5)));

              var vec_2a = new THREE.Vector3(pt_t2.x-Point_step_2_12.x, pt_t2.y-Point_step_2_12.y, pt_t2.z-Point_step_2_12.z);
              var vec_2b = new THREE.Vector3(TubePoints3[1].x-Point_step_2_12.x, TubePoints3[1].y-Point_step_2_12.y, TubePoints3[1].z-Point_step_2_12.z);

              var an1 = vec_2a.angleTo(vec_2b);
              if(TubePoints3[1].z<=0){
              rotateAroundObjectAxis(circle2, vecab, Math.PI/2-an1)};
              if(TubePoints3[1].z>0){
              rotateAroundObjectAxis(circle2, vecab, Math.PI/2+an1)};


               // *********************

                  var f1 = new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z);
                  var f2 = new THREE.Vector3(TubePoints4[1].x,TubePoints4[1].y,TubePoints4[1].z);
                  var fn = new THREE.Vector3().crossVectors(f1,f2);
                  var f3 = new THREE.Vector3().crossVectors(fn,f1);
                  var q = Math.sqrt(0.5*0.5/(f3.x*f3.x+f3.y*f3.y+f3.z*f3.z));

                  var mf = new THREE.Vector3(Point_step_2_12.x+q*f3.x,Point_step_2_12.y+q*f3.y,Point_step_2_12.z+q*f3.z);


                  var f12 = new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z);
                  var f22 = new THREE.Vector3(TubePoints1[1].x,TubePoints1[1].y,TubePoints1[1].z);
                  var fn2 = new THREE.Vector3().crossVectors(f12,f22);
                  var f32 = new THREE.Vector3().crossVectors(fn2,f12);
                  var q = Math.sqrt(0.5*0.5/(f32.x*f32.x+f32.y*f32.y+f32.z*f32.z));

                  var mf2 = new THREE.Vector3(Point_step_2_12.x+q*f32.x,Point_step_2_12.y+q*f32.y,Point_step_2_12.z+q*f32.z);

                  var f13 = new THREE.Vector3(TubePoints3[1].x,TubePoints3[1].y,TubePoints3[1].z);
                  var f23 = new THREE.Vector3(TubePoints2[1].x,TubePoints2[1].y,TubePoints2[1].z);
                  var fn3 = new THREE.Vector3().crossVectors(f13,f23);
                  var f33 = new THREE.Vector3().crossVectors(fn3,f13);
                  var q = Math.sqrt(0.5*0.5/(f33.x*f33.x+f33.y*f33.y+f33.z*f33.z));

                  var mf3 = new THREE.Vector3(Point_step_2_12.x+q*f33.x,Point_step_2_12.y+q*f33.y,Point_step_2_12.z+q*f33.z);


                  var spacedivide_geo21 = createCylinderMesh(Point_step_2_12,mf,new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.6}),0.008,0.008);

                  step_group_2.add( spacedivide_geo21 );

                  var spacedivide_geo22 = createCylinderMesh(Point_step_2_12,mf2,new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.6}),0.008,0.008);

                  step_group_2.add( spacedivide_geo22 );

                  var spacedivide_geo23 = createCylinderMesh(Point_step_2_12,mf3,new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.6}),0.008,0.008);

                  step_group_2.add( spacedivide_geo23 );


                  var cb = new THREE.Vector3(),
                  ab = new THREE.Vector3(),
                  normal1 = new THREE.Vector3();
                  cb.subVectors(mf2, Point_step_2_12);
                  ab.subVectors(TubePoints3[1], Point_step_2_12);
                  cb.cross(ab);
                  normal1.copy(cb).normalize();

                  var nn = new THREE.Vector3(0.2*normal1.x, 0.2*normal1.y, normal1.z)


                  var new1 = new THREE.Vector3(nn.x+mf2.x, nn.y+mf2.y, nn.z+mf2.z);

                  var spacedivide_geo2a1 = createCylinderArrowMesh(mf2,new1,step1_arr2,0.01,0.02,0.6);

                  //add step arrow 1
                  step_group_2.add(spacedivide_geo2a1);

                  //var TXMeshST21=createSpriteTextstep1("A",new THREE.Vector3((mf2.x+mf3.x)/2,(mf2.y+mf3.y)/2,(mf2.z+mf3.z)/2));
                  //step_group_2.add(TXMeshST21);

                  var sta = new THREE.Vector3((mf2.x+mf3.x)/2,(mf2.y+mf3.y)/2,(mf2.z+mf3.z)/2);
                  var oldl = Point_step_2_12.distanceTo(sta);
                  var c = new THREE.Vector3((Point_step_2_12.x + (sta.x-Point_step_2_12.x)*0.5/oldl),(Point_step_2_12.y + (sta.y-Point_step_2_12.y)*0.5/oldl),(Point_step_2_12.z + (sta.z-Point_step_2_12.z)*0.5/oldl));

                  var TXMeshST21=createSpriteTextstep1("A",c);
                  step_group_2.add(TXMeshST21);

                  var cb22 = new THREE.Vector3(),
                  ab22 = new THREE.Vector3(),
                  normal22 = new THREE.Vector3();
                  cb22.subVectors(mf, Point_step_2_12);
                  ab22.subVectors(TubePoints3[1], Point_step_2_12);
                  cb22.cross(ab22);
                  normal22.copy(cb22).normalize();

                  var nn22 = new THREE.Vector3(0.2*normal22.x, 0.2*normal22.y, 0.2*normal22.z);


                  var new22 = new THREE.Vector3(nn22.x+mf.x, nn22.y+mf.y, nn22.z+mf.z);

                  var spacedivide_geo2a2 = createCylinderArrowMesh(mf,new22,step1_arr2,0.01,0.02,0.6);

                  //add step arrow 1
                  step_group_2.add(spacedivide_geo2a2);

                  var sta2 = new THREE.Vector3((mf.x+mf3.x)/2,(mf.y+mf3.y)/2,(mf.z+mf3.z)/2);
                  var oldl2 = Point_step_2_12.distanceTo(sta2);
                  var c2 = new THREE.Vector3((Point_step_2_12.x + (sta2.x-Point_step_2_12.x)*0.5/oldl2),(Point_step_2_12.y + (sta2.y-Point_step_2_12.y)*0.5/oldl2),(Point_step_2_12.z + (sta2.z-Point_step_2_12.z)*0.5/oldl2));

                  var TXMeshST22=createSpriteTextstep1("D",c2);
                  step_group_2.add(TXMeshST22);

                  var cb23 = new THREE.Vector3(),
                  ab23 = new THREE.Vector3(),
                  normal23 = new THREE.Vector3();
                  cb23.subVectors(mf3, Point_step_2_12);
                  ab23.subVectors(TubePoints3[1], Point_step_2_12);
                  cb23.cross(ab23);
                  normal23.copy(cb23).normalize();

                  var nn23 = new THREE.Vector3(0.2*normal23.x, 0.2*normal23.y, 0.2*normal23.z);


                  var new23 = new THREE.Vector3(nn23.x+mf3.x, nn23.y+mf3.y, nn23.z+mf3.z);

                  var spacedivide_geo2a3 = createCylinderArrowMesh(mf3,new23,step1_arr2,0.01,0.02,0.6);

                  //add step arrow 1
                  step_group_2.add(spacedivide_geo2a3);

                  var sta3 = new THREE.Vector3((mf.x+mf2.x)/2,(mf.y+mf2.y)/2,(mf.z+mf2.z)/2);
                  var oldl3 = Point_step_2_12.distanceTo(sta3);
                  var c3 = new THREE.Vector3((Point_step_2_12.x + (sta3.x-Point_step_2_12.x)*0.5/oldl3),(Point_step_2_12.y + (sta3.y-Point_step_2_12.y)*0.5/oldl3),(Point_step_2_12.z + (sta3.z-Point_step_2_12.z)*0.5/oldl3));

                  var TXMeshST23=createSpriteTextstep1("B",c3);
                  step_group_2.add(TXMeshST23);

                  var rotObjectMatrix;
                  function rotateAroundObjectAxis(object, axis, radians) {
                    rotObjectMatrix = new THREE.Matrix4();
                    rotObjectMatrix.makeRotationAxis(axis.normalize(), radians);

                    // old code for Three.JS pre r54:
                    // object.matrix.multiplySelf(rotObjectMatrix);      // post-multiply
                    // new code for Three.JS r55+:
                    object.matrix.multiply(rotObjectMatrix);

                    // old code for Three.js pre r49:
                    // object.rotation.getRotationFromMatrix(object.matrix, object.scale);
                    // old code for Three.js r50-r58:
                    // object.rotation.setEulerFromRotationMatrix(object.matrix);
                    // new code for Three.js r59+:
                    object.rotation.setFromRotationMatrix(object.matrix);
                  }




                  var vertices_step_21 = [
                    TubePoints3[1], mf2,Point_step_2_12,mf,mf3
                  ];

                  var face_step_21 = [
                    new THREE.Face3(0, 1, 2),
                  ]
                  var geom_step_21 = new THREE.Geometry();
                  geom_step_21.vertices = vertices_step_21;
                  geom_step_21.faces = face_step_21;
                  geom_step_21.computeFaceNormals();

                  var material_step_21 = [
                    //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                    new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.1}),
                    new THREE.MeshPhongMaterial({
                      color: 0x009600,transparent: true,opacity:0.3,side:THREE.DoubleSide,
                    } )
                  ];


                  var step_2_face_1 = THREE.SceneUtils.createMultiMaterialObject(geom_step_21, material_step_21);
                  //          var material_step_3 = new THREE.MeshPhongMaterial({color: 0x009600, transparent: true, opacity:0.3, side: THREE.DoubleSide});
                  //          var step_1_face_3 = new THREE.Mesh(geom,material_step_3);
                  step_group_2.add(step_2_face_1);


                  var face_step_22 = [
                    new THREE.Face3(0, 2, 3),
                  ]
                  var geom_step_22 = new THREE.Geometry();
                  geom_step_22.vertices = vertices_step_21;
                  geom_step_22.faces = face_step_22;
                  geom_step_22.computeFaceNormals();

                  var material_step_22 = [
                    //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                    new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.1}),
                    new THREE.MeshPhongMaterial({
                      color: "grey",transparent: true,opacity:0.7,side:THREE.DoubleSide,
                    } )
                  ];


                  var step_2_face_2 = THREE.SceneUtils.createMultiMaterialObject(geom_step_22, material_step_22);
                  //          var material_step_3 = new THREE.MeshPhongMaterial({color: 0x009600, transparent: true, opacity:0.3, side: THREE.DoubleSide});
                  //          var step_1_face_3 = new THREE.Mesh(geom,material_step_3);
                  step_group_2.add(step_2_face_2);

                  var face_step_23 = [
                    new THREE.Face3(0, 2, 4),
                  ]
                  var geom_step_23 = new THREE.Geometry();
                  geom_step_23.vertices = vertices_step_21;
                  geom_step_23.faces = face_step_23;
                  geom_step_23.computeFaceNormals();

                  var material_step_23 = [
                    //new THREE.MeshLambertMaterial({color: 0x4d4dff, transparent: true}),
                    new THREE.MeshBasicMaterial({color: "white", wireframe: true, transparent: true,opacity:0.1}),
                    new THREE.MeshPhongMaterial({
                      color: "grey",transparent: true,opacity:0.7,side:THREE.DoubleSide,
                    } )
                  ];


                  var step_2_face_3 = THREE.SceneUtils.createMultiMaterialObject(geom_step_23, material_step_23);
                  //          var material_step_3 = new THREE.MeshPhongMaterial({color: 0x009600, transparent: true, opacity:0.3, side: THREE.DoubleSide});
                  //          var step_1_face_3 = new THREE.Mesh(geom,material_step_3);
                  step_group_2.add(step_2_face_3);


                  for(i=0;i<=12;i++){
                    step_group_2.children[i].visible=false;
                  }

                  //


                  var SphereTest5 = new THREE.Sphere(new THREE.Vector3(0,0,0),0.7);
                  var PointClose4 = SphereTest5.clampPoint(TubePoints1[1]);

                  var SphereTest6 = new THREE.Sphere(new THREE.Vector3(0,0,0),0.45);
                  var PointClose5 = SphereTest6.clampPoint(TubePoints1[1]);
                  var tubeMesh_apply_2=createCylinderMesh(PointClose4,PointClose5,arrow_apply_1,0.01,0.01);
                  //Tube_group.add(tubeMesh_apply_2);

                  var SphereTest7 = new THREE.Sphere(new THREE.Vector3(0,0,0),0.4);
                  var PointClose6 = SphereTest7.clampPoint(TubePoints1[1]);

                  var SphereTest8 = new THREE.Sphere(new THREE.Vector3(0,0,0),0.1);
                  var PointClose7 = SphereTest8.clampPoint(TubePoints1[1]);
                  var tubeMesh_apply_3=createCylinderMesh(PointClose6,PointClose7,arrow_apply_1,0.01,0.01);
                  //Tube_group.add(tubeMesh_apply_3);



                  //tube sphere1scene.remove(tubeMesh1);

                  // var material = new THREE.MeshBasicMaterial({color: 0xff0000, transparent: false});
                  var material2 = new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.5});

                  var spGeom1 = new THREE.SphereGeometry(0.015);
                  var sp_tube1 = new THREE.Mesh(spGeom1, material2);




                  sp_tube1.position.copy(TubePoints1[1]);

                  sp_tube1.castShadow=false;

                  sp_tube1.name="sp1";//name sphere

                  // add the points as a group to the scene

                  Tube_group.add(sp_tube1);

                  Ctrl_pts.push(sp_tube1);

                  var outlineMaterial3 = new THREE.MeshBasicMaterial( { color: "black", transparent: false, side: THREE.BackSide } );
                  var outlineMesh3 = new THREE.Mesh( spGeom0, outlineMaterial3 );
                  outlineMesh3.position.copy(TubePoints1[1]);
                  outlineMesh3.scale.multiplyScalar(0.3);
                  Tube_group.add( outlineMesh3 );



                  var tubeMesh1=createCylinderMesh(TubePoints1[0],TubePoints1[1],lattice_line_material,0.02,0.02);
                  tubeMesh1.castShadow=true;
                  tubeMesh1.name="tb1";
                  Ctrl_tubes.push(tubeMesh1);



                  var tpoints = [];
                  tpoints.push(TubePoints1[0]);
                  tpoints.push(TubePoints1[1]);

                  var dgeo = new THREE.Geometry().setFromPoints( tpoints );
                  var dashline1 = new THREE.LineDashedMaterial({
                    color: "black",//color
                    dashSize: 0.2,
                    gapSize: 0.03,
                    linewidth: 1

                  });

                  var Dashl = new THREE.LineSegments(dgeo,dashline1);
                  Dashl.computeLineDistances();//dash

                  //      Tube_group.add(tubeMesh1);
                  //        Tube_group.add(Dashl);

                  var arrow_material1=new THREE.MeshPhongMaterial( {
                    color: 0x009600
                  } );

                  var arrow_material_outline = new THREE.MeshBasicMaterial( { color: "white", transparent: false, side: THREE.BackSide } );


                  //force arrow

                  if(TubePoints1[1].z>=0)//p or t

                  var tube_arrow1=createCylinderArrowMesh(new THREE.Vector3(1.4*TubePoints1[1].x,1.4*TubePoints1[1].y,1.4*TubePoints1[1].z),TubePoints1[1],arrow_material1,0.02,0.05,0.6);
                  else
                  var tube_arrow1=createCylinderArrowMesh(TubePoints1[1],new THREE.Vector3(1.4*TubePoints1[1].x,1.4*TubePoints1[1].y,1.4*TubePoints1[1].z),arrow_material1,0.02,0.05,0.6);

                  Tube_group.add(tube_arrow1);

                  if(TubePoints1[1].z>=0)//p or t

                  var tube_arrow12=createCylinderArrowMesh(new THREE.Vector3(1.37*TubePoints1[1].x,1.37*TubePoints1[1].y,1.37*TubePoints1[1].z),TubePoints1[1],arrow_material_outline,0.023,0.05,0.55);
                  else
                  var tube_arrow12=createCylinderArrowMesh(TubePoints1[1],new THREE.Vector3(1.37*TubePoints1[1].x,1.37*TubePoints1[1].y,1.37*TubePoints1[1].z),arrow_material_outline,0.023,0.05,0.55);

                  Tube_group.add(tube_arrow12);
                  tube_arrow12.scale.multiplyScalar(1.2);


                  //tube sphere2

                  var material3 = new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.5});

                  var spGeom2 = new THREE.SphereGeometry(0.022);
                  var sp_tube2 = new THREE.Mesh(spGeom2, material3);
                  sp_tube2.position.copy(TubePoints2[1]);
                  // add the points as a group to the scene
                  sp_tube2.name="sp2";//name sphere
                  Ctrl_pts.push(sp_tube2);
                  Tube_group.add(sp_tube2);
                  sp_tube2.castShadow=false;

                  var outlineMaterial2 = new THREE.MeshBasicMaterial( { color: "black", transparent: false, side: THREE.BackSide } );
                  var outlineMesh2 = new THREE.Mesh( spGeom0, outlineMaterial2 );
                  outlineMesh2.position.copy(TubePoints2[1]);
                  outlineMesh2.scale.multiplyScalar(0.6);
                  Tube_group.add( outlineMesh2 );



                  //force arrow

                  if(arr_direction[0]>=0)//p or t
                  {
                    P_A_Right=Pnt_copy(P_A);
                    P_B_Right=Pnt_copy(P_B);
                    P_C_Right=Pnt_copy(P_C);
                    P_D_Right=Pnt_copy(P_D);


                    var vertices = [
                      P_A_Right,P_B_Right,P_C_Right,P_D_Right
                    ];

                    var face_bar_1 = [
                      new THREE.Face3(0, 2, 3),
                    ]
                    var face_bar_2 = [
                      new THREE.Face3(0, 1, 3),
                    ]
                    var face_bar_3 = [
                      new THREE.Face3(1, 2, 3),
                    ]

                    var face_bar_1_area = new THREE.Vector3().crossVectors(
                      new THREE.Vector3().subVectors( P_C_Right, P_A_Right ),
                      new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
                    ).length()/2

                    var face_bar_2_area = new THREE.Vector3().crossVectors(
                      new THREE.Vector3().subVectors( P_B_Right, P_A_Right ),
                      new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
                    ).length()/2

                    var face_bar_3_area = new THREE.Vector3().crossVectors(
                      new THREE.Vector3().subVectors( P_C_Right, P_B_Right ),
                      new THREE.Vector3().subVectors( P_D_Right, P_B_Right ),
                    ).length()/2

                    var max = Math.max(face_bar_1_area, face_bar_2_area, face_bar_3_area)
                    var tubeMesh2_p1 = face_bar_1_area/max;

                    tt = 0.5*tubethick.v*face_bar_1_area;

                    if (tubeMesh2_p1<0.25 & tubeMesh2_p1>=0)
                    { var Colorbar_blue_1 = new THREE.MeshPhongMaterial( {
                      color: 0x5B84AE
                    } );


                    var geomf1 = new THREE.Geometry();
                    geomf1.vertices = vertices;
                    geomf1.faces = face_bar_1;
                    geomf1.computeFaceNormals();

                    var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0x5B84AE,transparent: true,opacity:0.8,side:THREE.DoubleSide
                    } ) );

                    var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
                    var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_1);
                    var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_blue_1,tt,tt);
                    var tube_arrow2=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z) ,TubePoints2[1],Colorbar_blue_1,0.02,0.05,0.6);
                  }
                  if (tubeMesh2_p1<0.5 & tubeMesh2_p1>=0.25)
                  {  var Colorbar_blue_2 = new THREE.MeshPhongMaterial( {
                    color: 0x376D9B
                  } );

                  var geomf1 = new THREE.Geometry();
                  geomf1.vertices = vertices;
                  geomf1.faces = face_bar_1;
                  geomf1.computeFaceNormals();

                  var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0x376D9B,transparent: true,opacity:0.8,side:THREE.DoubleSide
                  } ) );
                  var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
                  var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_2);
                  var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_blue_2,tt,tt);
                  var tube_arrow2=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z) ,TubePoints2[1],Colorbar_blue_2,0.02,0.05,0.6);
                }
                if (tubeMesh2_p1<0.75 & tubeMesh2_p1>=0.5)
                {  var Colorbar_blue_3 = new THREE.MeshPhongMaterial( {
                  color: 0x05416D
                } );

                var geomf1 = new THREE.Geometry();
                geomf1.vertices = vertices;
                geomf1.faces = face_bar_1;
                geomf1.computeFaceNormals();

                var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0x05416D,transparent: true,opacity:0.8,side:THREE.DoubleSide
                } ) );
                var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
                var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_3);
                var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_blue_3,tt,tt);
                var tube_arrow2=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z) ,TubePoints2[1],Colorbar_blue_3,0.02,0.05,0.6);
              }

              if (tubeMesh2_p1>=0.75)
              {  var Colorbar_blue_4 = new THREE.MeshPhongMaterial( {
                color: 0x0F3150
              } );

              var geomf1 = new THREE.Geometry();
              geomf1.vertices = vertices;
              geomf1.faces = face_bar_1;
              geomf1.computeFaceNormals();

              var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0x0F3150,transparent: true,opacity:0.8,side:THREE.DoubleSide
              } ) );

              var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
              var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_4);
              var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_blue_4,tt,tt);
              var tube_arrow2=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z) ,TubePoints2[1],Colorbar_blue_4,0.02,0.05,0.6);
            }
            //                var tubeMesh2=createCylinderMesh(new THREE.Vector3(TubePoints2[0].x+0.05,TubePoints2[0].y-0.05,TubePoints2[0].z-0.05) ,TubePoints2[1],Colorbar_blue,tt,tt);

            //                var tube_arrow2=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z) ,TubePoints2[1],arrow_material,0.02,0.05,0.6);

          }
          else
          {
            P_A_Right=Pnt_copy(P_A);
            P_B_Right=Pnt_copy(P_B);
            P_C_Right=Pnt_copy(P_C);
            P_D_Right=Pnt_copy(P_D);


            var vertices = [
              P_A_Right,P_B_Right,P_C_Right,P_D_Right
            ];

            var face_bar_1 = [
              new THREE.Face3(0, 2, 3),
            ]
            var face_bar_2 = [
              new THREE.Face3(0, 1, 3),
            ]
            var face_bar_3 = [
              new THREE.Face3(1, 2, 3),
            ]

            var face_bar_1_area = new THREE.Vector3().crossVectors(
              new THREE.Vector3().subVectors( P_C_Right, P_A_Right ),
              new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
            ).length()/2

            var face_bar_2_area = new THREE.Vector3().crossVectors(
              new THREE.Vector3().subVectors( P_B_Right, P_A_Right ),
              new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
            ).length()/2

            var face_bar_3_area = new THREE.Vector3().crossVectors(
              new THREE.Vector3().subVectors( P_C_Right, P_B_Right ),
              new THREE.Vector3().subVectors( P_D_Right, P_B_Right ),
            ).length()/2

            var max = Math.max(face_bar_1_area, face_bar_2_area, face_bar_3_area)
            var tubeMesh2_t1 = face_bar_1_area/max;

            tt = 0.5*tubethick.v*face_bar_2_area;

            if (tubeMesh2_t1<0.25 & tubeMesh2_t1>=0)
            { var Colorbar_red_1 = new THREE.MeshPhongMaterial( {
              color: 0xD72F62
            } );

            var geomf1 = new THREE.Geometry();
            geomf1.vertices = vertices;
            geomf1.faces = face_bar_2;
            geomf1.computeFaceNormals();

            var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0xD72F62,transparent: true,opacity:0.8,side:THREE.DoubleSide
            } ) );
            var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
            var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_1);
            var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_red_1,tt,tt);
            var tube_arrow2=createCylinderArrowMesh(TubePoints2[1],new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z),Colorbar_red_1,0.02,0.05,0.6);
          }
          if (tubeMesh2_t1<0.5 & tubeMesh2_t1>=0.25)
          {  var Colorbar_red_2 = new THREE.MeshPhongMaterial( {
            color: 0xCC0549
          } );

          var geomf1 = new THREE.Geometry();
          geomf1.vertices = vertices;
          geomf1.faces = face_bar_2;
          geomf1.computeFaceNormals();

          var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0xCC0549,transparent:true,opacity:0.8,side:THREE.DoubleSide
          } ) );
          var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
          var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_2);
          var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_red_2,tt,tt);
          var tube_arrow2=createCylinderArrowMesh(TubePoints2[1],new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z),Colorbar_red_2,0.02,0.05,0.6);
        }
        if (tubeMesh2_t1<0.75 & tubeMesh2_t1>=0.5)
        {  var Colorbar_red_3 = new THREE.MeshPhongMaterial( {
          color: 0x940041
        } );
        var geomf1 = new THREE.Geometry();
        geomf1.vertices = vertices;
        geomf1.faces = face_bar_2;
        geomf1.computeFaceNormals();

        var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0x940041,transparent: true,opacity:0.8,side:THREE.DoubleSide
        } ) );
        var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
        var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_3);
        var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_red_3,tt,tt);
        var tube_arrow2=createCylinderArrowMesh(TubePoints2[1],new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z),Colorbar_red_3,0.02,0.05,0.6);
      }

      if (tubeMesh2_t1>=0.75)
      {  var Colorbar_red_4 = new THREE.MeshPhongMaterial( {
        color: 0x80002F
      } );
      var geomf1 = new THREE.Geometry();
      geomf1.vertices = vertices;
      geomf1.faces = face_bar_2;
      geomf1.computeFaceNormals();

      var meshf1 = new THREE.Mesh( geomf1, new THREE.MeshLambertMaterial({color: 0x80002F,transparent: true,opacity:0.8,side:THREE.DoubleSide
      } ) );
      var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
      var SphereTest3_SP = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_4);
      var tubeMesh2=createCylinderMesh(TubePoints2[1],PointClose2,Colorbar_red_4,tt,tt);
      var tube_arrow2=createCylinderArrowMesh(TubePoints2[1],new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z),Colorbar_red_4,0.02,0.05,0.6);
    }

    //              var tubeMesh2=createCylinderMesh(new THREE.Vector3(TubePoints2[0].x-0.05,TubePoints2[0].y+0.05,TubePoints2[0].z+0.05) ,TubePoints2[1],Colorbar_red1,tt,tt);
    //              var tube_arrow2=createCylinderArrowMesh(TubePoints2[1],new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z),arrow_material2,0.02,0.05,0.6);
  }
  tubeMesh2.castShadow=true;
  tubeMesh2.name="tb2";
  Ctrl_tubes.push(tubeMesh2);
  SphereTest3_SP.position.copy(PointClose2);

  Tube_group.add(tubeMesh2);
  Tube_group.add(tube_arrow2);
  Tube_group.add(SphereTest3_SP);
  Tube_group_force.add(meshf1);

  if(arr_direction[0]>=0)//p or t

  var tube_arrow22=createCylinderArrowMesh(new THREE.Vector3(1.2*TubePoints2[1].x,1.2*TubePoints2[1].y,1.2*TubePoints2[1].z) ,TubePoints2[1],arrow_material_outline,0.023,0.05,0.54);

  else
  var tube_arrow22=createCylinderArrowMesh(TubePoints2[1],new THREE.Vector3(1.2*TubePoints2[1].x,1.2*TubePoints2[1].y,1.2*TubePoints2[1].z),arrow_material_outline,0.023,0.055,0.62);

  Tube_group.add(tube_arrow22);
  tube_arrow22.scale.multiplyScalar(1.2);

  //tube sphere3

  var material4 = new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.5});

  var spGeom3 = new THREE.SphereGeometry(0.015);
  var sp_tube3 = new THREE.Mesh(spGeom3, material4);
  sp_tube3.position.copy(TubePoints3[1]);
  sp_tube3.name="sp3";//name sphere
  // add the points as a group to the scene
  Ctrl_pts.push(sp_tube3);
  Tube_group.add(sp_tube3);
  sp_tube3.castShadow=false;

  var outlineMaterial4 = new THREE.MeshBasicMaterial( { color: "black", transparent: false, side: THREE.BackSide } );
  var outlineMesh4 = new THREE.Mesh( spGeom0, outlineMaterial4 );
  outlineMesh4.position.copy(TubePoints3[1]);
  outlineMesh4.scale.multiplyScalar(0.6);
  Tube_group.add( outlineMesh4 );

  var SphereTest = new THREE.Sphere(new THREE.Vector3(0,0,0),0.07);
  var PointClose1_2 = SphereTest.clampPoint(TubePoints3[1]);
  var SphereTest2_2 = new THREE.Sphere(PointClose1_2,0.05);
  var PointClose2_2 = SphereTest2_2.clampPoint(TubePoints3[1]);
  var SphereTest3_2 = new THREE.Sphere(PointClose2_2,0.045);

  //force arrow

  if(arr_direction[1]>=0){

    P_A_Right=Pnt_copy(P_A);
    P_B_Right=Pnt_copy(P_B);
    P_C_Right=Pnt_copy(P_C);
    P_D_Right=Pnt_copy(P_D);


    var vertices = [
      P_A_Right,P_B_Right,P_C_Right,P_D_Right
    ];

    var face_bar_1 = [
      new THREE.Face3(0, 2, 3),
    ]
    var face_bar_2 = [
      new THREE.Face3(0, 1, 3),
    ]
    var face_bar_3 = [
      new THREE.Face3(1, 2, 3),
    ]

    var face_bar_1_area = new THREE.Vector3().crossVectors(
      new THREE.Vector3().subVectors( P_C_Right, P_A_Right ),
      new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
    ).length()/2

    var face_bar_2_area = new THREE.Vector3().crossVectors(
      new THREE.Vector3().subVectors( P_B_Right, P_A_Right ),
      new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
    ).length()/2

    var face_bar_3_area = new THREE.Vector3().crossVectors(
      new THREE.Vector3().subVectors( P_C_Right, P_B_Right ),
      new THREE.Vector3().subVectors( P_D_Right, P_B_Right ),
    ).length()/2

    var max = Math.max(face_bar_1_area, face_bar_2_area, face_bar_3_area)
    var tubeMesh3_p2 = face_bar_2_area/max;
    tt = 0.5*tubethick.v*face_bar_2_area;

    if (tubeMesh3_p2<0.25 & tubeMesh3_p2>=0)
    { var Colorbar_blue_1 = new THREE.MeshPhongMaterial( {
      color: 0x5B84AE
    } );
    var geomf2 = new THREE.Geometry();
    geomf2.vertices = vertices;
    geomf2.faces = face_bar_2;
    geomf2.computeFaceNormals();

    var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0x5B84AE,transparent: true,opacity:0.8,side:THREE.DoubleSide
    } ) );

    var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
    var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_1);
    var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_blue_1,tt,tt);
    var tube_arrow3=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z) ,TubePoints3[1],Colorbar_blue_1,0.02,0.05,0.6);
  }
  if (tubeMesh3_p2<0.5 & tubeMesh3_p2>=0.25)
  {  var Colorbar_blue_2 = new THREE.MeshPhongMaterial( {
    color: 0x376D9B
  } );
  var geomf2 = new THREE.Geometry();
  geomf2.vertices = vertices;
  geomf2.faces = face_bar_2;
  geomf2.computeFaceNormals();

  var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0x376D9B,transparent:true,opacity:0.8,side:THREE.DoubleSide
  } ) );
  var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
  var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_2);
  var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_blue_2,tt,tt);
  var tube_arrow3=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z) ,TubePoints3[1],Colorbar_blue_2,0.02,0.05,0.6);
}
if (tubeMesh3_p2<0.75 & tubeMesh3_p2>=0.5)
{  var Colorbar_blue_3 = new THREE.MeshPhongMaterial( {
  color: 0x05416D
} );
var geomf2 = new THREE.Geometry();
geomf2.vertices = vertices;
geomf2.faces = face_bar_2;
geomf2.computeFaceNormals();

var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0x05416D,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_3);
var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_blue_3,tt,tt);
var tube_arrow3=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z) ,TubePoints3[1],Colorbar_blue_3,0.02,0.05,0.6);
}

if (tubeMesh3_p2>=0.75)
{  var Colorbar_blue_4 = new THREE.MeshPhongMaterial( {
  color: 0x0F3150
} );
var geomf2 = new THREE.Geometry();
geomf2.vertices = vertices;
geomf2.faces = face_bar_2;
geomf2.computeFaceNormals();

var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0x0F3150,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_4);
var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_blue_4,tt,tt);
var tube_arrow3=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z) ,TubePoints3[1],Colorbar_blue_4,0.02,0.05,0.6);
}

//                var tubeMesh3=createCylinderMesh(new THREE.Vector3(TubePoints3[0].x-0.07,TubePoints3[0].y-0.03,TubePoints3[0].z-0.03) ,TubePoints3[1],Colorbar_blue1,tt,tt);
//                var tube_arrow3=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z) ,TubePoints3[1],arrow_material,0.02,0.05,0.6);
}
else
{

  P_A_Right=Pnt_copy(P_A);
  P_B_Right=Pnt_copy(P_B);
  P_C_Right=Pnt_copy(P_C);
  P_D_Right=Pnt_copy(P_D);


  var vertices = [
    P_A_Right,P_B_Right,P_C_Right,P_D_Right
  ];

  var face_bar_1 = [
    new THREE.Face3(0, 2, 3),
  ]
  var face_bar_2 = [
    new THREE.Face3(0, 1, 3),
  ]
  var face_bar_3 = [
    new THREE.Face3(1, 2, 3),
  ]

  var face_bar_1_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_C_Right, P_A_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
  ).length()/2

  var face_bar_2_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_B_Right, P_A_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
  ).length()/2

  var face_bar_3_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_C_Right, P_B_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_B_Right ),
  ).length()/2

  var max = Math.max(face_bar_1_area, face_bar_2_area, face_bar_3_area)
  var tubeMesh3_t2 = face_bar_2_area/max;
  tt = 0.5*tubethick.v*face_bar_2_area;

  if (tubeMesh3_t2<0.25 & tubeMesh3_t2>=0)
  { var Colorbar_red_1 = new THREE.MeshPhongMaterial( {
    color: 0xD72F62
  } );
  var geomf2 = new THREE.Geometry();
  geomf2.vertices = vertices;
  geomf2.faces = face_bar_2;
  geomf2.computeFaceNormals();

  var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0xD72F62,transparent: true,opacity:0.8,side:THREE.DoubleSide
  } ) );
  var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
  var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_1);
  var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_red_1,tt,tt);
  var tube_arrow3=createCylinderArrowMesh(TubePoints3[1],new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z),Colorbar_red_1,0.02,0.05,0.6);
}
if (tubeMesh3_t2<0.5 & tubeMesh3_t2>=0.25)
{  var Colorbar_red_2 = new THREE.MeshPhongMaterial( {
  color: 0xCC0549
} );
var geomf2 = new THREE.Geometry();
geomf2.vertices = vertices;
geomf2.faces = face_bar_2;
geomf2.computeFaceNormals();

var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0xCC0549,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_2);
var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_red_2,tt,tt);
var tube_arrow3=createCylinderArrowMesh(TubePoints3[1],new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z),Colorbar_red_2,0.02,0.05,0.6);
}
if (tubeMesh3_t2<0.75 & tubeMesh3_t2>=0.5)
{  var Colorbar_red_3 = new THREE.MeshPhongMaterial( {
  color: 0x940041
} );
var geomf2 = new THREE.Geometry();
geomf2.vertices = vertices;
geomf2.faces = face_bar_2;
geomf2.computeFaceNormals();

var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0x940041,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_3);
var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_red_3,tt,tt);
var tube_arrow3=createCylinderArrowMesh(TubePoints3[1],new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z),Colorbar_red_3,0.02,0.05,0.6);
}

if (tubeMesh3_t2>=0.75)
{  var Colorbar_red_4 = new THREE.MeshPhongMaterial( {
  color: 0x80002F
} );
var geomf2 = new THREE.Geometry();
geomf2.vertices = vertices;
geomf2.faces = face_bar_2;
geomf2.computeFaceNormals();

var meshf2 = new THREE.Mesh( geomf2, new THREE.MeshLambertMaterial({color: 0x80002F,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_2 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_4);
var tubeMesh3=createCylinderMesh(TubePoints3[1],PointClose2_2,Colorbar_red_4,tt,tt);
var tube_arrow3=createCylinderArrowMesh(TubePoints3[1],new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z),Colorbar_red_4,0.02,0.05,0.6);
}

//                var tubeMesh3=createCylinderMesh(new THREE.Vector3(TubePoints3[0].x+0.07,TubePoints3[0].y+0.03,TubePoints3[0].z+0.03),TubePoints3[1],Colorbar_red1,tt,tt);
//                var tube_arrow3=createCylinderArrowMesh(TubePoints3[1],new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z),arrow_material2,0.02,0.05,0.6);
}

tubeMesh3.castShadow=true;
tubeMesh3.name="tb3";
Ctrl_tubes.push(tubeMesh3);
SphereTest3_SP_2.position.copy(PointClose2_2);

Tube_group.add(tubeMesh3);
Tube_group.add(tube_arrow3);
Tube_group.add(SphereTest3_SP_2);
Tube_group_force.add(meshf2);

if(arr_direction[1]>=0)

var tube_arrow32=createCylinderArrowMesh(new THREE.Vector3(1.2*TubePoints3[1].x,1.2*TubePoints3[1].y,1.2*TubePoints3[1].z) ,TubePoints3[1],arrow_material_outline,0.023,0.05,0.54);
else
var tube_arrow32=createCylinderArrowMesh(TubePoints3[1],new THREE.Vector3(1.2*TubePoints3[1].x,1.2*TubePoints3[1].y,1.2*TubePoints3[1].z),arrow_material_outline,0.023,0.055,0.62);

Tube_group.add(tube_arrow32);
tube_arrow32.scale.multiplyScalar(1.2);

//tube sphere4
var material5 = new THREE.MeshPhongMaterial({color: "white", transparent: true, opacity:0.5});

var spGeom4 = new THREE.SphereGeometry(0.015);
var sp_tube4= new THREE.Mesh(spGeom4, material5);
sp_tube4.position.copy(TubePoints4[1]);
sp_tube4.castShadow=false;

sp_tube4.name="sp4";//name sphere
Ctrl_pts.push(sp_tube4);
// add the points as a group to the scene
Tube_group.add(sp_tube4);

var outlineMaterial5 = new THREE.MeshBasicMaterial( { color: "black", transparent: false, side: THREE.BackSide } );
var outlineMesh5 = new THREE.Mesh( spGeom0, outlineMaterial5 );
outlineMesh5.position.copy(TubePoints4[1]);
outlineMesh5.scale.multiplyScalar(0.6);
Tube_group.add( outlineMesh5 );

var SphereTest = new THREE.Sphere(new THREE.Vector3(0,0,0),0.07);
var PointClose1_3 = SphereTest.clampPoint(TubePoints4[1]);
var SphereTest2_3 = new THREE.Sphere(PointClose1_3,0.05);
var PointClose2_3 = SphereTest2_3.clampPoint(TubePoints4[1]);
var SphereTest3_3 = new THREE.Sphere(PointClose2_3,0.045);

//force arrow

if(arr_direction[2]>=0){
  P_A_Right=Pnt_copy(P_A);
  P_B_Right=Pnt_copy(P_B);
  P_C_Right=Pnt_copy(P_C);
  P_D_Right=Pnt_copy(P_D);


  var vertices = [
    P_A_Right,P_B_Right,P_C_Right,P_D_Right
  ];

  var face_bar_1 = [
    new THREE.Face3(0, 2, 3),
  ]
  var face_bar_2 = [
    new THREE.Face3(0, 1, 3),
  ]
  var face_bar_3 = [
    new THREE.Face3(1, 2, 3),
  ]

  var face_bar_1_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_C_Right, P_A_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
  ).length()/2

  var face_bar_2_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_B_Right, P_A_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
  ).length()/2

  var face_bar_3_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_C_Right, P_B_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_B_Right ),
  ).length()/2

  var max = Math.max(face_bar_1_area, face_bar_2_area, face_bar_3_area)
  var tubeMesh4_p3 = face_bar_3_area/max;
  tt = 0.5*tubethick.v*face_bar_3_area;

  if (tubeMesh4_p3<0.25 & tubeMesh4_p3>=0)
  { var Colorbar_blue_1 = new THREE.MeshPhongMaterial( {
    color: 0x5B84AE
  } );
  var geomf3 = new THREE.Geometry();
  geomf3.vertices = vertices;
  geomf3.faces = face_bar_3;
  geomf3.computeFaceNormals();

  var meshf3 = new THREE.Mesh( geomf3, new THREE.MeshLambertMaterial({color: 0x5B84AE,transparent: true,opacity:0.8,side:THREE.DoubleSide
  } ) );
  var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
  var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_1);
  var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_blue_1,tt,tt);
  var tube_arrow4=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z) ,TubePoints4[1],Colorbar_blue_1,0.02,0.05,0.6);
}
if (tubeMesh4_p3<0.5 & tubeMesh4_p3>=0.25)
{  var Colorbar_blue_2 = new THREE.MeshPhongMaterial( {
  color: 0x376D9B
} );
var geomf3 = new THREE.Geometry();
geomf3.vertices = vertices;
geomf3.faces = face_bar_3;
geomf3.computeFaceNormals();

var meshf3 = new THREE.Mesh( geomf3, new THREE.MeshLambertMaterial({color: 0x376D9B,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_2);
var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_blue_2,tt,tt);
var tube_arrow4=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z) ,TubePoints4[1],Colorbar_blue_2,0.02,0.05,0.6);
}
if (tubeMesh4_p3<0.75 & tubeMesh4_p3>=0.5)
{  var Colorbar_blue_3 = new THREE.MeshPhongMaterial( {
  color: 0x05416D
} );
var geomf3 = new THREE.Geometry();
geomf3.vertices = vertices;
geomf3.faces = face_bar_3;
geomf3.computeFaceNormals();

var meshf3 = new THREE.Mesh( geomf3, new THREE.MeshLambertMaterial({color: 0x05416D,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_3);
var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_blue_3,tt,tt);
var tube_arrow4=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z) ,TubePoints4[1],Colorbar_blue_3,0.02,0.05,0.6);
}

if (tubeMesh4_p3>=0.75)
{  var Colorbar_blue_4 = new THREE.MeshPhongMaterial( {
  color: 0x0F3150
} );
var geomf3 = new THREE.Geometry();
geomf3.vertices = vertices;
geomf3.faces = face_bar_3;
geomf3.computeFaceNormals();

var meshf3 = new THREE.Mesh( geomf3, new THREE.MeshLambertMaterial({color: 0x0F3150,transparent: true,opacity:0.8,side:THREE.DoubleSide
} ) );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_blue_4);
var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_blue_4,tt,tt);
var tube_arrow4=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z) ,TubePoints4[1],Colorbar_blue_4,0.02,0.05,0.6);
}

//                var tubeMesh4=createCylinderMesh(new THREE.Vector3(TubePoints4[0].x+0.01,TubePoints4[0].y+0.07,TubePoints4[0].z-0.05) ,TubePoints4[1],Colorbar_blue1,tt,tt);
//                var tube_arrow4=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z) ,TubePoints4[1],arrow_material,0.02,0.05,0.6);
}
else
{
  P_A_Right=Pnt_copy(P_A);
  P_B_Right=Pnt_copy(P_B);
  P_C_Right=Pnt_copy(P_C);
  P_D_Right=Pnt_copy(P_D);


  var vertices = [
    P_A_Right,P_B_Right,P_C_Right,P_D_Right
  ];

  var face_bar_1 = [
    new THREE.Face3(0, 2, 3),
  ]
  var face_bar_2 = [
    new THREE.Face3(0, 1, 3),
  ]
  var face_bar_3 = [
    new THREE.Face3(1, 2, 3),
  ]

  var face_bar_1_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_C_Right, P_A_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
  ).length()/2

  var face_bar_2_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_B_Right, P_A_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_A_Right ),
  ).length()/2

  var face_bar_3_area = new THREE.Vector3().crossVectors(
    new THREE.Vector3().subVectors( P_C_Right, P_B_Right ),
    new THREE.Vector3().subVectors( P_D_Right, P_B_Right ),
  ).length()/2

  var max = Math.max(face_bar_1_area, face_bar_2_area, face_bar_3_area)
  var tubeMesh4_t3 = face_bar_3_area/max;
  tt = 0.5*tubethick.v*face_bar_3_area;

  if (tubeMesh4_t3<0.25 & tubeMesh4_t3>=0)
  { var Colorbar_red_1 = new THREE.MeshPhongMaterial( {
    color: 0xD72F62
  } );
  var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
  var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_1);
  var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_red_1,tt,tt);
  var tube_arrow4=createCylinderArrowMesh(TubePoints4[1],new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z),Colorbar_red_1,0.02,0.05,0.6);
}
if (tubeMesh4_t3<0.5 & tubeMesh4_t3>=0.25)
{  var Colorbar_red_2 = new THREE.MeshPhongMaterial( {
  color: 0xCC0549
} );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_2);
var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_red_2,tt,tt);
var tube_arrow4=createCylinderArrowMesh(TubePoints4[1],new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z),Colorbar_red_2,0.02,0.05,0.6);
}
if (tubeMesh4_t3<0.75 & tubeMesh4_t3>=0.5)
{  var Colorbar_red_3 = new THREE.MeshPhongMaterial( {
  color: 0x940041
} );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_3);
var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_red_3,tt,tt);
var tube_arrow4=createCylinderArrowMesh(TubePoints4[1],new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z),Colorbar_red_3,0.02,0.05,0.6);
}

if (tubeMesh4_t3>=0.75)
{  var Colorbar_red_4 = new THREE.MeshPhongMaterial( {
  color: 0x80002F
} );
var SphereTest3_Geo = new THREE.SphereGeometry(tt-0.001);
var SphereTest3_SP_3 = new THREE.Mesh(SphereTest3_Geo, Colorbar_red_4);
var tubeMesh4=createCylinderMesh(TubePoints4[1],PointClose2_3,Colorbar_red_4,tt,tt);
var tube_arrow4=createCylinderArrowMesh(TubePoints4[1],new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z),Colorbar_red_4,0.02,0.05,0.6);
}

//                  var tubeMesh4=createCylinderMesh(new THREE.Vector3(TubePoints4[0].x-0.01,TubePoints4[0].y-0.07,TubePoints4[0].z+0.05),TubePoints4[1],Colorbar_red1,tt,tt);
//                  var tube_arrow4=createCylinderArrowMesh(TubePoints4[1],new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z),arrow_material2,0.02,0.05,0.6);
}
tubeMesh4.castShadow=true;
tubeMesh4.name="tb4";
Ctrl_tubes.push(tubeMesh4);
SphereTest3_SP_3.position.copy(PointClose2_3);

Tube_group.add(tubeMesh4);
Tube_group.add(tube_arrow4);
Tube_group.add(SphereTest3_SP_3);
Tube_group_force.add(meshf3);


if(arr_direction[2]>=0){

  var tube_arrow42=createCylinderArrowMesh(new THREE.Vector3(1.2*TubePoints4[1].x,1.2*TubePoints4[1].y,1.2*TubePoints4[1].z) ,TubePoints4[1],arrow_material_outline,0.023,0.05,0.54);
}
else
{

  var tube_arrow42=createCylinderArrowMesh(TubePoints4[1],new THREE.Vector3(1.2*TubePoints4[1].x,1.2*TubePoints4[1].y,1.2*TubePoints4[1].z),arrow_material_outline,0.023,0.055,0.62);
}
Tube_group.add(tube_arrow42);
tube_arrow42.scale.multiplyScalar(1.2);








//Tube_group.geometry.center();

scene.add(Tube_group);
scene.add(step_group_1);
scene.add(step_group_2);
scene.add(step_group_cell);
scene2.add(step_group_1_1);
//scene2.add(Tube_group_force);










//arrow

L=3//scale

Cal_ForcesPnt();//point

Force_move();

P_A_Right=Pnt_copy(P_A);
P_B_Right=Pnt_copy(P_B);
P_C_Right=Pnt_copy(P_C);
P_D_Right=Pnt_copy(P_D);



var vertices = [
  P_A_Right,P_B_Right,P_C_Right,P_D_Right
];

corePoint_body=new THREE.Vector3();

corePoint_body.x=(P_A_Right.x+P_B_Right.x+P_C_Right.x+P_D_Right.x)/4;
corePoint_body.y=(P_A_Right.y+P_B_Right.y+P_C_Right.y+P_D_Right.y)/4;
corePoint_body.z=(P_A_Right.z+P_B_Right.z+P_C_Right.z+P_D_Right.z)/4;

//console.log("TubePoints1="+P_A.z);

// for (i = 0;i<geom.faces.length;i++){
//         var hex = Math.random() * 0xffffff;
//         geom.faces[i].color.setHex(hex);

// mesh.children[1].geometry.faces[0].color.set(0xc4c400);
//  mesh.children[1].geometry.facesNeedUpdate=true;
//  mesh.children[1].geometry.elementsNeedUpdate = true;
//     mesh.children[1].geometry.computeFaceNormals();

// mesh.children[1].geometry.faces[0].color.set(0xFF6347);


//                     //mesh.children[1].geometry.faces[Number(INTERSECTED.name.charAt(2))-1].material.opacity;
// mesh.children[1].geometry.facesNeedUpdate=true;
// mesh.children[1].geometry.elementsNeedUpdate = true;
// mesh.children[1].geometry.computeFaceNormals();


mesh.children.forEach(function (e) {
  e.geometry.vertices = vertices;
  e.geometry.verticesNeedUpdate = true;

  // e.geometry.faces[0].color.set(0xff00ee);
  // e.geometry.facesNeedUpdate=true;
  e.geometry.elementsNeedUpdate = true;
  e.geometry.computeFaceNormals();
  //e.geometry.center();
});



// var face_centerA=new THREE.Vector3();
// var face_centerA1=new THREE.Vector3();



// face_centerA.x=(P_A_Right.x+P_B_Right.x+P_C_Right.x)/3;
// face_centerA.y=(P_A_Right.y+P_B_Right.y+P_C_Right.y)/3;
// face_centerA.z=(P_A_Right.z+P_B_Right.z+P_C_Right.z)/3;

// //var faceA = new THREE.Vector3().subVectors(P_A_Right, face_centerA);


// if(TubePoints1[1].z<0||arr_direction[0]<0||arr_direction[1]<0||arr_direction[2]<0)
// {

//     //var faceA = new THREE.Vector3().subVectors(P_A_Right, face_centerA);
//     var lengthA=0.5;

//     face_centerA1.x=(lengthA*TubePoints1[1].x)/norm(TubePoints1[1])+face_centerA.x;
//     face_centerA1.y=(lengthA*TubePoints1[1].y)/norm(TubePoints1[1])+face_centerA.y;
//     face_centerA1.z=(lengthA*TubePoints1[1].z)/norm(TubePoints1[1])+face_centerA.z;

//     face_arrow1=createCylinderArrowMesh(face_centerA,face_centerA1,arrow_material,0.02,0.05,0.7);
// }
// else
// {
//     var lengthA=0.5;

//     face_centerA1.x=(lengthA*TubePoints1[1].x)/norm(TubePoints1[1])+face_centerA.x;
//     face_centerA1.y=(lengthA*TubePoints1[1].y)/norm(TubePoints1[1])+face_centerA.y;
//     face_centerA1.z=(lengthA*TubePoints1[1].z)/norm(TubePoints1[1])+face_centerA.z;


//     face_arrow1=createCylinderArrowMesh(face_centerA1,face_centerA,arrow_material,0.02,0.05,0.7);
// }







// //face_arrow1.geometry.center();

// scene2.add(face_arrow1);

// var face_centerB=new THREE.Vector3();
// var face_centerB1=new THREE.Vector3();



// face_centerB.x=(P_A_Right.x+P_D_Right.x+P_B_Right.x)/3;
// face_centerB.y=(P_A_Right.y+P_D_Right.y+P_B_Right.y)/3;
// face_centerB.z=(P_A_Right.z+P_D_Right.z+P_B_Right.z)/3;




// if(TubePoints1[1].z<0||arr_direction[0]<0||arr_direction[1]<0||arr_direction[2]<0)
// {
//     var lengthB=0.5;
//     face_centerB1.x=lengthB*TubePoints2[1].x/norm(TubePoints2[1])+face_centerB.x;
//     face_centerB1.y=lengthB*TubePoints2[1].y/norm(TubePoints2[1])+face_centerB.y;
//     face_centerB1.z=lengthB*TubePoints2[1].z/norm(TubePoints2[1])+face_centerB.z;
//     face_arrow2=createCylinderArrowMesh(face_centerB,face_centerB1,arrow_material,0.02,0.05,0.7);
// }
// else
// {
//     var lengthB=0.5;
//     face_centerB1.x=lengthB*TubePoints2[1].x/norm(TubePoints2[1])+face_centerB.x;
//     face_centerB1.y=lengthB*TubePoints2[1].y/norm(TubePoints2[1])+face_centerB.y;
//     face_centerB1.z=lengthB*TubePoints2[1].z/norm(TubePoints2[1])+face_centerB.z;

//     face_arrow2=createCylinderArrowMesh(face_centerB1,face_centerB,arrow_material,0.02,0.05,0.7);
// }


// //face_arrow1.geometry.center();

// scene2.add(face_arrow2);


// var face_centerC=new THREE.Vector3();
// var face_centerC1=new THREE.Vector3();



// face_centerC.x=(P_C_Right.x+P_D_Right.x+P_B_Right.x)/3;
// face_centerC.y=(P_C_Right.y+P_D_Right.y+P_B_Right.y)/3;
// face_centerC.z=(P_C_Right.z+P_D_Right.z+P_B_Right.z)/3;




// if(TubePoints1[1].z<0||arr_direction[0]<0||arr_direction[1]<0||arr_direction[2]<0)
// {
//     var lengthC=0.5;
//     face_centerC1.x=lengthC*TubePoints3[1].x/norm(TubePoints3[1])+face_centerC.x;
//     face_centerC1.y=lengthC*TubePoints3[1].y/norm(TubePoints3[1])+face_centerC.y;
//     face_centerC1.z=lengthC*TubePoints3[1].z/norm(TubePoints3[1])+face_centerC.z;


//     face_arrow3=createCylinderArrowMesh(face_centerC,face_centerC1,arrow_material,0.02,0.05,0.7);
// }
// else
// {
//     var lengthC=0.5;
//     face_centerC1.x=lengthC*TubePoints3[1].x/norm(TubePoints3[1])+face_centerC.x;
//     face_centerC1.y=lengthC*TubePoints3[1].y/norm(TubePoints3[1])+face_centerC.y;
//     face_centerC1.z=lengthC*TubePoints3[1].z/norm(TubePoints3[1])+face_centerC.z;

//     face_arrow3=createCylinderArrowMesh(face_centerC1,face_centerC,arrow_material,0.02,0.05,0.7);
// }

// //face_arrow1.geometry.center();

// scene2.add(face_arrow3);


// var face_centerD=new THREE.Vector3();
// var face_centerD1=new THREE.Vector3();


// face_centerD.x=(P_C_Right.x+P_D_Right.x+P_A_Right.x)/3;
// face_centerD.y=(P_C_Right.y+P_D_Right.y+P_A_Right.y)/3;
// face_centerD.z=(P_C_Right.z+P_D_Right.z+P_A_Right.z)/3;




// if(TubePoints1[1].z<0||arr_direction[0]<0||arr_direction[1]<0||arr_direction[2]<0)
// {
//     var lengthD=0.5;
//     face_centerD1.x=lengthD*TubePoints4[1].x/norm(TubePoints4[1])+face_centerD.x;
//     face_centerD1.y=lengthD*TubePoints4[1].y/norm(TubePoints4[1])+face_centerD.y;
//     face_centerD1.z=lengthD*TubePoints4[1].z/norm(TubePoints4[1])+face_centerD.z;


//     face_arrow4=createCylinderArrowMesh(face_centerD,face_centerD1,arrow_material,0.02,0.05,0.7);
// }
// else
// {
//     var lengthD=0.5;
//     face_centerD1.x=lengthD*TubePoints4[1].x/norm(TubePoints4[1])+face_centerD.x;
//     face_centerD1.y=lengthD*TubePoints4[1].y/norm(TubePoints4[1])+face_centerD.y;
//     face_centerD1.z=lengthD*TubePoints4[1].z/norm(TubePoints4[1])+face_centerD.z;
//     face_arrow4=createCylinderArrowMesh(face_centerD1,face_centerD,arrow_material,0.02,0.05,0.7);
// }

// //face_arrow1.geometry.center();

// scene2.add(face_arrow4);



// if(TubePoints1[1].z<0||arr_direction[0]<0||arr_direction[1]<0||arr_direction[2]<0)
//     var arr_face_dir=false;
// else
//     var arr_face_dir=true;




mesh_TriFace1=create_Tri_FaceMesh(P_A_Right,P_B_Right,P_C_Right,Force_face_dir[0],true,TubePoints1[1].z,'n1');
mesh_TriFace_step_f1=create_Tri_FaceMesh_t(P_A_Right,P_B_Right,P_C_Right,Force_face_dir[0],true,TubePoints1[1].z,'n1');



if(Change_N3N4&&Change_BC)
{

  mesh_TriFace2=create_Tri_FaceMesh(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[1],'n3');
  mesh_TriFace3=create_Tri_FaceMesh(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[2],'n4');
  mesh_TriFace4=create_Tri_FaceMesh(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[0],'n2');

  mesh_TriFace2_stepar=create_Tri_FaceMesh_step(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[1],'n3');

  mesh_TriFace_step_f2=create_Tri_FaceMesh_p(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[1],'n3');
  mesh_TriFace_step_f21=create_Tri_FaceMesh_t(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[1],'n3');
  mesh_TriFace_step_f3=create_Tri_FaceMesh_t(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[2],'n4');
  mesh_TriFace_step_f4=create_Tri_FaceMesh_t(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[0],'n2');


}
else if(!Change_N3N4&&Change_BC)
{
  mesh_TriFace2=create_Tri_FaceMesh(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[2],'n4');
  mesh_TriFace3=create_Tri_FaceMesh(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[1],'n3');
  mesh_TriFace4=create_Tri_FaceMesh(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[0],'n2');

  mesh_TriFace2_stepar=create_Tri_FaceMesh_step(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[2],'n4');

  mesh_TriFace_step_f2=create_Tri_FaceMesh_p(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[2],'n4');
  mesh_TriFace_step_f21=create_Tri_FaceMesh_t(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[2],'n4');
  mesh_TriFace_step_f3=create_Tri_FaceMesh_t(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[1],'n3');
  mesh_TriFace_step_f4=create_Tri_FaceMesh_t(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[0],'n2');



}else if(Change_N3N4&&!Change_BC)
{
  mesh_TriFace2=create_Tri_FaceMesh(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');
  mesh_TriFace3=create_Tri_FaceMesh(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[2],'n4');
  mesh_TriFace4=create_Tri_FaceMesh(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[1],'n3');

  mesh_TriFace2_stepar=create_Tri_FaceMesh_step(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');

  mesh_TriFace_step_f2=create_Tri_FaceMesh_p(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');
  mesh_TriFace_step_f21=create_Tri_FaceMesh_t(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');
  mesh_TriFace_step_f3=create_Tri_FaceMesh_t(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[2],'n4');
  mesh_TriFace_step_f4=create_Tri_FaceMesh_t(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[1],'n3');

}
else if(!Change_N3N4&&!Change_BC)
{
  mesh_TriFace2=create_Tri_FaceMesh(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');
  mesh_TriFace3=create_Tri_FaceMesh(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[1],'n3');
  mesh_TriFace4=create_Tri_FaceMesh(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[2],'n4');

  mesh_TriFace2_stepar=create_Tri_FaceMesh_step(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');

  mesh_TriFace_step_f2=create_Tri_FaceMesh_p(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');
  mesh_TriFace_step_f21=create_Tri_FaceMesh_t(P_A_Right,P_D_Right,P_B_Right,Force_face_dir[2],false,arr_direction[0],'n2');
  mesh_TriFace_step_f3=create_Tri_FaceMesh_t(P_B_Right,P_D_Right,P_C_Right,Force_face_dir[3],false,arr_direction[1],'n3');
  mesh_TriFace_step_f4=create_Tri_FaceMesh_t(P_A_Right,P_C_Right,P_D_Right,Force_face_dir[1],false,arr_direction[2],'n4');

}

scene2.add(mesh_TriFace1);
scene2.add(mesh_TriFace2);
scene2.add(mesh_TriFace3);
scene2.add(mesh_TriFace4);
scene2.add(mesh_TriFace_step_f2);
scene2.add(mesh_TriFace_step_f1);
scene2.add(mesh_TriFace_step_f21);
scene2.add(mesh_TriFace_step_f3);
scene2.add(mesh_TriFace_step_f4);
scene2.add(mesh_TriFace2_stepar);

 // mesh_TriFace_step_f1.children[0].material.visible=false;
 // mesh_TriFace_step_f1.children[6].material.visible=false;
 //
    mesh_TriFace_step_f2.children[0].material.visible=false;
    mesh_TriFace_step_f2.children[6].material.visible=false;
    mesh_TriFace2_stepar.children[0].material.visible=false;
    mesh_TriFace2_stepar.children[6].material.visible=false;
 //
 // mesh_TriFace_step_f21.children[0].material.visible=false;
 // mesh_TriFace_step_f21.children[6].material.visible=false;
 //
 // mesh_TriFace_step_f3.children[0].material.visible=false;
 // mesh_TriFace_step_f3.children[6].material.visible=false;
 //
 // mesh_TriFace_step_f4.children[0].material.visible=false;
 // mesh_TriFace_step_f4.children[6].material.visible=false;



 for(i=1;i<=6;i++){
   mesh_TriFace_step_f1.children[i].visible=false;
   mesh_TriFace_step_f2.children[i].visible=false;
   mesh_TriFace_step_f21.children[i].visible=false;
   mesh_TriFace_step_f3.children[i].visible=false;
   mesh_TriFace_step_f4.children[i].visible=false;
   mesh_TriFace2_stepar.children[i].visible=false;

 }


if(!controls_scale.Arrow_face)
{
  mesh_TriFace1.children[0].material.visible=false;
  mesh_TriFace2.children[0].material.visible=false;
  mesh_TriFace3.children[0].material.visible=false;
  mesh_TriFace4.children[0].material.visible=false;

  for(i=1;i<=3;i++){
    mesh_TriFace1.children[i].visible=false;
    mesh_TriFace2.children[i].visible=false;
    mesh_TriFace3.children[i].visible=false;
    mesh_TriFace4.children[i].visible=false;
  }
}





var TXMeshf1=createSpriteText3("f1",TubePoints1[1]);
var TXMeshf2=createSpriteText3("f2",TubePoints2[1]);
var TXMeshf3=createSpriteText3("f3",TubePoints3[1]);
var TXMeshf4=createSpriteText3("f4",TubePoints4[1]);

//      var TXMeshf5=createSpriteText4("0",TubePoints1[0]);
//      var TXMeshf6=createSpriteText4("1",TubePoints1[1]);
//      var TXMeshf7=createSpriteText4("2",TubePoints2[1]);
//      var TXMeshf8=createSpriteText4("3",TubePoints3[1]);
//      var TXMeshf9=createSpriteText4("4",TubePoints4[1]);

text_group1.add(TXMeshf1);
text_group1.add(TXMeshf2);
text_group1.add(TXMeshf3);
text_group1.add(TXMeshf4);

//      text_group1.add(TXMeshf5);
//      text_group1.add(TXMeshf6);
//      text_group1.add(TXMeshf7);
//      text_group1.add(TXMeshf8);
//      text_group1.add(TXMeshf9);


// createTextMesh('f2',TubePoints2[1]);
// createTextMesh('f3',TubePoints3[1]);
// createTextMesh('f4',TubePoints4[1]);

//scene.add(TXMeshf1);







var TXMeshA=createSpriteText1("A",P_A_Right);
var TXMeshB=createSpriteText1("B",P_B_Right);
var TXMeshC=createSpriteText1("C",P_C_Right);
var TXMeshD=createSpriteText1("D",P_D_Right);

text_group2.add(TXMeshA);
text_group2.add(TXMeshB);
text_group2.add(TXMeshC);
text_group2.add(TXMeshD);

var TXMeshA_2=createSpriteText1("A",P_A);
var TXMeshB_2=createSpriteText1("B",P_B);
var TXMeshC_2=createSpriteText1("C",P_C);


//    scene2.add(TXMeshA_2);
//    scene2.add(TXMeshB_2);
//    scene2.add(TXMeshC_2);


for(i=0;i<=14;i++){
  // text_group2.children[3].material.visible=false;
  //text_group2.children[4].material.visible=false;
  text_group2.children[5].material.visible=false;
  text_group2.children[6].material.visible=false;
  text_group2.children[7].material.visible=false;
  //text_group2.children[8].material.visible=false;
  text_group2.children[9].material.visible=false;
  text_group2.children[10].material.visible=false;
  text_group2.children[11].material.visible=false;
  text_group2.children[12].material.visible=false;
  text_group2.children[13].material.visible=false;

}



// createTextMesh1('A',P_A_Right);
// createTextMesh1('B',P_B_Right);
// createTextMesh1('C',P_C_Right);
// createTextMesh1('D',P_D_Right);





scene.add(text_group1);

  scene2.add(text_group2);








// console.log("P_A=",P_A,"P_B=",P_B,"P_C=",P_C,"P_D=",P_D);








}


function redraw_pair_base()
{
  // scene.remove(textf1);
  // scene.remove(textf2);

  scene2.remove(Tube_group_pair);

  Tube_group_pair=new THREE.Group();



  
  var arr_direction=arrow_direction(TubePoints1[1],TubePoints2[1],TubePoints3[1],TubePoints4[1]);

  var arrow_material_p=new THREE.MeshPhongMaterial( {
    color: 0x000080
  } );

  // console.log("n1=",TubePoints1[1],"n2=",TubePoints2[1],"n3=",TubePoints3[1],"n4=",TubePoints4[1]);

  var arrow_material2=new THREE.MeshPhongMaterial({
    color: 0xC00000
  } );





  var material = new THREE.MeshPhongMaterial({color: 0x5a5a5a, transparent: true, opacity:0.2});

  var spGeom0 = new THREE.SphereGeometry(0.04);
  var sp_Tube0 = new THREE.Mesh(spGeom0, material);

  // sp_Tube0.name="sp0";
  sp_Tube0.position.copy(new THREE.Vector3(0,0,0));
  sp_Tube0.castShadow=true;

  //Ctrl_tubes.push(sp_Tube0);


  //scene.add(text0);
  //text0.position.copy(new THREE.vertices(0.2,0,0));
  //text_group1.add(text0);


  Tube_group_pair.add(sp_Tube0);
  // add the points as a group to the scene
  //scene.add(spMesh);



  //tube sphere1scene.remove(tubeMesh1);

  // var material = new THREE.MeshBasicMaterial({color: 0xff0000, transparent: false});
  var material2 = new THREE.MeshPhongMaterial({color: 0x5a5a5a, transparent: false});

  var spGeom1 = new THREE.SphereGeometry(0.04);
  var sp_tube1 = new THREE.Mesh(spGeom1, material2);
  sp_tube1.position.copy(TubePoints1[1]);

  sp_tube1.castShadow=true;

  // sp_tube1.name="sp1";//name sphere

  // add the points as a group to the scene
  //     Tube_group_pair.add(sp_tube1);

  // Ctrl_tubes.push(sp_tube1);

  var lattice_pair_material1 = new THREE.MeshPhongMaterial( {
    color: 0xdcdcdc,transparent: true, opacity:0.2
  } );



  var tubeMesh1=createCylinderMesh(TubePoints1[0],TubePoints1[1],lattice_pair_material1,0.02,0.02);
  tubeMesh1.castShadow=true;
  //tubeMesh1.name="tb1";
  //Ctrl_tubes.push(tubeMesh1);

  Tube_group_pair.add(tubeMesh1);

  var arrow_material1=new THREE.MeshPhongMaterial( {
    color: 0x009600
  } );


  //force arrow

  if(TubePoints1[1].z>=0)//p or t

  var tube_arrow1=createCylinderArrowMesh(new THREE.Vector3(1.5*TubePoints1[1].x,1.5*TubePoints1[1].y,1.5*TubePoints1[1].z),TubePoints1[1],arrow_material1,0.02,0.05,0.7);
  else
  var tube_arrow1=createCylinderArrowMesh(TubePoints1[1],new THREE.Vector3(1.5*TubePoints1[1].x,1.5*TubePoints1[1].y,1.5*TubePoints1[1].z),arrow_material1,0.02,0.05,0.7);

  //        Tube_group_pair.add(tube_arrow1);


  //tube sphere2

  var material3 = new THREE.MeshPhongMaterial({color: 0x5a5a5a, transparent: false});

  var spGeom2 = new THREE.SphereGeometry(0.04);
  var sp_tube2 = new THREE.Mesh(spGeom2, material3);
  sp_tube2.position.copy(TubePoints2[1]);
  // add the points as a group to the scene
  // sp_tube2.name="sp2";//name sphere
  // Ctrl_pts.push(sp_tube2);
  //         Tube_group_pair.add(sp_tube2);
  sp_tube2.castShadow=true;

  var lattice_pair_material2 = new THREE.MeshPhongMaterial( {
    color: 0xdcdcdc,transparent: true, opacity:0.2
  } );

  var tubeMesh2=createCylinderMesh(TubePoints2[0],TubePoints2[1],lattice_pair_material2,0.02,0.02);
  tubeMesh2.castShadow=true;
  //tubeMesh2.name="tb2";
  // Ctrl_tubes.push(tubeMesh2);

  Tube_group_pair.add(tubeMesh2);

  //force arrow

  if(arr_direction[0]>=0)//p or t

  var tube_arrow2=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z) ,TubePoints2[1],arrow_material_p,0.02,0.05,0.6);

  else
  var tube_arrow2=createCylinderArrowMesh(TubePoints2[1],new THREE.Vector3(1.22*TubePoints2[1].x,1.22*TubePoints2[1].y,1.22*TubePoints2[1].z),arrow_material2,0.02,0.05,0.6);

  //      Tube_group_pair.add(tube_arrow2);

  //tube sphere3

  var material4 = new THREE.MeshPhongMaterial({color: 0x5a5a5a, transparent: false});

  var spGeom3 = new THREE.SphereGeometry(0.04);
  var sp_tube3 = new THREE.Mesh(spGeom3, material4);
  sp_tube3.position.copy(TubePoints3[1]);
  //sp_tube3.name="sp3";//name sphere
  // add the points as a group to the scene
  // Ctrl_pts.push(sp_tube3);
  //           Tube_group_pair.add(sp_tube3);
  sp_tube3.castShadow=true;

  var lattice_pair_material3 = new THREE.MeshPhongMaterial( {
    color: 0xdcdcdc,transparent: true, opacity:0.2
  } );

  var tubeMesh3=createCylinderMesh(TubePoints3[0],TubePoints3[1],lattice_pair_material3,0.02,0.02);

  tubeMesh3.castShadow=true;
  // tubeMesh3.name="tb3";
  // Ctrl_tubes.push(tubeMesh3);

  Tube_group_pair.add(tubeMesh3);

  //force arrow

  if(arr_direction[1]>=0)

  var tube_arrow3=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z) ,TubePoints3[1],arrow_material_p,0.02,0.05,0.6);
  else
  var tube_arrow3=createCylinderArrowMesh(TubePoints3[1],new THREE.Vector3(1.22*TubePoints3[1].x,1.22*TubePoints3[1].y,1.22*TubePoints3[1].z),arrow_material2,0.02,0.05,0.6);

  //          Tube_group_pair.add(tube_arrow3);

  //tube sphere4
  var material5 = new THREE.MeshPhongMaterial({color: 0x5a5a5a, transparent: false});

  var spGeom4 = new THREE.SphereGeometry(0.04);
  var sp_tube4= new THREE.Mesh(spGeom4, material5);
  sp_tube4.position.copy(TubePoints4[1]);
  sp_tube4.castShadow=true;

  // sp_tube4.name="sp4";//name sphere
  // Ctrl_pts.push(sp_tube4);
  // add the points as a group to the scene
  //           Tube_group_pair.add(sp_tube4);

  var lattice_pair_material4 = new THREE.MeshPhongMaterial( {
    color: 0xdcdcdc,transparent: true, opacity:0.2
  } );

  var tubeMesh4=createCylinderMesh(TubePoints4[0],TubePoints4[1],lattice_pair_material4,0.02,0.02);

  tubeMesh4.castShadow=true;
  //tubeMesh4.name="tb4";
  //Ctrl_tubes.push(tubeMesh4);

  Tube_group_pair.add(tubeMesh4);

  //force arrow

  if(arr_direction[2]>=0)
  var tube_arrow4=createCylinderArrowMesh(new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z) ,TubePoints4[1],arrow_material_p,0.02,0.05,0.6);
  else
  var tube_arrow4=createCylinderArrowMesh(TubePoints4[1],new THREE.Vector3(1.22*TubePoints4[1].x,1.22*TubePoints4[1].y,1.22*TubePoints4[1].z),arrow_material2,0.02,0.05,0.6);

  //        Tube_group_pair.add(tube_arrow4);

  scene2.add(Tube_group_pair);
}


var mesh_F1;
var mesh_F2;
var mesh_F3;
var mesh_F4;

var mesh_F1_pair;
var mesh_F2_pair;
var mesh_F3_pair;
var mesh_F4_pair;



function redraw_Force(){




  scene.remove(mesh_F1);
  scene.remove(mesh_F2);
  scene.remove(mesh_F3);
  scene.remove(mesh_F4);


  //arrow
  if(controls_scale.scale<controls_scale.MaxScale)
  L=controls_scale.scale;
  else
  L=controls_scale.MaxScale;  //scale

  Cal_ForcesPnt();//point

  Force_move_left();

  P_A_Left=Pnt_copy(P_A);
  P_B_Left=Pnt_copy(P_B);
  P_C_Left=Pnt_copy(P_C);
  P_D_Left=Pnt_copy(P_D);



  var vertices = [
    P_A_Left,P_B_Left,P_C_Left,P_D_Left
  ];

  //console.log("TubePoints1="+P_A.z);

  // for (i = 0;i<geom.faces.length;i++){
  //         var hex = Math.random() * 0xffffff;
  //         geom.faces[i].color.setHex(hex);
  //     }

  mesh_left.children.forEach(function (e) {
    e.geometry.vertices = vertices;
    e.geometry.verticesNeedUpdate = true;

    // e.geometry.faces[0].color.set(0xff00ee);
    // e.geometry.facesNeedUpdate=true;
    e.geometry.elementsNeedUpdate = true;
    e.geometry.computeFaceNormals();
    //e.geometry.center();
  });








  // scene.add(mesh_F1);

  L=controls_scale.MaxScale;   //scale

  Cal_ForcesPnt();//point

  Force_move_left();

  var P_A_Scale=Pnt_copy(P_A);
  var P_B_Scale=Pnt_copy(P_B);
  var P_C_Scale=Pnt_copy(P_C);
  var P_D_Scale=Pnt_copy(P_D);

  var coreN1=face_center(P_A_Scale,P_B_Scale,P_C_Scale);
  var coreN2=face_center(P_A_Scale,P_B_Scale,P_D_Scale);
  var coreN3=face_center(P_B_Scale,P_C_Scale,P_D_Scale);
  var coreN4=face_center(P_A_Scale,P_C_Scale,P_D_Scale);

  mesh_F1=create_TriangleMesh_Apply(P_A_Left,P_B_Left,P_C_Left,TubePoints1[1],coreN1);
  mesh_F4=create_TriangleMesh(P_A_Left,P_C_Left,P_D_Left,TubePoints2[1],coreN4);




  if(Change_N3N4)
  {
    mesh_F2=create_TriangleMesh(P_A_Left,P_B_Left,P_D_Left,TubePoints3[1],coreN2);

    mesh_F3=create_TriangleMesh(P_B_Left,P_C_Left,P_D_Left,TubePoints4[1],coreN3);

  }
  else
  {
    mesh_F2=create_TriangleMesh(P_A_Left,P_B_Left,P_D_Left,TubePoints4[1],coreN2);

    mesh_F3=create_TriangleMesh(P_B_Left,P_C_Left,P_D_Left,TubePoints3[1],coreN3);

  }



  scene.add(mesh_F1);
  scene.add(mesh_F2);
  scene.add(mesh_F3);
  scene.add(mesh_F4);





  if(controls_scale.Pair_Control)
  {





    scene2.remove(mesh_F1_pair);
    scene2.remove(mesh_F2_pair);
    scene2.remove(mesh_F3_pair);
    scene2.remove(mesh_F4_pair);

    if(controls_scale.scale<controls_scale.MaxScale)
    L=controls_scale.MaxScale-controls_scale.scale;
    else
    L=0;




    Cal_ForcesPnt();//point

    Force_move_left();

    P_A_Left_Pair=Pnt_copy(P_A);
    P_B_Left_Pair=Pnt_copy(P_B);
    P_C_Left_Pair=Pnt_copy(P_C);
    P_D_Left_Pair=Pnt_copy(P_D);



    var vertices_pair = [
      P_A_Left_Pair,P_B_Left_Pair,P_C_Left_Pair,P_D_Left_Pair
    ];



    mesh_left_pair.children.forEach(function (e) {
      e.geometry.vertices = vertices_pair;
      e.geometry.verticesNeedUpdate = true;

      // e.geometry.faces[0].color.set(0xff00ee);
      // e.geometry.facesNeedUpdate=true;
      e.geometry.elementsNeedUpdate = true;
      e.geometry.computeFaceNormals();
      //e.geometry.center();
    });









    L=controls_scale.MaxScale;   //scale

    Cal_ForcesPnt();//point

    Force_move_left();

    var P_A_Scale_pair=Pnt_copy(P_A);
    var P_B_Scale_pair=Pnt_copy(P_B);
    var P_C_Scale_pair=Pnt_copy(P_C);
    var P_D_Scale_pair=Pnt_copy(P_D);

    var coreN1_pair=face_center(P_A_Scale_pair,P_B_Scale_pair,P_C_Scale_pair);
    var coreN2_pair=face_center(P_A_Scale_pair,P_B_Scale_pair,P_D_Scale_pair);
    var coreN3_pair=face_center(P_B_Scale_pair,P_C_Scale_pair,P_D_Scale_pair);
    var coreN4_pair=face_center(P_A_Scale_pair,P_C_Scale_pair,P_D_Scale_pair);

    mesh_F1_pair=create_TriangleMesh_Apply(P_A_Left_Pair,P_B_Left_Pair,P_C_Left_Pair,TubePoints1[1],coreN1_pair);
    mesh_F4_pair=create_TriangleMesh(P_A_Left_Pair,P_C_Left_Pair,P_D_Left_Pair,TubePoints2[1],coreN4_pair);




    if(Change_N3N4)
    {
      mesh_F2_pair=create_TriangleMesh(P_A_Left_Pair,P_B_Left_Pair,P_D_Left_Pair,TubePoints3[1],coreN2_pair);

      mesh_F3_pair=create_TriangleMesh(P_B_Left_Pair,P_C_Left_Pair,P_D_Left_Pair,TubePoints4[1],coreN3_pair);

    }
    else
    {
      mesh_F2_pair=create_TriangleMesh(P_A_Left_Pair,P_B_Left_Pair,P_D_Left_Pair,TubePoints4[1],coreN2_pair);

      mesh_F3_pair=create_TriangleMesh(P_B_Left_Pair,P_C_Left_Pair,P_D_Left_Pair,TubePoints3[1],coreN3_pair);

    }



    scene2.add(mesh_F1_pair);
    scene2.add(mesh_F2_pair);
    scene2.add(mesh_F3_pair);
    scene2.add(mesh_F4_pair);

  }





















}





var Force_face_dir=[];
var Change_BC=false;

function Cal_ForcesPnt(){
  

  var origin_N1=Pnt_copy(TubePoints1[1]);
  var origin_N2=Pnt_copy(TubePoints2[1]);
  var origin_N3=Pnt_copy(TubePoints3[1]);
  var origin_N4=Pnt_copy(TubePoints4[1]);

  origin_N1.multiplyScalar(-1);
  origin_N2.multiplyScalar(-1);
  origin_N3.multiplyScalar(-1);
  origin_N4.multiplyScalar(-1);

  var aa=new Array();
  aa=Cal_Arrange_AA(origin_N1,origin_N2,origin_N3,origin_N4);

  console.log("aa0",aa[0],"aa1",aa[1],"aa2",aa[2]);

  origin_N1.normalize();

  var L_AB=new THREE.Vector3(0,0,0);
  L_AB=cross(origin_N1,aa[0]);

  P_A=new THREE.Vector3(0,0,0);
  //m=Math.sqrt()
  var m=Math.sqrt(L*L/Math.pow(norm(L_AB),2));

  P_B=new THREE.Vector3((P_A.x+m*L_AB.x),(P_A.y+m*L_AB.y),(P_A.z+m*L_AB.z));

  var L_BC=new THREE.Vector3(0,0,0);
  var L_CA=new THREE.Vector3(0,0,0);

  L_BC=cross(origin_N1,aa[1]);
  L_CA=cross(origin_N1,aa[2]);


  P_C=new THREE.Vector3(0,0,0);
  P_C=LinesSectPt(L_BC,P_B,L_CA,P_A);


  var L_BD=new THREE.Vector3(0,0,0);
  var L_DC=new THREE.Vector3(0,0,0);

  L_BD=cross(aa[1],aa[0]);
  L_DC=cross(aa[1],aa[2]);

  P_D=new THREE.Vector3(0,0,0);

  P_D=LinesSectPt(L_BD,P_B,L_DC,P_C);

  console.log("P_ABCD",P_A,P_B,P_C,P_D);



  //




  Change_BC=false;

  var F1=cross(P_B,P_C);

  if(F1.z>0)
  {
    var temp=Pnt_copy(P_B);
    P_B=Pnt_copy(P_C);
    P_C=Pnt_copy(temp);
    Change_BC=true;
  }


  var P_BA = new THREE.Vector3().subVectors(P_B, P_A);
  var P_CB=new THREE.Vector3().subVectors(P_C, P_B);

  var P_CA=new THREE.Vector3().subVectors(P_C, P_A);
  var P_DC=new THREE.Vector3().subVectors(P_D, P_C);

  var P_DA=new THREE.Vector3().subVectors(P_D, P_A);
  var P_BD=new THREE.Vector3().subVectors(P_B, P_D);

  var P_DB=new THREE.Vector3().subVectors(P_D, P_B);
  var P_CD=new THREE.Vector3().subVectors(P_C, P_D);

  F1=cross(P_BA,P_CB);
  var F2=cross(P_CA,P_DC);
  var F3=cross(P_DA,P_BD);
  var F4=cross(P_DB,P_CD);

  Force_face_dir=[];

  Force_face_dir.push(F1);
  Force_face_dir.push(F2);
  Force_face_dir.push(F3);
  Force_face_dir.push(F4);






}


function Force_move(){   
 
  var P_A_temp=new THREE.Vector3(0,0,0);

  P_A_temp=Pnt_copy(P_A);

  P_A=subVec(P_A,P_A_temp);
  P_B=subVec(P_B,P_A_temp);
  P_C=subVec(P_C,P_A_temp);
  P_D=subVec(P_D,P_A_temp);



  var corePoint=new THREE.Vector3();
  corePoint.x=(P_A.x+P_B.x+P_C.x+P_D.x)/4;
  corePoint.y=(P_A.y+P_B.y+P_C.y+P_D.y)/4;
  corePoint.z=(P_A.z+P_B.z+P_C.z+P_D.z)/4;


  if(corePoint_temp.x===0&&corePoint_temp.y===0&&corePoint_temp.z===0)
  {
    corePoint_temp=Pnt_copy(corePoint);
  };



  P_A=subVec(P_A,corePoint_temp);
  P_B=subVec(P_B,corePoint_temp);
  P_C=subVec(P_C,corePoint_temp);
  P_D=subVec(P_D,corePoint_temp);

}



function Force_move_left()
{

  var P_A_temp=new THREE.Vector3(0,0,0);

  P_A_temp=Pnt_copy(P_A);

  P_A=subVec(P_A,P_A_temp);
  P_B=subVec(P_B,P_A_temp);
  P_C=subVec(P_C,P_A_temp);
  P_D=subVec(P_D,P_A_temp);

  var corePoint=new THREE.Vector3();
  corePoint.x=(P_A.x+P_B.x+P_C.x+P_D.x)/4;
  corePoint.y=(P_A.y+P_B.y+P_C.y+P_D.y)/4;
  corePoint.z=(P_A.z+P_B.z+P_C.z+P_D.z)/4;



  P_A=subVec(P_A,corePoint);
  P_B=subVec(P_B,corePoint);
  P_C=subVec(P_C,corePoint);
  P_D=subVec(P_D,corePoint);

}













function subVec(n1,n2){
  var sub=new THREE.Vector3(0,0,0);
  sub.x=n1.x-n2.x;
  sub.y=n1.y-n2.y;
  sub.z=n1.z-n2.z;
  return sub;
}


function cross(n1,n2){
  var ncross=new THREE.Vector3(0,0,0);
  ncross.x=((n1.y*n2.z)-(n1.z*n2.y));
  ncross.y=((n1.z*n2.x)-(n1.x*n2.z));
  ncross.z=((n1.x*n2.y)-(n1.y*n2.x));
  return ncross;

}

function norm(n1){
  var nnorm=Math.sqrt(n1.x*n1.x+n1.y*n1.y+n1.z*n1.z);
  return nnorm;
}

function distance(n1,n2){
  var distance1=Math.sqrt((n1.x-n2.x)*(n1.x-n2.x)+(n1.y-n2.y)*(n1.y-n2.y)+(n1.z-n2.z)*(n1.z-n2.z));
  return distance1;
}

function face_center(n1,n2,n3){

  var face_centerD=new THREE.Vector3();

  face_centerD.x=(n1.x+n2.x+n3.x)/3;
  face_centerD.y=(n1.y+n2.y+n3.y)/3;
  face_centerD.z=(n1.z+n2.z+n3.z)/3;

  return face_centerD;



}






function Pnt_copy(n1){

  var n2=new THREE.Vector3(0,0,0);
  n2.x=n1.x;
  n2.y=n1.y;
  n2.z=n1.z;
  return n2;
}

function arrow_direction(n1,n2,n3,n4){

  var matr3=new THREE.Matrix3();
  matr3.elements=[n2.x,n2.y,n2.z,n3.x,n3.y,n3.z,n4.x,n4.y,n4.z];

  var matr3_Inver=new THREE.Matrix3();

  matr3_Inver.getInverse(matr3);

  var arr_direct=new Array();

  var Ma3=matr3_Inver.elements;

  var a1=Ma3[0]*(-1)*n1.x+Ma3[3]*(-1)*n1.y+Ma3[6]*(-1)*n1.z;
  //var a1=Ma3[0]*(-1)*n1.x+Ma3[3]*(-1)*n1.y+Ma3[6]*(-1)*n1.z;
  arr_direct.push(a1);

  var a2=Ma3[1]*(-1)*n1.x+Ma3[4]*(-1)*n1.y+Ma3[7]*(-1)*n1.z;
  arr_direct.push(a2);

  var a3=Ma3[2]*(-1)*n1.x+Ma3[5]*(-1)*n1.y+Ma3[8]*(-1)*n1.z;
  arr_direct.push(a3);

  return arr_direct;





}

function Cal_Arrange_AA(n1,n2,n3,n4){

  var n11=Pnt_copy(n1);
  var n22=Pnt_copy(n2);
  var n33=Pnt_copy(n3);
  var n44=Pnt_copy(n4);

  n11.normalize();
  n22.normalize();
  n33.normalize();
  n44.normalize();

  Change_N3N4=false;



  var CO=arrow_direction(n11,n22,n33,n44);

  console.log("CO0",CO[0],"CO1",CO[1],"CO2",CO[2]);


  var AngV=Math.atan2(n22.y,n22.x);





  if(CO[0]<0)
  {
    n22.x=-n22.x;
    n22.y=-n22.y;
    n22.z=-n22.z;
  }
  if(CO[1]<0)
  {
    n33.x=-n33.x;
    n33.y=-n33.y;
    n33.z=-n33.z;
  }
  if(CO[2]<0)
  {
    n44.x=-n44.x;
    n44.y=-n44.y;
    n44.z=-n44.z;
  }



  var n22_ang=Rotate_Vec(n22,new THREE.Vector3(0,0,1),-AngV);//反向旋转
  var n33_ang=Rotate_Vec(n33,new THREE.Vector3(0,0,1),-AngV);
  var n44_ang=Rotate_Vec(n44,new THREE.Vector3(0,0,1),-AngV);





  //var AngN33=Math.atan2(n33_ang.y,n33_ang.x);


  var AngN3=Math.atan2(n33_ang.y,n33_ang.x);
  if(AngN3<0)
  AngN3=AngN3+2.0*Math.PI;
  var AngN4=Math.atan2(n44_ang.y,n44_ang.x);
  if(AngN4<0)
  AngN4=AngN4+2.0*Math.PI;


  //console.log("AngV",AngV,"AngN3",AngN3,"AngN4",AngN4);

  var AA=new Array();
  AA.push(n22);

  if(AngN3<AngN4)
  {
    AA.push(n33);
    AA.push(n44);
  }
  else
  {
    AA.push(n44);
    AA.push(n33);
    Change_N3N4=true;
  }

  return AA;
}









function Rotate_Vec(p1,R_V,Theta){
  //  function [P2] = Rotate_Vec(P1, R_V, theta)

  var vector = new THREE.Vector3(0,0,0);
  var axis=new THREE.Vector3(0,0,0);

  vector=Pnt_copy(p1);
  axis=Pnt_copy(R_V);

  vector.applyAxisAngle(axis,Theta);
  return vector;
}

function roundedCornerLine(points, radius, smoothness, closed) {

  radius = radius !== undefined ? radius : .1;
  smoothness = smoothness !== undefined ? Math.floor(smoothness) : 3;
  closed = closed !== undefined ? closed : false;

  let newGeometry = new THREE.BufferGeometry();

  if (points === undefined) {
    console.log("RoundedCornerLine: 'points' is undefined");
    return newGeometry;
  }
  if (points.length < 3) {
    console.log("RoundedCornerLine: 'points' has insufficient length (should be equal or greater than 3)");
    return newGeometry.setFromPoints(points);
  }

  // minimal segment
  let minVector = new THREE.Vector3();
  let minLength = minVector.subVectors(points[0], points[1]).length();
  for (let i = 1; i < points.length - 1; i++) {
    minLength = Math.min(minLength, minVector.subVectors(points[i], points[i + 1]).length());
  }
  if (closed) {
    minLength = Math.min(minLength, minVector.subVectors(points[points.length - 1], points[0]).length());
  }

  radius = radius > minLength * .5 ? minLength * .5 : radius; // radius can't be greater than a half of a minimal segment

  let startIndex = 1;
  let endIndex = points.length - 2;
  if (closed) {
    startIndex = 0;
    endIndex = points.length - 1;
  }

  let positions = [];
  if (!closed) {
    positions.push(points[0].clone())
  };

  for (let i = startIndex; i <= endIndex; i++) {

    let iStart = i - 1 < 0 ? points.length - 1 : i - 1;
    let iMid = i;
    let iEnd = i + 1 > points.length - 1 ? 0 : i + 1;
    let pStart = points[iStart];
    let pMid = points[iMid];
    let pEnd = points[iEnd];

    // key points
    let vStartMid = new THREE.Vector3().subVectors(pStart, pMid).normalize();
    let vEndMid = new THREE.Vector3().subVectors(pEnd, pMid).normalize();
    let vCenter = new THREE.Vector3().subVectors(vEndMid, vStartMid).divideScalar(2).add(vStartMid).normalize();
    let angle = vStartMid.angleTo(vEndMid);
    let halfAngle = angle * .5;

    let sideLength = radius / Math.tan(halfAngle);
    let centerLength = Math.sqrt(sideLength * sideLength + radius * radius);

    let startKeyPoint = vStartMid.multiplyScalar(sideLength);
    let centerKeyPoint = vCenter.multiplyScalar(centerLength);
    let endKeyPoint = vEndMid.multiplyScalar(sideLength);

    let cb = new THREE.Vector3(),
    ab = new THREE.Vector3(),
    normal = new THREE.Vector3();
    cb.subVectors(centerKeyPoint, endKeyPoint);
    ab.subVectors(startKeyPoint, endKeyPoint);
    cb.cross(ab);
    normal.copy(cb).normalize();

    let rotatingPointStart = new THREE.Vector3().subVectors(startKeyPoint, centerKeyPoint);
    let rotatingPointEnd = new THREE.Vector3().subVectors(endKeyPoint, centerKeyPoint);
    let rotatingAngle = rotatingPointStart.angleTo(rotatingPointEnd);
    let angleDelta = rotatingAngle / smoothness;
    let tempPoint = new THREE.Vector3();
    for (let a = 0; a < smoothness + 1; a++) {
      tempPoint.copy(rotatingPointStart).applyAxisAngle(normal, angleDelta * a).add(pMid).add(centerKeyPoint);
      positions.push(tempPoint.clone());
    }

  }

  if (!closed) {
    positions.push(points[points.length - 1].clone());
  } else {
    positions.push(positions[0].clone());
  }

  return newGeometry.setFromPoints(positions);

}

function getCurveGeometry(points, smoothness, weight) {
  var nurbsControlPoints = [];
  var nurbsKnots = [];
  var nurbsDegree = 2;
  for (let i = 0; i <= nurbsDegree; i++) {
    nurbsKnots.push(0);
  }
  for (let i = 0, j = points.length; i < j; i++) {
    nurbsControlPoints.push(
      new THREE.Vector4(
        points[i].x,
        points[i].y,
        points[i].z,
        i === 1 ? weight : 1
      )
    );
    let knot = (i + 1) / (j - nurbsDegree);
    nurbsKnots.push(THREE.Math.clamp(knot, 0, 1));
  }
  let nurbsCurve = new THREE.NURBSCurve(nurbsDegree, nurbsKnots, nurbsControlPoints);
  return new THREE.BufferGeometry().setFromPoints(nurbsCurve.getPoints(smoothness));
}



function LinesSectPt(L1_dir,P1_pnt,L2_dir,P2_pnt){

  var L1_dir1=new THREE.Vector3(0,0,0);
  var L2_dir2=new THREE.Vector3(0,0,0);

  L1_dir1=Pnt_copy(L1_dir);
  L2_dir2=Pnt_copy(L2_dir);



  L1_dir1.x=L1_dir.x/norm(L1_dir);
  L1_dir1.y=L1_dir.y/norm(L1_dir);
  L1_dir1.z=L1_dir.z/norm(L1_dir);

  L2_dir2.x=L2_dir.x/norm(L2_dir);
  L2_dir2.y=L2_dir.y/norm(L2_dir);
  L2_dir2.z=L2_dir.z/norm(L2_dir);


  var P1P2_Vec=new THREE.Vector3(0,0,0);
  P1P2_Vec.x=P2_pnt.x-P1_pnt.x;
  P1P2_Vec.y=P2_pnt.y-P1_pnt.y;
  P1P2_Vec.z=P2_pnt.z-P1_pnt.z;

 
  var P2P3_Norm=norm(cross(P1P2_Vec,L1_dir1));



  var P3_pnt=new THREE.Vector3(0,0,0);

  P3_pnt.x=P1_pnt.x+((P1P2_Vec.x*L1_dir1.x+P1P2_Vec.y*L1_dir1.y+P1P2_Vec.z*L1_dir1.z))*L1_dir1.x;
  P3_pnt.y=P1_pnt.y+((P1P2_Vec.x*L1_dir1.x+P1P2_Vec.y*L1_dir1.y+P1P2_Vec.z*L1_dir1.z))*L1_dir1.y;
  P3_pnt.z=P1_pnt.z+((P1P2_Vec.x*L1_dir1.x+P1P2_Vec.y*L1_dir1.y+P1P2_Vec.z*L1_dir1.z))*L1_dir1.z;

  var CosTheta=Math.abs(L1_dir1.x*L2_dir2.x+L1_dir1.y*L2_dir2.y+L1_dir1.z*L2_dir2.z);


  var k_pnt=new THREE.Vector3(0,0,0);

  if(CosTheta<0)
  {
    k_pnt=Pnt_copy(P3_pnt);

  }

  if(CosTheta>0)
  {
    var Tantheta=Math.sqrt((1-Math.pow(CosTheta,2)))/CosTheta;
    var KP3_Norm=P2P3_Norm/Tantheta;

    var K1_pnt=new THREE.Vector3((P3_pnt.x+KP3_Norm*L1_dir1.x),(P3_pnt.y+KP3_Norm*L1_dir1.y),(P3_pnt.z+KP3_Norm*L1_dir1.z));
    var K2_pnt=new THREE.Vector3((P3_pnt.x-KP3_Norm*L1_dir1.x),(P3_pnt.y-KP3_Norm*L1_dir1.y),(P3_pnt.z-KP3_Norm*L1_dir1.z));



    var P2K1_vec=new THREE.Vector3((K1_pnt.x-P2_pnt.x),(K1_pnt.y-P2_pnt.y),(K1_pnt.z-P2_pnt.z));
    var P2K2_vec=new THREE.Vector3((K2_pnt.x-P2_pnt.x),(K2_pnt.y-P2_pnt.y),(K2_pnt.z-P2_pnt.z));

    var D1=norm(cross(P2K1_vec,L2_dir2));
    var D2=norm(cross(P2K2_vec,L2_dir2));


    if(D1<D2)
    k_pnt=Pnt_copy(K1_pnt);
    else
    k_pnt=Pnt_copy(K2_pnt);

  }

  return k_pnt;


}








function generatePoints(points) {
  // add n random spheres
  var geometry = new THREE.Geometry();
  geometry.vertices.push(points[0]);
  geometry.vertices.push(points[1]);

  var line = new THREE.Line(geometry, lattice_line_material);


  return line;
}




var stats;

function initStats() {
  stats = new Stats();
  //document.body.appendChild(stats.dom);
}

var gui;




var step = 0;

var INTERSECTED;
var SELECTED;
function render() {

  stats.update();








  var rayCaster2=new THREE.Raycaster();
  rayCaster2.setFromCamera(mouse, camera);
  var intersects = rayCaster2.intersectObjects(Ctrl_tubes);

  // if(intersects.length>0) {

  //     intersects[0].object.material.color.set(0xff00ff);
  //     //console.log("selectobj.name="+intersects[0].object.name);

  // }
  if (intersects.length > 0) {//有相交的object时

    //geom.faces[0].color.set(0xff00ff);
    //mesh.materials[1].color.set(0xff00ff);

    //console.log("selectobj.name="+intersects[0].object.name);
    if (INTERSECTED != intersects[0].object) {

      if (INTERSECTED) //
      {
        INTERSECTED.material.color.setHex(INTERSECTED.currentHex);



        if(INTERSECTED.name.charAt(0)==='s')//
        {
          // mesh.children[1].material.color.set(0x156289);
          mesh.children[1].geometry.faces[0].color.set(0x009600);

          for(i=1;i<=3;i++)
          {
            mesh.children[1].geometry.faces[i].color.set(0x0F3150);
          }

          mesh.children[1].geometry.facesNeedUpdate=true;
          mesh.children[1].geometry.elementsNeedUpdate = true;
          mesh.children[1].geometry.computeFaceNormals();


          //console.log("selectobj2.name113="+INTERSECTED.name);
        }
        else if(INTERSECTED.name.charAt(0)==='t')
        {
          var num2=Number(INTERSECTED.name.charAt(2))-1;
          if(num2>0){
            mesh.children[1].geometry.faces[Number(INTERSECTED.name.charAt(2))-1].color.set(0x0F3150);

          }
          else
          mesh.children[1].geometry.faces[0].color.set(0x009600);

          mesh.children[1].geometry.facesNeedUpdate=true;
          mesh.children[1].geometry.elementsNeedUpdate = true;
          mesh.children[1].geometry.computeFaceNormals();


        }
        else if(INTERSECTED.name.charAt(0)==='f')
        {
          if(INTERSECTED.name.charAt(1)==='p')
          {


          }
          if(INTERSECTED.name.charAt(1)==='t')
          {

          }
        }




      }


      INTERSECTED = intersects[0].object;
      INTERSECTED.currentHex = INTERSECTED.material.color.getHex();
      INTERSECTED.material.color.set(0xFF6347);


      if(INTERSECTED.name.charAt(0)==='s')//
      {
        for(i=0;i<=3;i++)
        {
          mesh.children[1].geometry.faces[i].color.set(0xFF6347);
        }
        mesh.children[1].geometry.facesNeedUpdate=true;
        mesh.children[1].geometry.elementsNeedUpdate = true;
        mesh.children[1].geometry.computeFaceNormals();

        // console.log("selectobj2.name12="+INTERSECTED.name);
        //mesh.children[1].material.color.set(0xFF6347);
      }else if(INTERSECTED.name.charAt(0)==='t')
      {

        //console.log("INTERSECTED.name=",INTERSECTED.name);

        mesh.children[1].geometry.faces[Number(INTERSECTED.name.charAt(2))-1].color.set(0xFF6347);


        //mesh.children[1].geometry.faces[Number(INTERSECTED.name.charAt(2))-1].material.opacity;
        mesh.children[1].geometry.facesNeedUpdate=true;
        mesh.children[1].geometry.elementsNeedUpdate = true;
        mesh.children[1].geometry.computeFaceNormals();


        // console.log("selectobj2.name11="+INTERSECTED.name);


      }
      else if(INTERSECTED.name.charAt(0)==='f')
      {
        if(INTERSECTED.name.charAt(1)==='p')
        {


        }
        if(INTERSECTED.name.charAt(1)==='t')
        {

        }
      }





      //console.log("selectobj2.name="+INTERSECTED.name);
    }


  }
  else
  {
    if (INTERSECTED)
    {
      INTERSECTED.material.color.set(INTERSECTED.currentHex);


      if(INTERSECTED.name.charAt(0)==='s')//
      {

        mesh.children[1].geometry.faces[0].color.set(0x009600);
        for(i=1;i<=3;i++)
        {
          mesh.children[1].geometry.faces[i].color.set(0x0F3150);
        }
        mesh.children[1].geometry.facesNeedUpdate=true;
        mesh.children[1].geometry.elementsNeedUpdate = true;
        mesh.children[1].geometry.computeFaceNormals();

        //mesh.children[1].material.color.set(0x156289);
      }
      else if(INTERSECTED.name.charAt(0)==='t')
      {
        var num3=Number(INTERSECTED.name.charAt(2))-1;
        if(num3>0)
        {
          mesh.children[1].geometry.faces[Number(INTERSECTED.name.charAt(2))-1].color.set(0x0F3150);

        }else
        mesh.children[1].geometry.faces[0].color.set(0x009600);

        mesh.children[1].geometry.facesNeedUpdate=true;

        mesh.children[1].geometry.elementsNeedUpdate = true;
        mesh.children[1].geometry.computeFaceNormals();
      }
      else if(INTERSECTED.name.charAt(0)==='f')
      {
        if(INTERSECTED.name.charAt(1)==='p')
        {


        }
        if(INTERSECTED.name.charAt(1)==='t')
        {

        }
      }

    }
    INTERSECTED = null;
  }




  renderer.clear();
  renderer.setViewport(0,0,window.innerWidth/2,window.innerHeight)
  renderer.render(scene, camera);

  renderer.autoClear = false;
  renderer.setViewport(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight)
  renderer.render(scene2, camera);
}








function animate() {


  stats.update();
  requestAnimationFrame(animate);
  orbit_ctrl.update();
  trfm_ctrl.update();
  render();
  TWEEN.update();
}



function draw() {
  initRender();
  initScene();
  initCamera();
  orbit_ctrl = new THREE.OrbitControls(camera, renderer.domElement);
  //initLight();
  initModel();


  initStats();
  //initGui();

  animate();
  //window.onresize = onWindowResize;
}
</script>
</html>
